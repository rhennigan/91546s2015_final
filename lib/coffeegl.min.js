(function(e,t,n){function r(n,i){if(!t[n]){if(!e[n]){var s=typeof require=="function"&&require;if(!i&&s)return s(n,!0);throw new Error("Cannot find module '"+n+"'")}var o=t[n]={exports:{}};e[n][0](function(t){var i=e[n][1][t];return r(i?i:t)},o,o.exports)}return t[n].exports}for(var i=0;i<n.length;i++)r(n[i]);return r})({1:[function(require,module,exports){(function(){(function(){var CoffeeGL,GL,extend,util,_setupFrame;CoffeeGL={};GL={};util={};util.extend=function(obj,source){var i,il,keys,prop,safeHasOwnProperty;if(Object.keys){keys=Object.keys(source);i=0;il=keys.length;while(i<il){prop=keys[i];Object.defineProperty(obj,prop,Object.getOwnPropertyDescriptor(source,prop));i++}}else{safeHasOwnProperty={}.hasOwnProperty;for(prop in source){if(safeHasOwnProperty.call(source,prop)){obj[prop]=source[prop]}}}return obj};util.removeElement=function(element,list){var index;index=list.indexOf(element);if(index!==-1){list.splice(index,1)}return list};util.clone=function(obj){var flags,key,newInstance;if(obj==null||typeof obj!=="object"){return obj}if(obj instanceof Date){return new Date(obj.getTime())}if(obj instanceof RegExp){flags="";if(obj.global!=null){flags+="g"}if(obj.ignoreCase!=null){flags+="i"}if(obj.multiline!=null){flags+="m"}if(obj.sticky!=null){flags+="y"}return new RegExp(obj.source,flags)}if(obj instanceof Float32Array){return new Float32Array(obj)}if(obj instanceof Uint16Array){return new Uint16Array(obj)}newInstance=new obj.constructor;for(key in obj){newInstance[key]=util.clone(obj[key])}return newInstance};module.exports=util;extend=function(){var pkg;switch(arguments.length){case 1:return util.extend(CoffeeGL,arguments[0]);case 2:pkg=arguments[0];if(CoffeeGL[pkg]==null){CoffeeGL[pkg]={}}return util.extend(CoffeeGL[pkg],arguments[1])}};if(typeof window!=="undefined"&&window!==null){window.CoffeeGL=CoffeeGL}if(typeof window!=="undefined"&&window!==null){window.GL=GL}extend(require("./app"));extend(require("./math"));extend("Colour",require("./colour"));extend(require("./primitives"));extend(require("./node"));extend(require("./model"));extend(require("./shader"));extend(require("./request"));extend(require("./fbo"));extend(require("./texture"));extend("Camera",require("./camera"));extend("Shapes",require("./shapes"));extend(require("./webgl"));extend(require("./util"));extend(require("./signal"));extend("Light",require("./light"));extend("Noise",require("./noise"));extend(require("./material"));extend(require("./error"));extend("Math",require("./math_functions"));extend(require("./animation"));extend(require("./voronoi"));extend(require("./medial_axis"));CoffeeGL.applications=[];_setupFrame=function(root){var onEachFrame,_cb;if(root.webkitRequestAnimationFrame){onEachFrame=function(context,run){var _cb;CoffeeGL.applications.push([context,run]);_cb=function(){var app,_i,_len,_ref;_ref=CoffeeGL.applications;for(_i=0,_len=_ref.length;_i<_len;_i++){app=_ref[_i];CoffeeGL.Context.switchContext(app[0]);app[1].call(app[0])}return webkitRequestAnimationFrame(_cb)};return _cb()}}else if(root.mozRequestAnimationFrame){onEachFrame=function(context,run){return CoffeeGL.applications.push([context,run])};_cb=function(){var app,_i,_len,_ref;_ref=CoffeeGL.applications;for(_i=0,_len=_ref.length;_i<_len;_i++){app=_ref[_i];CoffeeGL.Context.switchContext(app[0]);app[1].call(app[0])}return mozRequestAnimationFrame(_cb)};_cb()}else{onEachFrame=function(context,run){var _go;CoffeeGL.applications.push([context,run]);_go=function(){var app,_i,_len,_ref,_results;_ref=CoffeeGL.applications;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){app=_ref[_i];CoffeeGL.Context.switchContext(app[0]);_results.push(app[1].call(app[0]))}return _results};return setInterval(_go,1e3/60)}}return root.onEachFrame=onEachFrame};if(typeof window!=="undefined"&&window!==null){_setupFrame(window)}module.exports={CoffeeGL:CoffeeGL,GL:GL}}).call(this)})()},{"./app":2,"./math":3,"./colour":4,"./primitives":5,"./node":6,"./model":7,"./shader":8,"./request":9,"./fbo":10,"./texture":11,"./camera":12,"./shapes":13,"./webgl":14,"./util":15,"./signal":16,"./light":17,"./noise":18,"./material":19,"./error":20,"./math_functions":21,"./animation":22,"./voronoi":23,"./medial_axis":24}],4:[function(require,module,exports){(function(){var RGB,RGBA;RGBA=function(){function RGBA(r,g,b,a){this.r=r;this.g=g;this.b=b;this.a=a}RGBA.prototype.flatten=function(){return[this.r,this.g,this.b,this.a]};RGBA.WHITE=function(){return new RGBA(1,1,1,1)};return RGBA}();RGB=function(){function RGB(r,g,b){this.r=r;this.g=g;this.b=b}RGB.prototype.flatten=function(){return[this.r,this.g,this.b]};RGB.WHITE=function(){return new RGB(1,1,1)};return RGB}();module.exports={RGBA:RGBA,RGB:RGB}}).call(this)},{}],15:[function(require,module,exports){(function(){(function(){var util;util={};util.extend=function(obj,source){var i,il,keys,prop,safeHasOwnProperty;if(Object.keys){keys=Object.keys(source);i=0;il=keys.length;while(i<il){prop=keys[i];Object.defineProperty(obj,prop,Object.getOwnPropertyDescriptor(source,prop));i++}}else{safeHasOwnProperty={}.hasOwnProperty;for(prop in source){if(safeHasOwnProperty.call(source,prop)){obj[prop]=source[prop]}}}return obj};util.removeElement=function(element,list){var index;index=list.indexOf(element);if(index!==-1){list.splice(index,1)}return list};util.clone=function(obj){var flags,key,newInstance;if(obj==null||typeof obj!=="object"){return obj}if(obj instanceof Date){return new Date(obj.getTime())}if(obj instanceof RegExp){flags="";if(obj.global!=null){flags+="g"}if(obj.ignoreCase!=null){flags+="i"}if(obj.multiline!=null){flags+="m"}if(obj.sticky!=null){flags+="y"}return new RegExp(obj.source,flags)}if(obj instanceof Float32Array){return new Float32Array(obj)}if(obj instanceof Uint16Array){return new Uint16Array(obj)}newInstance=new obj.constructor;for(key in obj){newInstance[key]=util.clone(obj[key])}return newInstance};module.exports=util}).call(this)})()},{}],20:[function(require,module,exports){(function(){var CoffeeGLDebug,CoffeeGLError,CoffeeGLLog,CoffeeGLWarning,CoffeeGLWarningOnce,cache,_this=this,__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++){if(i in this&&this[i]===item)return i}return-1};cache=[];CoffeeGLError=function(msg,obj){var f;f="CoffeeGL Error : "+msg;if(obj!=null){f+=" in "+obj}console.error(f);throw f};CoffeeGLWarning=function(msg,obj){var f;f="CoffeeGL Warning : "+msg;if(obj!=null){f+=" in "+obj}return console.warn(f)};CoffeeGLWarningOnce=function(msg,obj){var f,result;result=__indexOf.call(cache,msg)>=0;if(!result){f="CoffeeGL Warning : "+msg;if(obj!=null){f+=" in "+obj}console.warn(f);return cache.push(msg)}};CoffeeGLDebug=function(msg,obj){var f;if(CoffeeGL.Context.debug){f="CoffeeGL Debug : "+msg;if(obj!=null){f+=" in "+obj}return console.log(f)}};CoffeeGLLog=function(msg,obj){var f;f="CoffeeGL Log : "+msg;if(obj!=null){f+=" in "+obj}return console.log(f)};module.exports={CoffeeGLError:CoffeeGLError,CoffeeGLWarning:CoffeeGLWarning,CoffeeGLLog:CoffeeGLLog,CoffeeGLWarningOnce:CoffeeGLWarningOnce,CoffeeGLDebug:CoffeeGLDebug}}).call(this)},{}],3:[function(require,module,exports){(function(){var CatmullPatch,CatmullRomSpline,CoffeeGLWarning,CubicHermiteSpline,EPSILON_VALUE,Edge2,HalfEdge2,Matrix2,Matrix3,Matrix4,PI,Parabola,Quaternion,Vec2,Vec3,Vec4,degToRad,glMatrixArrayType,radToDeg,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};CoffeeGLWarning=require("./error").CoffeeGLWarning;if(typeof(typeof Float32Array!=="undefined"&&Float32Array!==null)){glMatrixArrayType=Float32Array}else if(typeof(typeof WebGLFloatArray!=="undefined"&&WebGLFloatArray!==null)){glMatrixArrayType=WebGLFloatArray}else{glMatrixArrayType=Array}EPSILON_VALUE=437114e-10;PI=3.14159;({sinx_over_x:function(x){if(x*x<1.1920929e-7){return 1}else{return Math.sin(x)/x}}});radToDeg=function(a){return a*57.2957795};degToRad=function(a){return a*.017453292523928};Vec2=function(){Vec2.prototype._DIM=2;Vec2.sub=function(a,b){return a.copy()["sub"](b)};Vec2.add=function(a,b){return a.copy()["add"](b)};Vec2.div=function(a,b){return a.copy()["div"](b)};Vec2.mult=function(a,b){return a.copy()["mult"](b)};Vec2.multScalar=function(a,b){return a.copy()["multScalar"](b)};Vec2.normalize=function(a){return a.copy()["normalize"]()};Vec2.dot=function(a,b){return a.dot(b)};function Vec2(x,y){var _ref;if(x==null){x=0}if(y==null){y=0}_ref=[x,y],this.x=_ref[0],this.y=_ref[1]}Vec2.prototype.copy=function(){return new Vec2(this.x,this.y)};Vec2.prototype.copyFrom=function(a){this.x=a.x;this.y=a.y;return this};Vec2.prototype.length=function(){return Math.sqrt(this.lengthSquared())};Vec2.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y};Vec2.prototype.normalize=function(){var m;m=this.length();if(m>0){this.multScalar(1/m)}return this};Vec2.prototype.sub=function(v){this.x-=v.x;this.y-=v.y;return this};Vec2.prototype.add=function(v){this.x+=v.x;this.y+=v.y;return this};Vec2.prototype.dv=function(v){return new Vec2(Math.abs(this.x-v.x)(Math.abs(this.y-v.y)))};Vec2.prototype.dist=function(v){return Vec2.sub(this,v).length()};Vec2.prototype.distSquared=function(v){return Vec2.sub(this,v).lengthSquared()};Vec2.prototype.div=function(n){var _ref;_ref=[this.x/n.x,this.y/n.y],this.x=_ref[0],this.y=_ref[1];return this};Vec2.prototype.mult=function(v){var _ref;_ref=[this.x*v.x,this.y*v.y],this.x=_ref[0],this.y=_ref[1];return this};Vec2.prototype.multScalar=function(n){var _ref;_ref=[this.x*n,this.y*n],this.x=_ref[0],this.y=_ref[1];return this};Vec2.prototype.equals=function(v){return this.x===v.x&&this.y===v.y};Vec2.prototype.dot=function(v){return this.x*v.x+this.y*v.y};Vec2.prototype.invalid=function(){return this.x===Infinity||isNaN(this.x)||this.y===Infinity||isNaN(this.y)};Vec2.prototype.flatten=function(){return[this.x,this.y]};Vec2.prototype.equals=function(a){return a.x===this.x&&a.y===this.y};return Vec2}();Edge2=function(){Edge2.prototype._DIM=2;function Edge2(start,end){var _ref;this.start=start;this.end=end;if(this.start._DIM!==(_ref=this.end._DIM)&&_ref!==2){CoffeeGLError("Edge 2 must have two Vec2s.")}}Edge2.prototype.equation=function(){return[this.start.y-this.end.y,this.end.x-this.start.x,this.start.x*this.end.y-this.end.x*this.start.y]};Edge2.prototype.sample=function(x){var a,b,c,_ref;_ref=this.equation(),a=_ref[0],b=_ref[1],c=_ref[2];return(-a*x-c)/b};Edge2.prototype.length=function(){return this.end.dist(this.start)};return Edge2}();HalfEdge2=function(_super){__extends(HalfEdge2,_super);function HalfEdge2(start,end,face0,face1){this.start=start;this.end=end;this.face0=face0;this.face1=face1;HalfEdge2.__super__.constructor.call(this,this.start,this.end);this}return HalfEdge2}(Edge2);Vec3=function(){Vec3.prototype._DIM=3;Vec3.sub=function(a,b){return a.copy()["sub"](b)};Vec3.add=function(a,b){return a.copy()["add"](b)};Vec3.cross=function(a,b){return a.copy()["cross"](b)};Vec3.div=function(a,b){return a.copy()["div"](b)};Vec3.mult=function(a,b){return a.copy()["mult"](b)};Vec3.multScalar=function(a,b){return a.copy()["multScalar"](b)};Vec3.normalize=function(a){return a.copy()["normalize"]()};Vec3.dot=function(a,b){return a.dot(b)};function Vec3(x,y,z){var _ref;if(x==null){x=0}if(y==null){y=0}if(z==null){z=0}_ref=[x,y,z],this.x=_ref[0],this.y=_ref[1],this.z=_ref[2]}Vec3.prototype.copy=function(){return new Vec3(this.x,this.y,this.z)};Vec3.prototype.copyFrom=function(a){this.x=a.x;this.y=a.y;this.z=a.z;return this};Vec3.prototype.length=function(){return Math.sqrt(this.lengthSquared())};Vec3.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z};Vec3.prototype.normalize=function(){var m;m=this.length();if(m>0){this.multScalar(1/m)}return this};Vec3.prototype.sub=function(v){this.x-=v.x;this.y-=v.y;this.z-=v.z;return this};Vec3.prototype.add=function(v){this.x+=v.x;this.y+=v.y;this.z+=v.z;return this};Vec3.prototype.cross=function(v){var x,y,z;x=this.y*v.z-this.z*v.y;y=this.z*v.x-this.x*v.z;z=this.x*v.y-this.y*v.x;this.x=x;this.y=y;this.z=z;return this};Vec3.prototype.dv=function(v){return new Vec3(Math.abs(this.x-v.x)(Math.abs(this.y-v.y)(Math.abs(this.z-v.z))))};Vec3.prototype.dist=function(v){return Vec3.sub(this,v).length()};Vec3.prototype.distSquared=function(v){return Vec3.sub(this,v).lengthSquared()};Vec3.prototype.div=function(n){var _ref;_ref=[this.x/n.x,this.y/n.y,this.z/n.z],this.x=_ref[0],this.y=_ref[1],this.z=_ref[2];return this};Vec3.prototype.mult=function(v){var _ref;_ref=[this.x*v.x,this.y*v.y,this.z*v.z],this.x=_ref[0],this.y=_ref[1],this.z=_ref[2];return this};Vec3.prototype.multScalar=function(n){var _ref;_ref=[this.x*n,this.y*n,this.z*n],this.x=_ref[0],this.y=_ref[1],this.z=_ref[2];return this};Vec3.prototype.equals=function(v){return this.x===v.x&&this.y===v.y&&this.z===v.z};Vec3.prototype.dot=function(v){return this.x*v.x+this.y*v.y+this.z*v.z};Vec3.prototype.invalid=function(){return this.x===Infinity||isNaN(this.x)||this.y===Infinity||isNaN(this.y)||this.z===Infinity||isNaN(this.z)};Vec3.prototype.flatten=function(){return[this.x,this.y,this.z]};Vec3.prototype.equals=function(a){return a.x===this.x&&a.y===this.y&&a.z===this.z};return Vec3}();Vec4=function(){Vec4.prototype._DIM=4;Vec4.sub=function(a,b){return a.copy()["sub"](b)};Vec4.add=function(a,b){return a.copy()["add"](b)};Vec4.cross=function(a,b){return a.copy()["cross"](b)};Vec4.div=function(a,b){return a.copy()["div"](b)};Vec4.mult=function(a,b){return a.copy()["mult"](b)};Vec4.multScalar=function(a,b){return a.copy()["multScalar"](b)};Vec4.normalize=function(a){return a.copy()["normalize"]()};Vec4.dot=function(a,b){return a.dot(b)};function Vec4(x,y,z,w){var _ref;if(x==null){x=0}if(y==null){y=0}if(z==null){z=0}if(w==null){w=1}_ref=[x,y,z,w],this.x=_ref[0],this.y=_ref[1],this.z=_ref[2],this.w=_ref[3]}Vec4.prototype.copy=function(){return new Vec4(this.x,this.y,this.z,this.w)};Vec4.prototype.copyFrom=function(a){this.x=a.x;this.y=a.y;this.z=a.z;this.w=a.w;return this};Vec4.prototype.equals=function(a){return a.x===this.x&&a.y===this.y&&a.z===this.z&&a.w===this.w};Vec4.prototype.length=function(){return Math.sqrt(this.lengthSquared())};Vec4.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w};Vec4.prototype.normalize=function(){var m;m=this.length();if(m>0){this.multScalar(1/m)}return this};Vec4.prototype.sub=function(v){this.x-=v.x;this.y-=v.y;this.z-=v.z;this.w-=v.w;return this};Vec4.prototype.equals=function(v){return this.x===v.x&&this.y===v.y&&this.z===v.z&&this.w===v.w};Vec4.prototype.add=function(v){this.x+=v.x;this.y+=v.y;this.z+=v.z;this.w+=v.w;return this};Vec4.prototype.cross=function(v){var x,y,z;x=this.y*v.z-this.z*v.y;y=this.z*v.x-this.x*v.z;z=this.x*v.y-this.y*v.x;this.x=x;this.y=y;this.z=z;return this};Vec4.prototype.dv=function(v){return new Vec4(Math.abs(this.x-v.x)(Math.abs(this.y-v.y)(Math.abs(this.z-v.z)(Math.abs(this.w-v.w)))))};Vec4.prototype.dist=function(v){return Vec4.sub(this,v).length()};Vec4.prototype.distSquared=function(v){return Vec4.sub(this,v).lengthSquared()};Vec4.prototype.div=function(n){var _ref;_ref=[this.x/n.x,this.y/n.y,this.z/n.z,this.w/n.w],this.x=_ref[0],this.y=_ref[1],this.z=_ref[2],this.w=_ref[3];return this};Vec4.prototype.mult=function(v){var _ref;_ref=[this.x*v.x,this.y*v.y,this.z*v.z,this.w*v.w],this.x=_ref[0],this.y=_ref[1],this.z=_ref[2],this.w=_ref[3];return this};Vec4.prototype.multScalar=function(n){var _ref;_ref=[this.x*n,this.y*n,this.z*n,this.w*n],this.x=_ref[0],this.y=_ref[1],this.z=_ref[2],this.w=_ref[3];return this};Vec4.prototype.dot=function(v){return this.x*v.x+this.y*v.y+this.z*v.z+this.w*v.w};Vec4.prototype.invalid=function(){return this.x===Infinity||isNaN(this.x)||this.y===Infinity||isNaN(this.y)||this.z===Infinity||isNaN(this.z)||this.w===Infinity||isNaN(this.w)};Vec4.prototype.flatten=function(){return[this.x,this.y,this.z,this.w]};return Vec4}();Matrix2=function(){Matrix2.prototype._DIM=2;Matrix2.addScalar=function(a,b){return a.copy()["addScalar"](b)};Matrix2.subScalar=function(a,b){return a.copy()["subScalar"](b)};Matrix2.multScalar=function(a,b){return a.copy()["multScalar"](b)};Matrix2.divScalar=function(a,b){return a.copy()["divScalar"](b)};Matrix2.mult=function(a,b){return a.copy()["mult"](b)};Matrix2.multVec=function(m,v){var tv;tv=v.copy();m.multVec(tv);return tv};Matrix2.transpose=function(a){return new Matrix2([a.a[0],a.a[2],a.a[1],a.a[3]])};function Matrix2(a){if(a==null){a=[1,0,0,1]}if(a instanceof Matrix2){this.a=a.a}else{this.a=new glMatrixArrayType(a)}}Matrix2.prototype.copy=function(){return new Matrix2(this.a)};Matrix2.prototype.copyFrom=function(a){var i,_i;for(i=_i=0;_i<=3;i=++_i){this.a[i]=a.a[i]}return this};Matrix2.prototype.multScalar=function(n){var num;this.a=function(){var _i,_len,_ref,_results;_ref=this.a;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){num=_ref[_i];_results.push(num*n)}return _results}.call(this);return this};Matrix2.prototype.addScalar=function(n){var num;this.a=function(){var _i,_len,_ref,_results;_ref=this.a;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){num=_ref[_i];_results.push(num+n)}return _results}.call(this);return this};Matrix2.prototype.subScalar=function(n){var num;this.a=function(){var _i,_len,_ref,_results;_ref=this.a;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){num=_ref[_i];_results.push(num-n)}return _results}.call(this);return this};Matrix2.prototype.divScalar=function(n){var num;this.a=function(){var _i,_len,_ref,_results;_ref=this.a;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){num=_ref[_i];_results.push(num/n)}return _results}.call(this);return this};Matrix2.prototype.identity=function(){this.a.set([1,0,0,1]);return this};Matrix2.prototype.at=function(r,c){return this.a[r*2+c]};Matrix2.prototype.mult=function(m){var a;a=new Matrix2;a.a[0]=this.a[0]*m.a[0]+this.a[2]*m.a[1];a.a[1]=this.a[1]*m.a[0]+this.a[3]*m.a[1];a.a[2]=this.a[0]*m.a[2]+this.a[2]*m.a[3];a.a[3]=this.a[1]*m.a[2]+this.a[3]*m.a[3];this.copyFrom(a);return this};Matrix2.prototype.multVec=function(v){var x,y;if(v._DIM!==2){CoffeeGLWarning("Mismatched vector and matrix dimensions");return}x=this.a[0]*v.x+this.a[2]*v.y;y=this.a[1]*v.x+this.a[3]*v.y;v.x=x;v.y=y;return this};Matrix2.prototype.getCol=function(c){c=c*Matrix2.DIM;return Vec2(this.a[c+0](this.a[c+1]))};Matrix2.prototype.getRow=function(r){return Vec2(this.a[r+0](this.a[r+2]))};Matrix2.prototype.transpose=function(){this.copyFrom(new Matrix2([this.a[0],a[2],this.a[1],this.a[3]]));return this};Matrix2.prototype.print=function(){console.log(this.a[0]+","+this.a[2]);return console.log(this.a[1]+","+this.a[3])};Matrix2.prototype.rotate=function(a){var c,r,s;r=new Matrix2;s=Math.sin(a);c=Math.cos(a);r.a[0]=c;r.a[1]=s;r.a[2]=-s;r.a[3]=c;this.mult(r);return this};Matrix2.prototype.scale=function(v){var r;r=new Matrix3;r.a[0]=v.x;r.a[4]=v.y;r.a[8]=v.z;this.mult(r);return this};return Matrix2}();Matrix3=function(){Matrix3.prototype._DIM=3;Matrix3.addScalar=function(a,b){return a.copy()["addScalar"](b)};Matrix3.subScalar=function(a,b){return a.copy()["subScalar"](b)};Matrix3.multScalar=function(a,b){return a.copy()["multScalar"](b)};Matrix3.divScalar=function(a,b){return a.copy()["divScalar"](b)};Matrix3.mult=function(a,b){return a.copy()["mult"](b)};Matrix3.invert=function(a){return a["_invert"]()};Matrix3.multVec=function(m,v){var tv;tv=v.copy();m.multVec(tv);return tv};Matrix3.transpose=function(a){return new Matrix3([a.a.a.a[0],a.a[3],a.a[6],a.a[1],a.a[4],a.a[7],a.a[2],a.a[5],a.a[8]])};function Matrix3(a){if(a==null){a=[1,0,0,0,1,0,0,0,1]}if(a instanceof Matrix3){this.a=a.a}else{this.a=new glMatrixArrayType(a)}}Matrix3.prototype.copy=function(){return new Matrix3(this.a)};Matrix3.prototype.copyFrom=function(a){var i,_i;for(i=_i=0;_i<=8;i=++_i){this.a[i]=a.a[i]}return this};Matrix3.prototype.multScalar=function(n){var num;this.a=function(){var _i,_len,_ref,_results;_ref=this.a;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){num=_ref[_i];_results.push(num*n)}return _results}.call(this);return this};Matrix3.prototype.addScalar=function(n){var num;this.a=function(){var _i,_len,_ref,_results;_ref=this.a;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){num=_ref[_i];_results.push(num+n)}return _results}.call(this);return this};Matrix3.prototype.subScalar=function(n){var num;this.a=function(){var _i,_len,_ref,_results;_ref=this.a;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){num=_ref[_i];_results.push(num-n)}return _results}.call(this);return this};Matrix3.prototype.divScalar=function(n){var num;this.a=function(){var _i,_len,_ref,_results;_ref=this.a;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){num=_ref[_i];_results.push(num/n)}return _results}.call(this);return this};Matrix3.prototype.identity=function(){this.a.set([1,0,0,0,1,0,0,0,1]);return this};Matrix3.prototype.at=function(r,c){return this.a[r*3+c]};Matrix3.prototype.mult=function(m){var a;a=new Matrix3;a.a[0]=this.a[0]*m.a[0]+this.a[3]*m.a[1]+this.a[6]*m.a[2];a.a[1]=this.a[1]*m.a[0]+this.a[4]*m.a[1]+this.a[7]*m.a[2];a.a[2]=this.a[2]*m.a[0]+this.a[5]*m.a[1]+this.a[8]*m.a[2];a.a[3]=this.a[0]*m.a[3]+this.a[3]*m.a[4]+this.a[6]*m.a[5];a.a[4]=this.a[1]*m.a[3]+this.a[4]*m.a[4]+this.a[7]*m.a[5];a.a[5]=this.a[2]*m.a[3]+this.a[5]*m.a[4]+this.a[8]*m.a[5];a.a[6]=this.a[0]*m.a[6]+this.a[3]*m.a[7]+this.a[6]*m.a[8];a.a[7]=this.a[1]*m.a[6]+this.a[4]*m.a[7]+this.a[7]*m.a[8];a.a[8]=this.a[2]*m.a[6]+this.a[5]*m.a[7]+this.a[8]*m.a[8];this.copyFrom(a);return this};Matrix3.prototype.multVec=function(v){var x,y,z;if(v._DIM!==3){CoffeeGLWarning("Mismatched vector and matrix dimensions");return}x=this.a[0]*v.x+this.a[3]*v.y+this.a[6]*v.z;y=this.a[1]*v.x+this.a[4]*v.y+this.a[7]*v.z;z=this.a[2]*v.x+this.a[5]*v.y+this.a[8]*v.z;v.x=x;v.y=y;v.z=z;return this};Matrix3.prototype.getCol=function(c){c=c*Matrix3.DIM;return Vec3(this.a[c+0](this.a[c+1](this.a[c+2])))};Matrix3.prototype.getRow=function(r){return Vec3(this.a[r+0](this.a[r+3](this.a[r+6])))};Matrix3.prototype._invert=function(){var det,epsilon,inv,invDet;inv=new Matrix3;epsilon=437114e-10;inv.a[0]=this.a[4]*this.a[8]-this.a[5]*this.a[7];inv.a[1]=this.a[2]*this.a[7]-this.a[1]*this.a[8];inv.a[2]=this.a[1]*this.a[5]-this.a[2]*this.a[4];inv.a[3]=this.a[5]*this.a[6]-this.a[3]*this.a[8];inv.a[4]=this.a[0]*this.a[8]-this.a[2]*this.a[6];inv.a[5]=this.a[2]*this.a[3]-this.a[0]*this.a[5];inv.a[6]=this.a[3]*this.a[7]-this.a[4]*this.a[6];inv.a[7]=this.a[1]*this.a[6]-this.a[0]*this.a[7];inv.a[8]=this.a[0]*this.a[4]-this.a[1]*this.a[3];det=this.a[0]*inv.a[0]+this.a[1]*inv.a[3]+this.a[2]*inv.a[6];if(Math.abs(det)>epsilon){invDet=1/det;inv.multScalar(invDet)}return inv};Matrix3.prototype.invert=function(){this.copyFrom(this._invert());return this};Matrix3.prototype.transpose=function(){this.copyFrom(new Matrix3([this.a[0],this.a[3],this.a[6],this.a[1],this.a[4],this.a[7],this.a[2],this.a[5],this.a[8]]));return this};Matrix3.prototype.print=function(){console.log(this.a[0]+","+this.a[3]+","+this.a[6]);console.log(this.a[1]+","+this.a[4]+","+this.a[7]);return console.log(this.a[2]+","+this.a[5]+","+this.a[8])};Matrix3.prototype.rotate=function(v,a){var c,r,s;r=new Matrix3;s=Math.sin(a);c=Math.cos(a);v.normalize();r.a[0]=v.x*v.x*(1-c)+c;r.a[1]=v.x*v.y*(1-c)+v.z*s;r.a[2]=v.x*v.z*(1-c)-v.y*s;r.a[3]=v.x*v.y*(1-c)-v.z*s;r.a[4]=v.y*v.y*(1-c)+c;r.a[5]=v.y*v.z*(1-c)+v.x*s;r.a[6]=v.x*v.z*(1-c)+v.y*s;r.a[7]=v.y*v.z*(1-c)-v.x*s;r.a[8]=v.z*v.z*(1-c)+c;this.mult(r);return this};Matrix3.prototype.scale=function(v){var r;r=new Matrix3;r.a[0]=v.x;r.a[4]=v.y;r.a[8]=v.z;this.mult(r);return this};return Matrix3}();Matrix4=function(){Matrix4.prototype._DIM=4;Matrix4.addScalar=function(a,b){return a.copy()["addScalar"](b)};Matrix4.subScalar=function(a,b){return a.copy()["subScalar"](b)};Matrix4.multScalar=function(a,b){return a.copy()["multScalar"](b)};Matrix4.divScalar=function(a,b){return a.copy()["divScalar"](b)};Matrix4.mult=function(a,b){return a.copy()["mult"](b)};Matrix4.invert=function(a){return a["_invert"]()};Matrix4.transpose=function(a){return new Matrix4([a.a[0],a.a[4],a.a[8],a.a[12],a.a[1],a.a[5],a.a[9],a.a[13],a.a[2],a.a[6],a.a[10],a.a[14],a.a[3],a.a[7],a.a[11],a.a[15]])};Matrix4.multVec=function(m,v){var tv;tv=v.copy();m.multVec(tv);return tv};function Matrix4(a){if(a==null){a=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}if(a instanceof Matrix4){this.a=a.a}else{this.a=new glMatrixArrayType(a)}}Matrix4.prototype.copy=function(){return new Matrix4(this.a)};Matrix4.prototype.copyFrom=function(a){var i,_i;for(i=_i=0;_i<=15;i=++_i){this.a[i]=a.a[i]}return this};Matrix4.prototype.multScalar=function(n){var num;this.a=function(){var _i,_len,_ref,_results;_ref=this.a;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){num=_ref[_i];_results.push(num*n)}return _results}.call(this);return this};Matrix4.prototype.addScalar=function(n){var num;this.a=function(){var _i,_len,_ref,_results;_ref=this.a;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){num=_ref[_i];_results.push(num+n)}return _results}.call(this);return this};Matrix4.prototype.subScalar=function(n){var num;this.a=function(){var _i,_len,_ref,_results;_ref=this.a;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){num=_ref[_i];_results.push(num-n)}return _results}.call(this);return this};Matrix4.prototype.divScalar=function(n){var num;this.a=function(){var _i,_len,_ref,_results;_ref=this.a;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){num=_ref[_i];_results.push(num/n)}return _results}.call(this);return this};Matrix4.prototype.identity=function(){this.a.set([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);return this};Matrix4.prototype.at=function(r,c){return this.a[r*4+c]};Matrix4.prototype.getMatrix3=function(){return new Matrix3([this.a[0],this.a[1],this.a[2],this.a[4],this.a[5],this.a[6],this.a[8],this.a[9],this.a[10]])};Matrix4.prototype.mult=function(m){var a;a=new Matrix4;a.a[0]=this.a[0]*m.a[0]+this.a[4]*m.a[1]+this.a[8]*m.a[2]+this.a[12]*m.a[3];a.a[1]=this.a[1]*m.a[0]+this.a[5]*m.a[1]+this.a[9]*m.a[2]+this.a[13]*m.a[3];a.a[2]=this.a[2]*m.a[0]+this.a[6]*m.a[1]+this.a[10]*m.a[2]+this.a[14]*m.a[3];a.a[3]=this.a[3]*m.a[0]+this.a[7]*m.a[1]+this.a[11]*m.a[2]+this.a[15]*m.a[3];a.a[4]=this.a[0]*m.a[4]+this.a[4]*m.a[5]+this.a[8]*m.a[6]+this.a[12]*m.a[7];a.a[5]=this.a[1]*m.a[4]+this.a[5]*m.a[5]+this.a[9]*m.a[6]+this.a[13]*m.a[7];a.a[6]=this.a[2]*m.a[4]+this.a[6]*m.a[5]+this.a[10]*m.a[6]+this.a[14]*m.a[7];a.a[7]=this.a[3]*m.a[4]+this.a[7]*m.a[5]+this.a[11]*m.a[6]+this.a[15]*m.a[7];a.a[8]=this.a[0]*m.a[8]+this.a[4]*m.a[9]+this.a[8]*m.a[10]+this.a[12]*m.a[11];a.a[9]=this.a[1]*m.a[8]+this.a[5]*m.a[9]+this.a[9]*m.a[10]+this.a[13]*m.a[11];a.a[10]=this.a[2]*m.a[8]+this.a[6]*m.a[9]+this.a[10]*m.a[10]+this.a[14]*m.a[11];a.a[11]=this.a[3]*m.a[8]+this.a[7]*m.a[9]+this.a[11]*m.a[10]+this.a[15]*m.a[11];a.a[12]=this.a[0]*m.a[12]+this.a[4]*m.a[13]+this.a[8]*m.a[14]+this.a[12]*m.a[15];a.a[13]=this.a[1]*m.a[12]+this.a[5]*m.a[13]+this.a[9]*m.a[14]+this.a[13]*m.a[15];a.a[14]=this.a[2]*m.a[12]+this.a[6]*m.a[13]+this.a[10]*m.a[14]+this.a[14]*m.a[15];a.a[15]=this.a[3]*m.a[12]+this.a[7]*m.a[13]+this.a[11]*m.a[14]+this.a[15]*m.a[15];this.copyFrom(a);return this};Matrix4.prototype.multVec=function(v){var w,x,y,z;if(v._DIM!==3&&v._DIM!==4){CoffeeGLWarning("Mismatched vector and matrix dimensions");return}if(v._DIM===3){x=this.a[0]*v.x+this.a[4]*v.y+this.a[8]*v.z+this.a[12];y=this.a[1]*v.x+this.a[5]*v.y+this.a[9]*v.z+this.a[13];z=this.a[2]*v.x+this.a[6]*v.y+this.a[10]*v.z+this.a[14];w=this.a[3]*v.x+this.a[7]*v.y+this.a[11]*v.z+this.a[15];v.x=x/w;v.y=y/w;v.z=z/w}else{x=this.a[0]*v.x+this.a[4]*v.y+this.a[8]*v.z+this.a[12]*v.w;y=this.a[1]*v.x+this.a[5]*v.y+this.a[9]*v.z+this.a[13]*v.w;z=this.a[2]*v.x+this.a[6]*v.y+this.a[10]*v.z+this.a[14]*v.w;w=this.a[3]*v.x+this.a[7]*v.y+this.a[11]*v.z+this.a[15]*v.w;v.x=x;v.y=y;v.z=z;v.w=w}return this};Matrix4.prototype.at=function(r,c){return this.a[c*Matrix4.DIM+r]};Matrix4.prototype.getCol=function(c){c=c*Matrix4.DIM;return Vec4(this.a[c+0](this.a[c+1](this.a[c+2](this.a[c+3]))))};Matrix4.prototype.getRow=function(r){return Vec4(this.a[r+0](this.a[r+4](this.a[r+8](this.a[r+12]))))};Matrix4.prototype._invert=function(){var a0,a1,a2,a3,a4,a5,b0,b1,b2,b3,b4,b5,det,epsilon,inv,invDet;inv=new Matrix4;epsilon=437114e-10;a0=this.a[0]*this.a[5]-this.a[1]*this.a[4];a1=this.a[0]*this.a[6]-this.a[2]*this.a[4];a2=this.a[0]*this.a[7]-this.a[3]*this.a[4];a3=this.a[1]*this.a[6]-this.a[2]*this.a[5];a4=this.a[1]*this.a[7]-this.a[3]*this.a[5];a5=this.a[2]*this.a[7]-this.a[3]*this.a[6];b0=this.a[8]*this.a[13]-this.a[9]*this.a[12];b1=this.a[8]*this.a[14]-this.a[10]*this.a[12];b2=this.a[8]*this.a[15]-this.a[11]*this.a[12];b3=this.a[9]*this.a[14]-this.a[10]*this.a[13];b4=this.a[9]*this.a[15]-this.a[11]*this.a[13];b5=this.a[10]*this.a[15]-this.a[11]*this.a[14];det=a0*b5-a1*b4+a2*b3+a3*b2-a4*b1+a5*b0;if(Math.abs(det)>epsilon){inv.a[0]=+this.a[5]*b5-this.a[6]*b4+this.a[7]*b3;inv.a[4]=-this.a[4]*b5+this.a[6]*b2-this.a[7]*b1;inv.a[8]=+this.a[4]*b4-this.a[5]*b2+this.a[7]*b0;inv.a[12]=-this.a[4]*b3+this.a[5]*b1-this.a[6]*b0;inv.a[1]=-this.a[1]*b5+this.a[2]*b4-this.a[3]*b3;inv.a[5]=+this.a[0]*b5-this.a[2]*b2+this.a[3]*b1;inv.a[9]=-this.a[0]*b4+this.a[1]*b2-this.a[3]*b0;inv.a[13]=+this.a[0]*b3-this.a[1]*b1+this.a[2]*b0;inv.a[2]=+this.a[13]*a5-this.a[14]*a4+this.a[15]*a3;inv.a[6]=-this.a[12]*a5+this.a[14]*a2-this.a[15]*a1;inv.a[10]=+this.a[12]*a4-this.a[13]*a2+this.a[15]*a0;inv.a[14]=-this.a[12]*a3+this.a[13]*a1-this.a[14]*a0;inv.a[3]=-this.a[9]*a5+this.a[10]*a4-this.a[11]*a3;inv.a[7]=+this.a[8]*a5-this.a[10]*a2+this.a[11]*a1;inv.a[11]=-this.a[8]*a4+this.a[9]*a2-this.a[11]*a0;inv.a[15]=+this.a[8]*a3-this.a[9]*a1+this.a[10]*a0}invDet=1/det;inv.multScalar(invDet);return inv};Matrix4.prototype.invert=function(){this.copyFrom(this._invert());return this};Matrix4.prototype.transpose=function(){this.copyFrom(new Matrix4([this.a[0],this.a[4],this.a[8],this.a[12],this.a[1],this.a[5],this.a[9],this.a[13],this.a[2],this.a[6],this.a[10],this.a[14],this.a[3],this.a[7],this.a[11],this.a[15]]));return this};Matrix4.prototype.translate=function(v){var r;if(v._DIM===3||v._DIM===_DIM){r=new Matrix4;r.a[12]=v.x;r.a[13]=v.y;r.a[14]=v.z;this.mult(r)}else{CoffeeGLWarning("Mismatched vector and matrix dimensions")}return this};Matrix4.prototype.setPos=function(v){if(v.x!=null){this.a[12]=v.x}if(v.y!=null){this.a[13]=v.y}if(v.z!=null){this.a[14]=v.z}return this};Matrix4.prototype.getPos=function(){return new Vec3(this.a[12],this.a[13],this.a[14])};Matrix4.prototype.print=function(){console.log(this.a[0]+","+this.a[4]+","+this.a[8]+","+this.a[12]);console.log(this.a[1]+","+this.a[5]+","+this.a[9]+","+this.a[13]);console.log(this.a[2]+","+this.a[6]+","+this.a[10]+","+this.a[14]);return console.log(this.a[3]+","+this.a[7]+","+this.a[11]+","+this.a[15])};Matrix4.prototype.lookAt=function(eye,look,up){var f,m,s,t,u,w;f=Vec3.sub(look,eye);f.normalize();u=up.copy();u.normalize();s=Vec3.cross(f,u);w=Vec3.cross(s,f);m=new Matrix4([s.x,u.x,-f.x,0,s.y,u.y,-f.y,0,s.z,u.z,-f.z,0,0,0,0,1]);t=new Matrix4([1,0,0,0,0,1,0,0,0,0,1,0,-eye.x,-eye.y,-eye.z,1]);m.mult(t);this.copyFrom(m);return this};Matrix4.prototype.makePerspective=function(fovy,aspect,znear,zfar){var xmax,xmin,ymax,ymin;ymax=znear*Math.tan(fovy*Math.PI/360);ymin=-ymax;xmin=ymin*aspect;xmax=ymax*aspect;this.makeFrustum(xmin,xmax,ymin,ymax,znear,zfar);return this};Matrix4.prototype.makeFrustum=function(left,right,bottom,top,znear,zfar){var a,b,c,d,x,y;x=2*znear/(right-left);y=2*znear/(top-bottom);a=(right+left)/(right-left);b=(top+bottom)/(top-bottom);c=-(zfar+znear)/(zfar-znear);d=-2*zfar*znear/(zfar-znear);this.a=new glMatrixArrayType([x,0,0,0,0,y,0,0,a,b,c,-1,0,0,d,0]);return this};Matrix4.prototype.makeOrtho=function(left,right,bottom,top,znear,zfar){var tx,ty,tz;tx=-(right+left)/(right-left);ty=-(top+bottom)/(top-bottom);tz=-(zfar+znear)/(zfar-znear);this.a=new glMatrixArrayType([2/(right-left),0,0,0,0,2/(top-bottom),0,0,0,0,-2/(zfar-znear),0,tx,ty,tz,1]);
return this};Matrix4.prototype.rotate=function(v,a){var c,r,s;r=new Matrix4;s=Math.sin(a);c=Math.cos(a);v.normalize();r.a[0]=v.x*v.x*(1-c)+c;r.a[1]=v.x*v.y*(1-c)+v.z*s;r.a[2]=v.x*v.z*(1-c)-v.y*s;r.a[4]=v.x*v.y*(1-c)-v.z*s;r.a[5]=v.y*v.y*(1-c)+c;r.a[6]=v.y*v.z*(1-c)+v.x*s;r.a[8]=v.x*v.z*(1-c)+v.y*s;r.a[9]=v.y*v.z*(1-c)-v.x*s;r.a[10]=v.z*v.z*(1-c)+c;this.mult(r);return this};Matrix4.prototype.scale=function(v){var r;r=new Matrix4;r.a[0]=v.x;r.a[5]=v.y;r.a[10]=v.z;this.mult(r);return this};return Matrix4}();Quaternion=function(){Quaternion.addScalar=function(a,b){return a.copy()["addScalar"](b)};Quaternion.subScalar=function(a,b){return a.copy()["subScalar"](b)};Quaternion.multScalar=function(a,b){return a.copy()["multScalar"](b)};Quaternion.divScalar=function(a,b){return a.copy()["divScalar"](b)};Quaternion.mult=function(a,b){return a.copy()["mult"](b)};Quaternion.transVec3=function(q,v){var tv;tv=v.copy();q.transVec3(tv);return tv};Quaternion.fromTo=function(f,t){var tv;tv=new Quaternion;tv.fromTo(f,t);return tv};function Quaternion(v,w){if(v==null||w==null){this.v=new Vec3(0,0,0);this.w=1}else{this.v=v.copy();this.w=w}}Quaternion.prototype.copy=function(){return new Quaternion(this.v,this.w)};Quaternion.prototype.axis=function(){var ca,invlen;ca=w;invlen=1/Math.sqrt(1-ca*ca);return Vec3.multScalar(v,invlen)};Quaternion.prototype.angle=function(){var ca;ca=w;return Math.acos(ca)*2};Quaternion.prototype.pitch=function(){return Math.atan2(2*(this.v.y*this.v.z+this.w*this.v.x),this.w*this.w-this.v.x*this.v.x-this.v.y*this.v.y+this.v.z*this.v.z)};Quaternion.prototype.yaw=function(){return Math.sin(-2*(this.v.x*this.v.z-this.w*this.v.y))};Quaternion.prototype.roll=function(){return Math.atan2(2*(this.v.x*this.v.y+this.w*this.v.z),this.w*this.w+this.v.x*this.v.x-this.v.y*this.v.y-this.v.z*this.v.z)};Quaternion.prototype.dot=function(a){return this.w*a.w+v.dot(a.v)};Quaternion.prototype.length=function(){return Math.sqrt(this.w*this.w+this.v.lengthSquared())};Quaternion.prototype.lengthSquared=function(){return w*w+this.v.lengthSquared()};Quaternion.prototype.invert=function(){var norm,normRecip;norm=this.w*this.w+this.v.x*this.v.x+this.v.y*this.v.y+this.v.z*this.v.z;if(Math.abs(norm)<EPSILON_VALUE){return this.identity()}normRecip=1/norm;this.w=normRecip*w;this.v.multScalar(-normRecip);return this};Quaternion.prototype.add=function(q){this.w+=q.w;this.v.x+=q.v.x;this.v.y+=q.v.y;this.v.z+=q.v.z;return this};Quaternion.prototype.sub=function(q){this.w-=q.w;this.v.x-=q.v.x;this.v.y-=q.v.y;this.v.z-=q.v.z;return this};Quaternion.prototype.multiply=function(q){return this.mult(q)};Quaternion.prototype.mult=function(q){this.w=this.w*q.w-this.v.x*q.v.x-this.v.y*q.v.y-this.v.z*q.v.z;this.v.x=q.w*this.v.x+q.v.x*this.w+q.v.y*this.v.z-q.v.z*this.v.y;this.v.y=q.w*this.v.y+q.v.y*this.w+q.v.z*this.v.x-q.v.x*this.v.z;this.v.z=q.w*this.v.z+q.v.z*this.w+q.v.x*this.v.y-q.v.y*this.v.x;return this};Quaternion.prototype.multScalar=function(s){this.w=this.w*s;this.v.multScalar(s);return this};Quaternion.prototype.transVec3=function(v){var cm,pm,vm,x,y,z;vm=2*(this.v.x*v.x+this.v.y*v.y+this.v.z*v.z);cm=2*this.w;pm=cm*this.w-1;x=pm*v.x+vm*this.v.x+cm*(this.v.y*v.z-this.v.z*v.y);y=pm*v.y+vm*this.v.y+cm*(this.v.z*v.x-this.v.x*v.z);z=pm*v.z+vm*this.v.z+cm*(this.v.x*v.y-this.v.y*v.x);v.x=x;v.y=y;v.z=z;return this};Quaternion.prototype.normalize=function(){var len;len=this.length();if(len>0){this.w/=len;this.v.multScalar(1/len)}else{this.w=1;this.v.x=v.y=v.z=0}return this};Quaternion.prototype.log=function(){var k,sintheta,t,theta;t=1;if(this.w<t){t=this.w}theta=Math.acos(t);if(theta===0){return new Quaternion(this.v,0)}sintheta=Math.sin(theta);k=theta/sintheta;if(Math.abs(sintheta)<1&&Math.abs(theta)>=3.402823466e38*Math.abs(sintheta)){k=1}return new Quaternion(new Vec3(this.v.x*k,this.v.y*k,v.z*k),0)};Quaternion.prototype.exp=function(){var costheta,k,sintheta,theta;theta=this.v.length();sintheta=sin(theta);k=sintheta/theta;if(Math.abs(theta)<1&&Math.abs(sintheta)>=3.402823466e38*Math.abs(theta)){k=1}costheta=Math.cos(theta);return new Quaternion(new Vec3(this.v.x*k,this.v.y*k,v.z*k),costheta)};Quaternion.prototype.invert2=function(){var qdot;qdot=this.dot();this.v=new Vec3(-this.v.x/qdot,-this.v.y/qdot,-this.v.z/qdot);this.w=this.w/qdot;return this};Quaternion.prototype.fromTo=function(f,t){var axis;axis=Vec3.cross(f,t);this.w=f.dot(t);this.v.x=axis.x;this.v.y=axis.y;this.v.z=axis.z;this.normalize();this.w+=1;if(this.w<=EPSILON_VALUE){if(f.z*f.z>f.x*f.x){this.w=0;this.v.x=0;this.v.y=f.z;this.v.z=-f.y}else{this.w=0;this.v.x=f.y;this.v.y=-f.x;this.v.z=0}this.normalize()}return this};Quaternion.prototype.fromAxisAngle=function(a,r){this.w=Math.cos(r/2);this.v=Vec3.normalize(a).multScalar(Math.sin(r/2));return this};Quaternion.prototype.fromRotations=function(x,y,z){var cx,cy,cz,sx,sy,sz;x*=.5;y*=.5;z*=.5;cx=Math.cos(x);sx=Math.sin(x);cy=Math.cos(y);sy=Math.sin(y);cz=Math.cos(z);sz=Math.sin(z);this.w=cx*cy*cz-sx*sy*sz;this.v.x=sx*cy*cx+cx*sy*sz;this.v.y=cx*sy*cz-sx*cy*sz;this.v.z=cx*cy*sz+sx*sy*cx;return this};Quaternion.prototype.getAxisAngle=function(){var ca,invlen,r;ca=this.w;r=Math.acos(ca)*2;invlen=1/Math.sqrt(1-ca*ca);return[new Vec3(this.v.x*invlen,this.v.y*invlen,this.v.z*invlen),r]};Quaternion.prototype.getMatrix4=function(){var wx,wy,wz,xs,xx,xy,xz,ys,yy,yz,zs,zz;xs=this.v.x+this.v.x;ys=this.v.y+this.v.y;zs=this.v.z+this.v.z;wx=this.w*xs;wy=this.w*ys;wz=this.w*zs;xx=this.v.x*xs;xy=this.v.x*ys;xz=this.v.x*zs;yy=this.v.y*ys;yz=this.v.y*zs;zz=this.v.z*zs;return new Matrix4([1-(yy+zz),xy+wz,xz-wy,0,xy-wz,1-(xx+zz),yz+wx,0,xz+wy,yz-wx,1-(xx+yy),0,0,0,0,1])};Quaternion.prototype.lerp=function(t,end){var costheta,result;costheta=end.dot();result=Quaternion.multScalar(end,t);if(costheta>=EPSILON_VALUE){result.add(result.multScalar(1-t))}else{result.add(result.multScalar(t-1))}return result};Quaternion.prototype.slerpShortestUnenforced=function(t,end){var a,d,e,lengthD,lengthS,q,s,st;d=this.copy();d.sub(end);lengthD=Math.sqrt(this.dot(end));st=this.copy();st.add(end);lengthS=Math.sqrt(st.dot(st));a=2*Math.atan2(lengthD,lengthS);s=1-t;q=this.copy();q.multScalar(sinx_over_x(s*a)/sinx_over_x(a)*s);e=end.copy();e.multScalar(sinx_over_x(t*a)/sinx_over_x(a)*t);q.add(e);q.normalize();return q};Quaternion.prototype.slerp=function(t,end){var cosTheta,e,endInterp,q,recipSinTheta,startInterp,theta;cosTheta=this.dot(end);if(cosTheta>=EPSILON){if(1-cosTheta>EPSILON){theta=Math.acos(cosTheta);recipSinTheta=1/Math.sin(theta);startInterp=Math.sin((1-t)*theta)*recipSinTheta;endInterp=Math.sin(t*theta)*recipSinTheta}else{startInterp=1-t;endInterp=t}}else{if(1+cosTheta>EPSILON){theta=Math.acos(-cosTheta);recipSinTheta=1/Math.sin(theta);startInterp=Math.sin((t-1)*theta)*recipSinTheta;endInterp=Math.sin(t*theta)*recipSinTheta}else{startInterp=t(-1);endInterp=t}}q=this.copy();q.mult(startInterp);e=end.copy();e.mult(endInterp);q.add(e);return q};Quaternion.prototype.fromMatrix4=function(m){var a,b,i,j,k,recip,s,trace;trace=m.a[0]+m.a[5]+m.a[10];if(trace>0){s=Math.sqrt(trace+1);this.w=s*.5;recip=.5/s;this.v.x=(m.at(2,1)-m.at(1,2))*recip;this.v.y=(m.at(0,2)-m.at(2,0))*recip;this.v.z=(m.at(1,0)-m.at(0,1))*recip}else{i=0;if(m.at(1,1)>m.at(0,0)){i=1}if(m.at(2,2)>m.at(i,i)){i=2}j=(i+1)%3;k=(j+1)%3;s=Math.sqrt(m.at(i,i)-m.at(j,j)-m.at(k,k)+1);if(i===0){this.v.x=.5*s}else if(i===1){this.v.y=.5*s}else{this.v.z=.5*s}recip=.5/s;this.w=(m.at(k,j)-m.at(j,k))*recip;a=(m.at(j,i)+m.at(i,j))*recip;b=(m.at(k,i)+m.at(i,k))*recip;if(j===0){this.v.x=a}else if(j===1){this.v.y=a}else{this.v.z=a}if(k===0){this.v.x=b}else if(k===1){this.v.y=b}else{this.v.z=b}}return this};return Quaternion}();CubicHermiteSpline=function(){function CubicHermiteSpline(p0,p1,m0,m1){this.p0=p0;this.p1=p1;this.m0=m0;this.m1=m1;this}CubicHermiteSpline.prototype.sample=function(t){var c0,c1,c2,c3,t2,t3;t3=t*t*t;t2=t*t;c0=this.p0.copy().multScalar(2*t3-3*t2+1);c1=this.m0.copy().multScalar(t3-2*t2+t);c2=this.p1.copy().multScalar(-2*t3+3*t2);c3=this.m1.copy().multScalar(t3-t2);return c0.add(c1).add(c2).add(c3)};return CubicHermiteSpline}();CatmullRomSpline=function(){function CatmullRomSpline(points){var i,m0,m1,segments,_i,_ref;if(points.length<4){CoffeeGLError("Catmull-Rom Spline needs at least 4 points");return}segments=points.length-3;this.splines=[];for(i=_i=0,_ref=segments-1;0<=_ref?_i<=_ref:_i>=_ref;i=0<=_ref?++_i:--_i){m0=points[i+2].copy().sub(points[i]);m1=points[i+3].copy().sub(points[i+1]);this.splines.push(new CubicHermiteSpline(points[i+1],points[i+2],m0,m1))}}CatmullRomSpline.prototype.sample=function(t){var segment;segment=Math.floor(t*this.splines.length);if(t>=1){return this.splines[this.splines.length-1].sample(1)}else if(t<=0){return this.splines[0].sample(0)}else{return this.splines[segment].sample(this.splines.length*t-segment)}};return CatmullRomSpline}();CatmullPatch=function(){function CatmullPatch(points){var b,bt,p,t,_i,_j,_k,_len,_len1,_len2;if(points.length!==16){CoffeeGLError("Catmull Patch needs 16 points");return}b=new Matrix4([-.5,1,-.5,0,1.5,-2.5,0,1,-1.5,2,.5,0,.5,-.5,0,0]);t=[];for(_i=0,_len=points.length;_i<_len;_i++){p=points[_i];t.push(p.x)}this.px=new Matrix4(t);t=[];for(_j=0,_len1=points.length;_j<_len1;_j++){p=points[_j];t.push(p.y)}this.py=new Matrix4(t);t=[];for(_k=0,_len2=points.length;_k<_len2;_k++){p=points[_k];t.push(p.z)}this.pz=new Matrix4(t);bt=Matrix4.transpose(b);this.px=Matrix4.mult(b,this.px).mult(bt);this.py=Matrix4.mult(b,this.py).mult(bt);this.pz=Matrix4.mult(b,this.pz).mult(bt)}CatmullPatch.prototype.sample=function(v){var u,u1,u2,u3,um,w,w1,w2,w3,x,y,z;u1=v.x;u2=u1*u1;u3=u2*u1;w1=v.y;w2=w1*w1;w3=w2*w1;u=new Vec4(u3,u2,u1,1);w=new Vec4(w3,w2,w1,1);um=Matrix4.multVec(this.px,w);x=u.x*um.x+u.y*um.y+u.z*um.z+u.w*um.w;um=Matrix4.multVec(this.py,w);y=u.x*um.x+u.y*um.y+u.z*um.z+u.w*um.w;um=Matrix4.multVec(this.pz,w);z=u.x*um.x+u.y*um.y+u.z*um.z+u.w*um.w;return new Vec3(x,y,z)};return CatmullPatch}();Parabola=function(){function Parabola(f,a,b,c){this.f=f;this.a=a;this.b=b;this.c=c;this}Parabola.prototype.sample=function(x){var a,as,b,bs,c,cs,h,k,p,t0,t1,t2,t3,u,us,v,vs,xs,y,y0,y1;if(this.a===0&&this.b!==0){h=this.f.x;k=(this.f.y+this.c)/2;p=this.f.y-k;a=1/(4*p);b=-h/(2*p);c=h*h/(4*p)+k;y=a*x*x+b*x+c;return[y,y]}else if(this.b===0&&this.a!==0){h=(this.f.x+this.c)/2;k=this.f.y;p=this.f.x-h;y0=Math.sqrt(4*p*(x-h))+k;y1=k-Math.sqrt(4*p*(x-h));return[y0,y1]}else if(this.a!==0&&this.b!==0){as=this.a*this.a;bs=this.b*this.b;cs=this.c*this.c;u=this.f.x;us=u*u;v=this.f.y;vs=v*v;xs=x*x;t0=-2*as*v-2*this.a*this.b*x-2*bs*v-2*this.b*this.c;t1=Math.sqrt(t0*t0-4*as*(as*us-2*as*u*x+as*vs-2*this.a*this.c*x+bs*us-2*bs*u*x+bs*vs+bs*xs-cs));t2=2*as*v+2*this.a*this.b*x+2*bs*v+2*this.b*this.c;t3=2*as;return[(-t1+t2)/t3,(t1+t2)/t3]}else{CoffeeGLError("Malformed ");return[0,0]}};Parabola.prototype.lineCrossing=function(e,f,g){var a,as,b,bs,c,cs,es,fs,gs,h,hs,k,ks,t0,t1,t2,t3,x0,x1;a=this.a;b=this.b;c=this.c;as=this.a*this.a;bs=this.b*this.b;cs=this.c*this.c;fs=f*f;es=e*e;gs=g*g;h=this.f.x;k=this.f.y;hs=h*h;ks=k*k;console.log(a,b,c,f,e,g,h,k);t0=2*as*e*f*k+2*as*e*g-2*as*fs*h+2*a*b*f*g-2*a*c*fs+2*bs*e*f*k-2*bs*fs*h+2*b*c*e*f;console.log("t0",t0);t1=4*(as*es+2*a*b*e*f+bs*fs)*(as*fs*hs+as*fs*ks+2*as*f*g*k+as*gs+bs*fs*hs+bs*fs*ks+2*bs*f*g*k+2*b*c*f*g-cs*fs);console.log("t1",t1);t2=2*as*e*f*k-2*as*e*g+2*as*fs*h-2*a*b*f*g+2*a*c*fs-2*bs*e*f*k+2*bs*fs*h-2*b*c*e*f;console.log("t2",t2);t3=2*(as*es+2*a*b*e*f+bs*fs);console.log("t3",t3);x0=(-Math.sqrt(t0*t0-t1)-t2)/t3;x1=(Math.sqrt(t0*t0-t1)-t2)/t3;return[new Vec2(x0,(-e*x0-g)/f),new Vec2(x1,(-e*x1-g)/f)]};return Parabola}();module.exports={Vec2:Vec2,Vec3:Vec3,Vec4:Vec4,Matrix2:Matrix2,Matrix3:Matrix3,Matrix4:Matrix4,radToDeg:radToDeg,degToRad:degToRad,Quaternion:Quaternion,PI:PI,Edge2:Edge2,CubicHermiteSpline:CubicHermiteSpline,CatmullRomSpline:CatmullRomSpline,Parabola:Parabola,CatmullPatch:CatmullPatch}}).call(this)},{"./error":20}],2:[function(require,module,exports){(function(){var App,CoffeeGLError,CoffeeGLLog,CoffeeGLWarning,Colour,Matrix4,OrthoCamera,PerspCamera,Shader,Vec2,Vec3,Vec4,makeDebugContext,makeMouseEmitter,makeTouchEmitter,_ref,_ref1,_ref2,_ref3,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};_ref=require("./math"),Vec2=_ref.Vec2,Vec3=_ref.Vec3,Vec4=_ref.Vec4,Matrix4=_ref.Matrix4;Shader=require("./shader").Shader;_ref1=require("./camera"),PerspCamera=_ref1.PerspCamera,OrthoCamera=_ref1.OrthoCamera;_ref2=require("./signal"),makeMouseEmitter=_ref2.makeMouseEmitter,makeTouchEmitter=_ref2.makeTouchEmitter;Colour=require("./colour").Colour;_ref3=require("./error"),CoffeeGLError=_ref3.CoffeeGLError,CoffeeGLWarning=_ref3.CoffeeGLWarning,CoffeeGLLog=_ref3.CoffeeGLLog;makeDebugContext=require("./debug").makeDebugContext;App=function(){function App(element,app_context,init,draw,update,onError,debug){var cl,_this=this;this.app_context=app_context;this.init=init;this.draw=draw;this.update=update;this.onError=onError;this.debug=debug!=null?debug:false;this.getDelta=__bind(this.getDelta,this);this.run=__bind(this.run,this);this.canvas=document.getElementById(element);if(!this.canvas){CoffeeGLError("Trying to create an app on canvas that does not exist")}if(!this._detectWebGL()){if(this.onError!=null){this.onError()}CoffeeGLWarning("No WebGL Context Detected");return}this.height=this.canvas.height;this.width=this.canvas.width;makeMouseEmitter(this);makeTouchEmitter(this);this._pause=false;cl=function(event){event.preventDefault();return _this._initContext()};this.canvas.addEventListener("webglcontextlost",cl,false);this._initContext()}App.prototype._detectWebGL=function(){var name,names,_i,_len;if(!!window.WebGLRenderingContext){names=["webgl","experimental-webgl","moz-webgl","webkit-3d"];for(_i=0,_len=names.length;_i<_len;_i++){name=names[_i];this.gl=this.canvas.getContext(name);if(this.gl!=null&&typeof this.gl.getParameter==="function"){return true}}}return false};App.prototype._initContext=function(){this.gl=this.canvas.getContext("webgl");if(this.gl==null){this.gl=this.canvas.getContext("experimental-webgl")}if(!this.gl){if(this.onError!=null){this.onError()}CoffeeGLWarning("WebGL Not supported or context not found","App");return}this.profile();this._framescounter=0;if(this.debug){CoffeeGLLog("creating OpenGL debug context");makeDebugContext(this.gl)}this.resizeCanvas(this.canvas.width,this.canvas.height);return this._init()};var BrowserDetect={init:function(){this.browser=this.searchString(this.dataBrowser)||"An unknown browser";this.version=this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||"an unknown version";this.OS=this.searchString(this.dataOS)||"an unknown OS"},searchString:function(data){for(var i=0;i<data.length;i++){var dataString=data[i].string;var dataProp=data[i].prop;this.versionSearchString=data[i].versionSearch||data[i].identity;if(dataString){if(dataString.indexOf(data[i].subString)!=-1)return data[i].identity}else if(dataProp)return data[i].identity}},searchVersion:function(dataString){var index=dataString.indexOf(this.versionSearchString);if(index==-1)return;return parseFloat(dataString.substring(index+this.versionSearchString.length+1))},dataBrowser:[{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identity:"OmniWeb"},{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{prop:window.opera,identity:"Opera",versionSearch:"Version"},{string:navigator.vendor,subString:"iCab",identity:"iCab"},{string:navigator.vendor,subString:"KDE",identity:"Konqueror"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.vendor,subString:"Camino",identity:"Camino"},{string:navigator.userAgent,subString:"Netscape",identity:"Netscape"},{string:navigator.userAgent,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Gecko",identity:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"Mozilla",identity:"Netscape",versionSearch:"Mozilla"}],dataOS:[{string:navigator.platform,subString:"Win",identity:"Windows"},{string:navigator.platform,subString:"Mac",identity:"Mac"},{string:navigator.userAgent,subString:"iPhone",identity:"iPhone/iPod"},{string:navigator.platform,subString:"Linux",identity:"Linux"}]};App.prototype.profile=function(){var highp;this.profile={};this.profile.antialias=this.gl.getContextAttributes().antialias;this.profile.aa_size=this.gl.getParameter(this.gl.SAMPLES);highp=this.gl.getShaderPrecisionFormat(this.gl.FRAGMENT_SHADER,this.gl.HIGH_FLOAT);this.profile.highpSupported=highp.precision!==0;this.profile.maxTexSize=this.gl.getParameter(this.gl.MAX_TEXTURE_SIZE);this.profile.maxCubeSize=this.gl.getParameter(this.gl.MAX_CUBE_MAP_TEXTURE_SIZE);this.profile.maxRenderbufferSize=this.gl.getParameter(this.gl.MAX_RENDERBUFFER_SIZE);this.profile.vertexTextureUnits=this.gl.getParameter(this.gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS);this.profile.fragmentTextureUnits=this.gl.getParameter(this.gl.MAX_TEXTURE_IMAGE_UNITS);this.profile.combinedUnits=this.gl.getParameter(this.gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS);this.profile.maxVSattribs=this.gl.getParameter(this.gl.MAX_VERTEX_ATTRIBS);this.profile.maxVertexShaderUniforms=this.gl.getParameter(this.gl.MAX_VERTEX_UNIFORM_VECTORS);this.profile.maxFragmentShaderUniforms=this.gl.getParameter(this.gl.MAX_FRAGMENT_UNIFORM_VECTORS);this.profile.maxVaryings=this.gl.getParameter(this.gl.MAX_VARYING_VECTORS);this.profile.extensions=this.gl.getSupportedExtensions();BrowserDetect.init();this.profile.browser=BrowserDetect.browser;this.profile.os=BrowserDetect.OS;this.profile.version=BrowserDetect.version;function detectmob(){if(navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/BlackBerry/i)||navigator.userAgent.match(/Windows Phone/i)){return true}else{return false}}this.profile.mobile=detectmob();return console.log(this.profile)};App.prototype.run=function(){if(this._pause){return}if(this._framescounter>0){this._framescounter--;if(this._framescounter<=0){this.pause(true)}}this._draw();return this._update(this.getDelta())};App.prototype.pause=function(force){if(force==null){this._pause=!this._pause}else{this._pause=force}if(!this._pause){this.startTime=Date.now();return this.oldTime=this.startTime}};App.prototype.pauseAfter=function(numframes){return this._framescounter=numframes};App.prototype._init=function(){if(this.init!=null){this.init.call(this.app_context)}this.startTime=this.oldTime=Date.now();this.contextTime=0;if(typeof window!=="undefined"&&window!==null){window.onEachFrame(this,this.run)}return this};App.prototype.getDelta=function(){var deltaTime;deltaTime=Date.now()-this.oldTime;this.oldTime=Date.now();return deltaTime};App.prototype.switchContext=function(context){if(context!=null){CoffeeGL.Context=context;if(typeof window!=="undefined"&&window!==null){return window.GL=context.gl}}else{if(CoffeeGL.Context!==this){CoffeeGL.Context=this;if(typeof window!=="undefined"&&window!==null){return window.GL=this.gl}}}};App.prototype.resizeCanvas=function(width,height){this.switchContext();if(this.canvas){if(this.gl){this.width=width;this.height=height;this.canvas.width=width;return this.canvas.height=height}}};App.prototype._draw=function(){this.switchContext();if(this.draw!=null){return this.draw.call(this.app_context)}};App.prototype._update=function(dt){this.contextTime=Date.now()-this.startTime;this.switchContext();if(this.update!=null){return this.update.call(this.app_context,dt)}};return App}();module.exports={App:App}}).call(this)},{"./math":3,"./shader":8,"./camera":12,"./signal":16,"./colour":4,"./error":20,"./debug":25}],5:[function(require,module,exports){(function(){var Geometry,Matrix4,Plane,PlaneFlat,Quad,RGB,RGBA,Triangle,TriangleMesh,Vec2,Vec3,Vec4,Vertex,VertexSoup,type,_ref,_ref1,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};_ref=require("./colour"),RGBA=_ref.RGBA,RGB=_ref.RGB;_ref1=require("./math"),Matrix4=_ref1.Matrix4,Vec2=_ref1.Vec2,Vec3=_ref1.Vec3,Vec4=_ref1.Vec4;Geometry=function(){function Geometry(){var gl;this.v=[];gl=CoffeeGL.Context.gl;this.layout=gl.TRIANGLES;this.flat=false;this.faces=[]}Geometry.prototype._addToNode=function(node){node.geometry=this;return this};Geometry.prototype.flatten=function(){var t,vertex,_i,_len,_ref2;t=[];_ref2=this.v;for(_i=0,_len=_ref2.length;_i<_len;_i++){vertex=_ref2[_i];t.concat(vertex.flatten())}return t};return Geometry}();Vertex=function(){function Vertex(p,c,n,t,tangent){this.p=p;this.c=c;this.n=n;this.t=t;this.tangent=tangent;if(this.p==null){this.p=new Vec3(0,0,0)}if(this.p instanceof Vec2){this.p=new Vec3(this.p.x,this.p.y,0)}}Vertex.prototype.flatten=function(){var t;t=[];t.concat(this.p.flatten());if(this.c!=null){t.concat(this.c.flatten())}if(this.n!=null){t.concat(this.n.flatten())}if(this.t!=null){t.concat(this.t.flatten())}if(this.tangent!=null){t.concat(this.tangent.flatten())}return t};return Vertex}();type=function(obj){var classToType,myClass,name,_i,_len,_ref2;if(obj===void 0||obj===null){return String(obj)}classToType=new Object;_ref2="Boolean Number String Function Array Date";for(_i=0,_len=_ref2.length;_i<_len;_i++){name=_ref2[_i];RegExp.split(" ")}myClass=Object.prototype.toString.call(obj);if(myClass in classToType){return classToType(myClass)}return"object"};Triangle=function(_super){__extends(Triangle,_super);function Triangle(p0,p1,p2,n){this.n=n;Triangle.__super__.constructor.call(this);if(p0==null||p1==null||p2==null){this.v=[new Vertex(new Vec3(-1,-1,0)),new Vertex(new Vec3(1,-1,0)),new Vertex(new Vec3(0,1,0))]}else{this.v=[p0,p1,p2]}if(this.n==null){this.computeFaceNormal()}}Triangle.prototype.flatten=function(){var t;t=[];t=t.concat(this.v[0].flatten());t=t.concat(this.v[1].flatten());t=t.concat(this.v[2].flatten());return t};Triangle.prototype.computeFaceNormal=function(){var l0,l1;l0=Vec3.sub(this.v[1].p,this.v[0].p);l1=Vec3.sub(this.v[2].p,this.v[1].p);this.n=l0.cross(l1);this.n.normalize();return this};return Triangle}(Geometry);Quad=function(_super){__extends(Quad,_super);function Quad(p0,p1,p2,p3,n){var gl;this.n=n;Quad.__super__.constructor.call(this);if(p0==null||p1==null||p2==null||p3==null){p0=new Vertex(new Vec3(-1,1,0),new RGBA(1,1,1,1),new Vec3(0,0,1),new Vec2(0,1));p1=new Vertex(new Vec3(-1,-1,0),new RGBA(1,1,1,1),new Vec3(0,0,1),new Vec2(0,0));p2=new Vertex(new Vec3(1,1,0),new RGBA(1,1,1,1),new Vec3(0,0,1),new Vec2(1,1));p3=new Vertex(new Vec3(1,-1,0),new RGBA(1,1,1,1),new Vec3(0,0,1),new Vec2(1,0))}this.v=[p0,p1,p2,p3];gl=CoffeeGL.Context.gl;this.layout=gl.TRIANGLE_STRIP;if(this.n==null){this.computeFaceNormal()}}Quad.prototype.computeFaceNormal=function(){var l0,l1;l0=Vec3.sub(this.v[1].p,this.v[0].p);l1=Vec3.sub(this.v[2].p,this.v[1].p);this.n=l0.cross(l1);this.n.normalize();return this};Quad.prototype.flatten=function(){var t;t=[];t=t.concat(this.v[0].flatten());t=t.concat(this.v[1].flatten());t=t.concat(this.v[2].flatten());t=t.concat(this.v[3].flatten());return t};return Quad}(Geometry);VertexSoup=function(_super){__extends(VertexSoup,_super);function VertexSoup(vertex_list){var gl;VertexSoup.__super__.constructor.call(this);gl=CoffeeGL.Context.gl;this.layout=gl.POINTS;this.v=vertex_list}return VertexSoup}(Geometry);TriangleMesh=function(_super){__extends(TriangleMesh,_super);function TriangleMesh(indexed){this.indexed=indexed;TriangleMesh.__super__.constructor.call(this);this.v=[];this.faces=[];if(this.indexed!=null===true){this.indices=[]}}TriangleMesh.prototype.addTriangle=function(t){var idx,p,ti,v,_i,_j,_len,_ref2;if(this.indices){for(idx=_i=0;_i<=2;idx=++_i){p=this._findV(t.v[idx]);if(p===-1){this.v.push(t.v[idx]);ti=this.v.length;ti-=1;t.v[idx]._idx=ti;this.indices.push(ti)}else{this.indices.push(p)}}}else{_ref2=t.v;for(_j=0,_len=_ref2.length;_j<_len;_j++){v=_ref2[_j];this.v.push(v)}}this.faces.push(t);return this};TriangleMesh.prototype.addVertex=function(v){this.v.push(v);return this};TriangleMesh.prototype.addIndex=function(idx){if(typeof indices!=="undefined"&&indices!==null){return indices.push(idx)}};TriangleMesh.prototype.addQuad=function(q){var i,idx,p,ti,_i,_j,_k,_l,_len,_len1,_len2,_len3,_ref2,_ref3,_ref4,_ref5;if(this.indices){_ref2=[0,1,3];for(_i=0,_len=_ref2.length;_i<_len;_i++){idx=_ref2[_i];p=this._findV(q.v[idx]);if(p===-1){this.v.push(q.v[idx]);ti=this.v.length;ti-=1;q.v[idx]._idx=ti;this.indices.push(ti)}else{this.indices.push(p)}}_ref3=[2,3,1];for(_j=0,_len1=_ref3.length;_j<_len1;_j++){idx=_ref3[_j];p=this._findV(q.v[idx]);if(p===-1){this.v.push(q.v[idx]);ti=this.v.length;ti-=1;q.v[idx]._idx=ti;this.indices.push(ti)}else{this.indices.push(p)}}}else{_ref4=[0,1,3];for(_k=0,_len2=_ref4.length;_k<_len2;_k++){i=_ref4[_k];this.v.push(q.v[i])}_ref5=[2,3,1];for(_l=0,_len3=_ref5.length;_l<_len3;_l++){i=_ref5[_l];this.v.push(q.v[i])}}this.faces.push(new Triangle(q.v[0],q.v[1],q.v[3]));this.faces.push(new Triangle(q.v[2],q.v[3],q.v[1]));return this};TriangleMesh.prototype._findV=function(vf){var idx,_i,_ref2;if(vf._idx!=null){return vf._idx}if(this.v.length>0){for(idx=_i=0,_ref2=this.v.length-1;0<=_ref2?_i<=_ref2:_i>=_ref2;idx=0<=_ref2?++_i:--_i){if(this.v[idx]===vf){return idx}}}return-1};return TriangleMesh}(Geometry);Plane=function(_super){__extends(Plane,_super);function Plane(xres,zres){var i,j,row,row2,x,xp,xt,z,zp,zt,_i,_j,_k,_l,_ref2,_ref3,_ref4,_ref5;this.xres=xres!=null?xres:1;this.zres=zres!=null?zres:1;Plane.__super__.constructor.call(this);this.v=[];this.faces=[];this.indexed=true;this.indices=[];for(i=_i=0,_ref2=zres-1;0<=_ref2?_i<=_ref2:_i>=_ref2;i=0<=_ref2?++_i:--_i){for(j=_j=0,_ref3=xres-1;0<=_ref3?_j<=_ref3:_j>=_ref3;j=0<=_ref3?++_j:--_j){xp=-1+2/xres*j;zp=-1+2/zres*i;xt=1/xres*j;zt=1/zres*i;this.v.push(new Vertex(new Vec3(xp,0,zp),new RGBA(1,1,1,1),new Vec3(0,1,0),new Vec2(xt,zt)))}}for(z=_k=0,_ref4=zres-2;0<=_ref4?_k<=_ref4:_k>=_ref4;z=0<=_ref4?++_k:--_k){for(x=_l=0,_ref5=xres-2;0<=_ref5?_l<=_ref5:_l>=_ref5;x=0<=_ref5?++_l:--_l){row=xres*z;row2=xres*(z+1);this.indices.push(row+x);this.indices.push(row2+x);this.indices.push(row+x+1);this.indices.push(row+x+1);this.indices.push(row2+x);this.indices.push(row2+x+1);this.faces.push(new Quad(this.v[row2+x],this.v[row2+x+1],this.v[row+x+1],this.v[row+x]))}}}return Plane}(Geometry);PlaneFlat=function(_super){__extends(PlaneFlat,_super);function PlaneFlat(xres,zres){var i,idc,idn,idt,idv,idx,j,tt,xp,xt,zp,zt,_i,_j,_k,_l,_m,_ref2,_ref3,_ref4,_ref5,_ref6;this.xres=xres!=null?xres:2;this.zres=zres!=null?zres:2;PlaneFlat.__super__.constructor.call(this);tt=xres*zres;this.v=new Float32Array(tt*3);this.t=new Float32Array(tt*2);this.n=new Float32Array(tt*3);this.c=new Float32Array(tt*4);this.i=new Uint16Array(xres*(zres-1)*2);this.indexed=true;this.flat=true;this.layout=GL.TRIANGLE_STRIP;idv=0;idt=0;idc=0;idn=0;idx=0;for(i=_i=0,_ref2=zres-1;0<=_ref2?_i<=_ref2:_i>=_ref2;i=0<=_ref2?++_i:--_i){for(j=_j=0,_ref3=xres-1;0<=_ref3?_j<=_ref3:_j>=_ref3;j=0<=_ref3?++_j:--_j){xp=-1+2/xres*j;zp=-1+2/zres*i;this.v[idv++]=xp;this.v[idv++]=0;this.v[idv++]=zp;xt=1/xres*j;zt=1/zres*i;this.t[idt++]=xt;this.t[idt++]=zt;this.c[idc++]=1;this.c[idc++]=1;this.c[idc++]=1;this.c[idc++]=1;this.n[idn++]=0;this.n[idn++]=1;this.n[idn++]=0}}for(i=_k=0,_ref4=zres-2;0<=_ref4?_k<=_ref4:_k>=_ref4;i=0<=_ref4?++_k:--_k){if(i%2===0){for(j=_l=0,_ref5=xres-1;0<=_ref5?_l<=_ref5:_l>=_ref5;j=0<=_ref5?++_l:--_l){this.i[idx++]=xres*i+j;this.i[idx++]=xres*(i+1)+j}}else{for(j=_m=_ref6=xres-1;_ref6<=0?_m<=0:_m>=0;j=_ref6<=0?++_m:--_m){this.i[idx++]=xres*(i+1)+j;this.i[idx++]=xres*i+j}}}}return PlaneFlat}(Geometry);module.exports={Geometry:Geometry,Vertex:Vertex,Triangle:Triangle,Quad:Quad,TriangleMesh:TriangleMesh,Plane:Plane,PlaneFlat:PlaneFlat,VertexSoup:VertexSoup}}).call(this)},{"./colour":4,"./math":3}],6:[function(require,module,exports){(function(){var Camera,Geometry,Material,Matrix3,Matrix4,Node,PointLight,Texture,Vec3,Vec4,makeNodeDrawableGL,util,_ref,__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++){if(i in this&&this[i]===item)return i}return-1};_ref=require("./math"),Vec3=_ref.Vec3,Vec4=_ref.Vec4,Matrix3=_ref.Matrix3,Matrix4=_ref.Matrix4;makeNodeDrawableGL=require("./webgl").makeNodeDrawableGL;Camera=require("./camera").Camera;Material=require("./material").Material;Texture=require("./texture").Texture;PointLight=require("./Light").PointLight;Geometry=require("./primitives").Geometry;util=require("./util");Node=function(){function Node(geometry,material,textures,shader,pointLights){this.geometry=geometry;this.material=material;this.textures=textures;this.shader=shader;this.pointLights=pointLights;this.matrix=new Matrix4;this._modelMatrix=new Matrix4;this._normalMatrix=new Matrix3;this._mvpMatrix=new Matrix4;this.children=[];this.skip_draw=false;this.descend=true;if(this.pointLights==null){this.pointLights=[];this.pointLightsGlobal=[];this.numPointLights=0}if(this.textures==null){this.textures=[]}}Node.prototype.add=function(p){if(typeof p._addToNode==="function"){p._addToNode(this)}return this};Node.prototype.remove=function(p){if(typeof p._removeFromNode==="function"){p._removeFromNode(this)}return this};Node.prototype._addToNode=function(node){node.children.push(this);return this};Node.prototype.copy=function(){return util.clone(this)};Node.prototype.del=function(p){var i;if(__indexOf.call(this.children,p)>=0){i=this.children.indexOf(p);this.children.splice(i,1)}return this};Node.prototype._removeFromNode=function(node){node.del(this);return this};Node.prototype.draw=function(){var front;front={_modelMatrix:new Matrix4,_pointLightsGlobal:[],_normalMatrix:new Matrix4,_mvpMatrix:new Matrix4,_camera:void 0,_shader:void 0};return this._draw(this,front)};Node.prototype._draw=function(node,front){var child,cloned,light,newlight,nm,tex,_i,_j,_k,_l,_len,_len1,_len2,_len3,_ref1,_ref2,_ref3,_ref4;_ref1=node.textures;for(_i=0,_len=_ref1.length;_i<_len;_i++){tex=_ref1[_i];tex.bind()}front._modelMatrix=Matrix4.mult(front._modelMatrix,node.matrix);nm=node._modelMatrix.copy();if(node.camera!=null){front._camera=node.camera;node.camera.update()}if(front._camera!=null){nm=Matrix4.mult(front._camera.m,nm);front._mvpMatrix.copyFrom(nm);front._mvpMatrix.mult(front._camera.m);front._mvpMatrix.mult(front._camera.p)}else{front._mvpMatrix.copyFrom(nm)}front._normalMatrix=nm.getMatrix3().invert().transpose();if(node.pointLights!=null){_ref2=node.pointLights;for(_j=0,_len1=_ref2.length;_j<_len1;_j++){light=_ref2[_j];newlight=util.clone(light);front._modelMatrix.multVec(newlight.pos);front._pointLightsGlobal.push(newlight)}front._numPointLightsGlobal=front._pointLightsGlobal.length}front._shader=node.shader;if(node.material!=null){front._material=node.material}if(node.drawGL==null){makeNodeDrawableGL(node);if(node.geometry!=null){if(!node.geometry.brewed){node.brew()}}}node=util.extend(node,front);if(!node.skip_draw){node.drawGL()}if(node.descend){_ref3=node.children;for(_k=0,_len2=_ref3.length;_k<_len2;_k++){child=_ref3[_k];cloned={_modelMatrix:new Matrix4(front._modelMatrix),_mvpMatrix:front._mvpMatrix,_pointLightsGlobal:[],_normalMatrix:new Matrix4,_camera:front._camera,_material:front._material,_shader:front._shader};cloned._pointLightsGlobal=cloned._pointLightsGlobal.concat(front._pointLightsGlobal);this._draw(child,cloned)}}_ref4=node.textures;for(_l=0,_len3=_ref4.length;_l<_len3;_l++){tex=_ref4[_l];tex.unbind()}return node};return Node}();module.exports={Node:Node}}).call(this)},{"./math":3,"./webgl":14,"./camera":12,"./material":19,"./texture":11,"./Light":26,"./primitives":5,"./util":15}],7:[function(require,module,exports){(function(){var CoffeeGLWarning,JSONModel,LoadItem,LoadQueue,Material,Matrix4,Node,Quad,RGB,RGBA,Request,Signal,Texture,Triangle,TriangleMesh,Vec2,Vec3,Vec4,Vertex,_ref,_ref1,_ref2,_ref3,__bind=function(fn,me){return function(){return fn.apply(me,arguments)
}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};_ref=require("./primitives"),Triangle=_ref.Triangle,Quad=_ref.Quad,Vertex=_ref.Vertex,TriangleMesh=_ref.TriangleMesh;Node=require("./node").Node;_ref1=require("./math"),Vec2=_ref1.Vec2,Vec3=_ref1.Vec3,Vec4=_ref1.Vec4,Matrix4=_ref1.Matrix4;Material=require("./material").Material;_ref2=require("./colour"),RGB=_ref2.RGB,RGBA=_ref2.RGBA;Texture=require("./texture").Texture;Request=require("./request").Request;Signal=require("./signal").Signal;CoffeeGLWarning=require("./error").CoffeeGLWarning;_ref3=require("./loader"),LoadItem=_ref3.LoadItem,LoadQueue=_ref3.LoadQueue;JSONModel=function(_super){__extends(JSONModel,_super);JSONModel.prototype._bitset=function(value,position){return value&1<<position};function JSONModel(json_data,params){var cc,closure_parse,colourAmbient,colourDiffuse,colourSpecular,i,materials,model,n,path,specularCoef,tf,url,_i,_ref4;this.params=params;this._parse=__bind(this._parse,this);JSONModel.__super__.constructor.call(this);if(this.params==null){this.params={};this.params.texturing=true}else{if(this.params.texturing==null){this.params.texturing=true}}this.queue=new LoadQueue(this,this.params.onItem,this.params.onLoad);materials=json_data["materials"];if(materials.length===0){this.add(new Node(new TriangleMesh(true)))}else{for(i=_i=0,_ref4=materials.length-1;0<=_ref4?_i<=_ref4:_i>=_ref4;i=0<=_ref4?++_i:--_i){n=new Node;this.add(n);if(json_data["materials"][i]["DbgName"]!=null){n.dbgName=json_data["materials"][i]["DbgName"]}if(json_data["materials"][i]["DbgName"]==="default"||json_data["materials"][i]["DbgIndex"]===1){n.add(new Material)}else{colourAmbient=new RGB(json_data["materials"][i]["colorAmbient"][0],json_data["materials"][i]["colorAmbient"][1],json_data["materials"][i]["colorAmbient"][2]);if(colourAmbient==null){colourAmbient=RGB.WHITE()}colourDiffuse=new RGB(json_data["materials"][i]["colorDiffuse"][0],json_data["materials"][i]["colorDiffuse"][1],json_data["materials"][i]["colorDiffuse"][2]);if(colourDiffuse==null){colourDiffuse=RGB.WHITE()}colourSpecular=new RGB(json_data["materials"][i]["colorSpecular"][0],json_data["materials"][i]["colorSpecular"][1],json_data["materials"][i]["colorSpecular"][2]);if(colourSpecular==null){colourSpecular=RGB.WHITE()}specularCoef=json_data["materials"][i]["specularCoef"];n.add(new Material(colourAmbient,colourDiffuse,colourSpecular,specularCoef))}n.geometry=new TriangleMesh(true);if(this.params.texturing){if(json_data["materials"][i]["mapDiffuse"]!=null&&json_data._coffeegl_request_url!=null){url=json_data._coffeegl_request_url.substring(0,json_data._coffeegl_request_url.lastIndexOf("/"));path=url+"/"+json_data["materials"][i]["mapDiffuse"];cc=CoffeeGL.Context;tf=new LoadItem(function(n,path){var _cc,_n,_path;_n=n;_path=path;_cc=cc;return function(){var t,_this=this;CoffeeGL.Context.switchContext(_cc);return t=new Texture(_path,{},function(){_n.add(t);_this.loaded();return _this})};return this}(n,path));this.queue.add(tf)}}}}cc=CoffeeGL.Context;model=this;closure_parse=function(n,model){var data,_cc,_model,_this=this;data=json_data;_model=model;_cc=cc;return function(){CoffeeGL.Context.switchContext(_cc);return _model._parse(data)}}(n,model);this.queue.add(new LoadItem(function(){closure_parse();return this.loaded()}));this.queue.start()}JSONModel.prototype._parse=function(json_data){var child,cidx,i,i0,i1,i2,i3,midx,nidx,node_idx,prim,removals,type,type2,uvidx,vertices,vi0,vi1,vi2,vi3,vidx,_i,_j,_len,_len1,_ref4;node_idx=0;vidx=0;vertices=[];while(vidx<json_data["vertices"].length){vertices.push(new Vertex(new Vec3(json_data["vertices"][vidx++],json_data["vertices"][vidx++],json_data["vertices"][vidx++])))}i=0;while(i<json_data["faces"].length){type=json_data["faces"][i++];prim;vi0;vi1;vi2;vi3;midx={id:0,type:-1};if(this._bitset(type,0)){vi0=json_data["faces"][i++];vi1=json_data["faces"][i++];vi2=json_data["faces"][i++];vi3=json_data["faces"][i++];prim=new Quad(vertices[vi0],vertices[vi1],vertices[vi2],vertices[vi3])}else{vi0=json_data["faces"][i++];vi1=json_data["faces"][i++];vi2=json_data["faces"][i++];prim=new Triangle(vertices[vi0],vertices[vi1],vertices[vi2])}if(this._bitset(type,1)){midx.id=json_data["faces"][i++];type2=type|1;if(midx.type===-1){midx.type=type2}else{if(type2!==midx.type){CoffeeGLWarning("Different types within the same material")}}}if(this._bitset(type,2)){uvidx=json_data["faces"][i++]}if(this._bitset(type,3)){i0=json_data["faces"][i++];i1=json_data["faces"][i++];i2=json_data["faces"][i++];if(prim instanceof Quad){i3=json_data["faces"][i++];vertices[vi3].t=new Vec2(json_data["uvs"][0][i3*2],json_data["uvs"][0][i3*2+1])}vertices[vi0].t=new Vec2(json_data["uvs"][0][i0*2],json_data["uvs"][0][i0*2+1]);vertices[vi1].t=new Vec2(json_data["uvs"][0][i1*2],json_data["uvs"][0][i1*2+1]);vertices[vi2].t=new Vec2(json_data["uvs"][0][i2*2],json_data["uvs"][0][i2*2+1])}if(this._bitset(type,4)){nidx=json_data["faces"][i++]}if(this._bitset(type,5)){i0=json_data["faces"][i++];i1=json_data["faces"][i++];i2=json_data["faces"][i++];if(prim instanceof Quad){i3=json_data["faces"][i++];vertices[vi3].n=new Vec3(json_data["normals"][i3*3],json_data["normals"][i3*3+1],json_data["normals"][i3*3+2])}vertices[vi0].n=new Vec3(json_data["normals"][i0*3],json_data["normals"][i0*3+1],json_data["normals"][i0*3+2]);vertices[vi1].n=new Vec3(json_data["normals"][i1*3],json_data["normals"][i1*3+1],json_data["normals"][i1*3+2]);vertices[vi2].n=new Vec3(json_data["normals"][i2*3],json_data["normals"][i2*3+1],json_data["normals"][i2*3+2])}if(this._bitset(type,6)){cidx=json_data["faces"][i++]}if(this._bitset(type,7)){i0=json_data["faces"][i++];i1=json_data["faces"][i++];i2=json_data["faces"][i++];if(prim instanceof Quad){i3=json_data["faces"][i++]}}if(prim instanceof Triangle){this.children[midx.id].geometry.addTriangle(prim)}else{this.children[midx.id].geometry.addQuad(prim)}}removals=[];_ref4=this.children;for(_i=0,_len=_ref4.length;_i<_len;_i++){child=_ref4[_i];if(child.geometry!=null){if(child.geometry.v.length===0){removals.push(child)}}}for(_j=0,_len1=removals.length;_j<_len1;_j++){child=removals[_j];this.remove(child)}return this};return JSONModel}(Node);module.exports={JSONModel:JSONModel}}).call(this)},{"./primitives":5,"./node":6,"./math":3,"./material":19,"./colour":4,"./texture":11,"./request":9,"./signal":16,"./error":20,"./loader":27}],8:[function(require,module,exports){(function(){var CoffeeGLError,CoffeeGLLog,CoffeeGLWarning,Contract,Light,Matrix4,Shader,ShaderLibrary,Vec2,Vec3,Vec4,_ref,_ref1;_ref=require("./math"),Matrix4=_ref.Matrix4,Vec2=_ref.Vec2,Vec3=_ref.Vec3,Vec4=_ref.Vec4;Light=require("./light").Light;ShaderLibrary=require("./shader_library").ShaderLibrary;_ref1=require("./error"),CoffeeGLError=_ref1.CoffeeGLError,CoffeeGLWarning=_ref1.CoffeeGLWarning,CoffeeGLLog=_ref1.CoffeeGLLog;Contract=function(){function Contract(attributes,uniforms,textures){this.attributes=attributes;this.uniforms=uniforms;this.textures=textures;if(this.attributes==null){this.attributes=[]}if(this.uniforms==null){this.uniforms=[]}if(this.textures==null){this.textures=[]}}Contract.prototype.setUniformRole=function(uniform,role){var u,_i,_len,_ref2;_ref2=this.uniforms;for(_i=0,_len=_ref2.length;_i<_len;_i++){u=_ref2[_i];if(u.name===uniform){u.role=role}}return this};Contract.prototype.setAttributeRole=function(attribute,role){var a,_i,_len,_ref2;_ref2=this.attributes;for(_i=0,_len=_ref2.length;_i<_len;_i++){a=_ref2[_i];if(a.name===attribute){a.role=role}}return this};return Contract}();Shader=function(){function Shader(s,roles){var gl,main_block,main_position,match,matches,type,_i,_j,_len,_len1;this._splitShader(s);if(this.sv==null){CoffeeGLError("No Vertex Shader Provided");return}if(this.sf==null){CoffeeGLError("No Fragment Shader Provided");return}if(CoffeeGL.Context==null){CoffeeGLError("No Context for Shader Provided");return}gl=CoffeeGL.Context.gl;matches=this.sv.match(/\{\{(ShaderLibrary\.[a-zA-Z]+)\}\}/g);main_block="";if(matches!=null){for(_i=0,_len=matches.length;_i<_len;_i++){match=matches[_i];type=match.replace("}}","").split(".")[1];if(ShaderLibrary[type]==null){this.sv=this.sv.replace(match,"")}else if(ShaderLibrary[type].vertex!=null){if(ShaderLibrary[type].vertex.head!=null){this.sv=this.sv.replace(match,ShaderLibrary[type].vertex.head)}if(ShaderLibrary[type].vertex.main!=null){main_block+=ShaderLibrary[type].vertex.main+"\n"}}else{this.sv=this.sv.replace(match,"")}}}main_position=this.sv.indexOf("\n",this.sv.indexOf("void main"));this.sv=this.sv.slice(0,main_position)+main_block+this.sv.slice(main_position);matches=this.sf.match(/\{\{(ShaderLibrary\.[a-zA-Z]+)\}\}/g);main_block="";if(matches!=null){for(_j=0,_len1=matches.length;_j<_len1;_j++){match=matches[_j];type=match.replace("}}","").split(".")[1];if(ShaderLibrary[type]==null){this.sf=this.sf.replace(match,"")}else if(ShaderLibrary[type].fragment!=null){if(ShaderLibrary[type].fragment.head!=null){this.sf=this.sf.replace(match,ShaderLibrary[type].fragment.head)}if(ShaderLibrary[type].fragment.main!=null){main_block+=ShaderLibrary[type].fragment.main}}else{this.sf=this.sf.replace(match,"")}}}main_position=this.sv.indexOf("\n",this.sv.indexOf("void main"));this.sf=this.sf.slice(0,main_position)+main_block+this.sf.slice(main_position);this.sv=this.sv.replace(/;(?! [a-zA-Z0-9])/g,";");this.sv=this.sv.replace(/\{/g,"{");this.sv=this.sv.replace(/\}/g,"}");this.sf=this.sf.replace(/;(?! [a-zA-Z0-9])/g,";");this.sf=this.sf.replace(/;(?! [a-zA-Z0-9])/g,";");this.sf=this.sf.replace(/\{/g,"{");this.sf=this.sf.replace(/\}/g,"}");this.compile(roles)}Shader.prototype.compile=function(roles){var attr,attrs,compilationLog,gl,idx,l,ln,success,tsf,_i,_j,_k,_len,_len1,_len2,_ref2,_ref3;gl=CoffeeGL.Context.gl;this.vertexShader=gl.createShader(gl.VERTEX_SHADER);if(!this.vertexShader){CoffeeGLError("No vertex shader object could be created")}this.fragmentShader=gl.createShader(gl.FRAGMENT_SHADER);if(!this.fragmentShader){CoffeeGLError("No Fragment shader object could be created")}gl.shaderSource(this.vertexShader,this.sv);gl.compileShader(this.vertexShader);if(!gl.getShaderParameter(this.vertexShader,gl.COMPILE_STATUS)){compilationLog=gl.getShaderInfoLog(this.vertexShader);CoffeeGLLog("Shader compiler log: "+compilationLog);tsf="";ln=1;_ref2=this.sv.split("\n");for(_i=0,_len=_ref2.length;_i<_len;_i++){l=_ref2[_i];tsf+=ln+": "+l+"\n";ln++}CoffeeGLLog(tsf);this._splitError(compilationLog,this.sv);CoffeeGLError("Could not compile vertex shader")}gl.shaderSource(this.fragmentShader,this.sf);gl.compileShader(this.fragmentShader);if(!gl.getShaderParameter(this.fragmentShader,gl.COMPILE_STATUS)){compilationLog=gl.getShaderInfoLog(this.fragmentShader);CoffeeGLLog("Shader compiler log: "+compilationLog);tsf="";ln=1;_ref3=this.sf.split("\n");for(_j=0,_len1=_ref3.length;_j<_len1;_j++){l=_ref3[_j];tsf+=ln+": "+l+"\n";ln++}CoffeeGLLog(tsf);this._splitError(compilationLog,this.sf);CoffeeGLError("Could not compile fragment shader")}this.shaderProgram=gl.createProgram();attrs=this._parseShader("attribute");idx=0;for(_k=0,_len2=attrs.length;_k<_len2;_k++){attr=attrs[_k];gl.bindAttribLocation(this.shaderProgram,idx,attr.name);idx++}gl.attachShader(this.shaderProgram,this.vertexShader);gl.attachShader(this.shaderProgram,this.fragmentShader);gl.linkProgram(this.shaderProgram);success=gl.getProgramParameter(this.shaderProgram,gl.LINK_STATUS);if(!success){CoffeeGLWarning(gl.getProgramInfoLog(this.shaderProgram));CoffeeGLError("Failed to Link Shader")}this._makeContract(roles);return this};Shader.prototype._addToNode=function(node){node.shader=this;return this};Shader.prototype._splitError=function(s,data){var datalines,fileno,line,lineno,lines,match,message,_i,_len;lines=s.split("\n");for(_i=0,_len=lines.length;_i<_len;_i++){line=lines[_i];match=line.match(/ERROR: (\d+):(\d+): (.*)/);if(match){fileno=parseInt(match[1],10)-1;lineno=parseInt(match[2],10)-1;message=match[3];datalines=data.split("\n");CoffeeGLLog("Shader Error Log: "+fileno+", "+lineno+", "+message+","+datalines[lineno])}}return this};Shader.prototype._splitShader=function(s){var pf,pv;pv=s.indexOf("##>VERTEX");pf=s.indexOf("##>FRAGMENT");if(pv<pf){this.sv=s.slice(pv+9,pf);this.sf=s.slice(pf+11)}else{this.sf=s.slice(pf+11,pv);this.sv=s.slice(pv+9)}return this};Shader.prototype._getLocation=function(name){var gl;gl=CoffeeGL.Context.gl;return gl.getUniformLocation(this.shaderProgram,name)};Shader.prototype.bind=function(){var gl;gl=CoffeeGL.Context.gl;gl.useProgram(this.shaderProgram);CoffeeGL.Context.shader=this;return this};Shader.prototype.unbind=function(){var gl;gl=CoffeeGL.Context.gl;gl.useProgram(null);return this};Shader.prototype.washUp=function(){var gl;gl=CoffeeGL.Context.gl;gl.detachShader(this.shaderProgram,this.vertexShader);gl.detachShader(this.shaderProgram,this.fragmentShader);gl.deleteProgram(this.shaderProgram);gl.deleteShader(this.vertexShader);gl.deleteShader(this.fragmentShader);return this};Shader.prototype._makeContract=function(user_roles){var key,role,roles;this.contract=new Contract(this._getAttributes(),this._getUniforms(),this._getTextures());roles={};roles.uModelMatrix="_modelMatrix";roles.uMVPMatrix="_mvpMatrix";roles.uProjectionMatrix="_camera/p";roles.uCameraMatrix="_camera/m";roles.uCameraInverseMatrix="_camera/i";roles.uInverseProjectionMatrix="_camera/ip";roles.uNormalMatrix="_normalMatrix";roles.uMaterialAmbientColor="_material/ambient";roles.uMaterialDiffuseColor="_material/diffuse";roles.uMaterialSpecularColor="_material/specular";roles.uMaterialShininess="_material/shine";roles.uMaterialEmissiveColor="_material/emissive";roles.uNumLights="_numPointLightsGlobal";roles.uPointLightPos="_pointLightsGlobal/pos";roles.uPointLightDiffuse="_pointLightsGlobal/colour";roles.uPointLightSpecular="_pointLightsGlobal/specular";roles.uPointLightAttenuation="_pointLightsGlobal/attenuation";roles.aVertexPosition="vertexPositionBuffer";roles.aVertexTexCoord="vertexTextureBuffer";roles.aVertexNormal="vertexNormalBuffer";roles.aVertexColour="vertexColourBuffer";roles.aVertexTangent="vertexTangentBuffer";roles.uCameraNear="_camera/near";roles.uCameraFar="_camera/far";if(user_roles!=null){for(key in user_roles){roles[key]=user_roles[key]}}for(role in roles){this.contract.setUniformRole(role,roles[role]);this.contract.setAttributeRole(role,roles[role])}return this};Shader.prototype._posForAttrRole=function(role){var a,_i,_len,_ref2;_ref2=this.contract.attributes;for(_i=0,_len=_ref2.length;_i<_len;_i++){a=_ref2[_i];if(a.role===role){return a.pos}}return-1};Shader.prototype._getAttributes=function(){var a,d,p,_i,_len;d=this._parseShader("attribute");for(_i=0,_len=d.length;_i<_len;_i++){a=d[_i];p=this.getAttribLocation(a.name);if(p!=null&&p!==-1){a.pos=p}}return d};Shader.prototype._getUniforms=function(){var a,d,p,_i,_len;d=this._parseShader("uniform");for(_i=0,_len=d.length;_i<_len;_i++){a=d[_i];p=this._getLocation(a.name);if(p!=null&&p!==-1){a.pos=p}}return d};Shader.prototype._getTextures=function(){var a,d,p,x,_i,_len;d=this._parseShader("uniform");x=[];for(_i=0,_len=d.length;_i<_len;_i++){a=d[_i];if(a.type==="sampler2D"){p=this._getLocation(a.name);if(p!=null&&p!==-1){a.pos=p;x.push(a)}}}return x};Shader.prototype._parseShader=function(token){var attr,data,finals,l,lines,matches,re,t,tokens,_i,_j,_len,_len1;data=[];lines=this.sv.split(";").concat(this.sf.split(";"));for(_i=0,_len=lines.length;_i<_len;_i++){l=lines[_i];re=RegExp("\\b"+token+"\\b");if(l.match(re)!=null){tokens=l.split(" ");finals=[];for(_j=0,_len1=tokens.length;_j<_len1;_j++){t=tokens[_j];t=t.replace(/\n/,"");t=t.replace(/\s/,"");if(t.length!==0){finals.push(t)}}finals.push(1);matches=finals[2].match(/\[([0-9]+)\]/);if(matches!=null){finals[3]=matches[1]}finals[2]=finals[2].match(/([a-zA-Z]+)/g)[0];if(finals.length===4){attr={};attr.name=finals[2];attr.type=finals[1];attr.role=attr.name;attr.pos=-1;attr.size=finals[3];data.push(attr)}}}return data};Shader.prototype.setUniform1f=function(name,a){var gl;gl=CoffeeGL.Context.gl;gl.uniform1f(this._getLocation(name),a);return this};Shader.prototype.setUniform1i=function(name,a){var gl;gl=CoffeeGL.Context.gl;gl.uniform1i(this._getLocation(name),a);return this};Shader.prototype.setUniform1fv=function(name,a){var gl;gl=CoffeeGL.Context.gl;gl.uniform1fv(this._getLocation(name),a);return this};Shader.prototype.setUniform2fv=function(name,a){var gl;gl=CoffeeGL.Context.gl;gl.uniform2fv(this._getLocation(name),a);return this};Shader.prototype.setUniform2v=function(name,v){var gl;gl=CoffeeGL.Context.gl;gl.uniform2f(this._getLocation(name),v.x,v.y);return this};Shader.prototype.setUniform3f=function(name,a,b,c){var gl;gl=CoffeeGL.Context.gl;gl.uniform3f(this._getLocation(name),a,b,c);return this};Shader.prototype.setUniform3fv=function(name,a){var gl;gl=CoffeeGL.Context.gl;gl.uniform3fv(this._getLocation(name),a);return this};Shader.prototype.setUniform3v=function(name,v){var gl;gl=CoffeeGL.Context.gl;gl.uniform3f(this._getLocation(name),v.x,v.y,v.z);return this};Shader.prototype.setUniform3f=function(name,a,b,c){var gl;gl=CoffeeGL.Context.gl;gl.uniform3f(this._getLocation(name),a,b,c);return this};Shader.prototype.setUniform4f=function(name,a,b,c,d){var gl;gl=CoffeeGL.Context.gl;gl.uniform4f(this._getLocation(name),a,b,c,d);return this};Shader.prototype.setUniform4v=function(name,v){var gl;gl=CoffeeGL.Context.gl;gl.uniform4f(this._getLocation(name),v.x,v.y,v.z,v.w);return this};Shader.prototype.setUniform4fv=function(name,a){var gl;gl=CoffeeGL.Context.gl;gl.uniform4fv(this._getLocation(name),a);return this};Shader.prototype.setMatrix3f=function(name,m){var gl;gl=CoffeeGL.Context.gl;gl.uniformMatrix3fv(this._getLocation(name),false,m.a);return this};Shader.prototype.setMatrix4f=function(name,m){var gl;gl=CoffeeGL.Context.gl;gl.uniformMatrix4fv(this._getLocation(name),false,m.a);return this};Shader.prototype.enableAttribArray=function(name){var gl,position;gl=CoffeeGL.Context.gl;position=gl.getAttribLocation(this.shaderProgram,name);gl.enableVertexAttribArray(position);return this};Shader.prototype.getAttribLocation=function(name){var gl;gl=CoffeeGL.Context.gl;return gl.getAttribLocation(this.shaderProgram,name)};return Shader}();module.exports={Shader:Shader}}).call(this)},{"./math":3,"./light":17,"./shader_library":28,"./error":20}],9:[function(require,module,exports){(function(){var Request,Signal;Signal=require("./signal").Signal;Request=function(){function Request(url){this.url=url;this._context=CoffeeGL.Context}Request.prototype.get=function(callback){var _this=this;this.req=new XMLHttpRequest;this.req.onreadystatechange=function(){var data,l;if(_this.req.readyState===4){if(_this.req.status===200||_this.req.status===304){CoffeeGL.Context.switchContext(_this._context);l=_this.url.length-1;if(_this.url.indexOf("xml",l-3)>=0||_this.url.indexOf("js",l-2)>=0||_this.url.indexOf("json",l-2)>=0){data=eval("("+_this.req.responseText+")");data._coffeegl_request_url=_this.url;callback(data)}else{callback(_this.req.responseText)}}}return _this};this.req.open("GET",this.url);this.req.setRequestHeader("X-Requested-With","XMLHttpRequest");this.req.send(null);return this};return Request}();module.exports={Request:Request}}).call(this)},{"./signal":16}],10:[function(require,module,exports){(function(){var CoffeeGLDebug,CoffeeGLError,Fbo,RGB,RGBA,TextureBase,Vec2,_ref,_ref1;_ref=require("./error"),CoffeeGLError=_ref.CoffeeGLError,CoffeeGLDebug=_ref.CoffeeGLDebug;_ref1=require("./colour"),RGB=_ref1.RGB,RGBA=_ref1.RGBA;Vec2=require("./math").Vec2;TextureBase=require("./texture").TextureBase;Fbo=function(){function Fbo(width,height,channels,datatype,depth){var gl;this.width=width;this.height=height;this.channels=channels;this.datatype=datatype;this.depth=depth;gl=CoffeeGL.Context.gl;if(!(this.width!=null&&this.height!=null)){this.width=CoffeeGL.Context.width;this.height=CoffeeGL.Context.height}if(this.channels==null){this.channels=gl.RGBA}if(this.datatype==null){this.datatype=gl.UNSIGNED_BYTE}if(this.depth==null){this.depth=true}this.framebuffer=gl.createFramebuffer();CoffeeGLDebug("Created an FBO  with dimensions: "+this.width+","+this.height);this._build()}Fbo.prototype.resize=function(w,h){if(w instanceof Vec2){this.width=w.x;this.height=w.y}else if(w!=null&&h!=null){this.width=w;this.height=h}else{return this}this._build();return this};Fbo.prototype._build=function(){var gl,params;gl=CoffeeGL.Context.gl;gl.bindFramebuffer(gl.FRAMEBUFFER,this.framebuffer);if(this.texture==null){params={min:gl.LINEAR,max:gl.LINEAR,wraps:gl.CLAMP_TO_EDGE,wrapt:gl.CLAMP_TO_EDGE,width:this.width,height:this.height,channels:this.channels,datatype:this.datatype};this.texture=new TextureBase(params);this.texture.build()}else{this.texture.bind();gl.texImage2D(gl.TEXTURE_2D,0,this.channels,this.width,this.height,0,this.channels,this.datatype,null)}this.renderbuffer=gl.createRenderbuffer();gl.bindRenderbuffer(gl.RENDERBUFFER,this.renderbuffer);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this.texture.texture,0);if(this.depth){gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,this.width,this.height);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,this.renderbuffer)}gl.bindRenderbuffer(gl.RENDERBUFFER,null);gl.bindFramebuffer(gl.FRAMEBUFFER,null);this.texture.unbind();if(gl.checkFramebufferStatus(gl.FRAMEBUFFER)!==gl.FRAMEBUFFER_COMPLETE){return CoffeeGLError("Failed to Create Framebuffer!")}};Fbo.prototype.bind=function(){var gl;gl=CoffeeGL.Context.gl;gl.bindFramebuffer(gl.FRAMEBUFFER,this.framebuffer);return gl.bindRenderbuffer(gl.RENDERBUFFER,this.renderbuffer)};Fbo.prototype.unbind=function(){var gl;gl=CoffeeGL.Context.gl;gl.bindFramebuffer(gl.FRAMEBUFFER,null);return gl.bindRenderbuffer(gl.RENDERBUFFER,null)};Fbo.prototype.clear=function(colour){var gl;gl=CoffeeGL.Context.gl;if(colour==null){gl.clearColor(0,0,0,0)}else{if(colour instanceof RGBA){gl.clearColor(colour.r,colour.g,colour.b,colour.a)}else if(colour instanceof RGB){gl.clearColor(colour.r,colour.g,colour.b,1)}}if(this.depth){return gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT)}else{return gl.clear(gl.COLOR_BUFFER_BIT)}};Fbo.prototype.washUp=function(){var gl;gl=CoffeeGL.Context.gl;gl.deleteFramebuffer(this.framebuffer);gl.deleteRenderbuffer(this.renderbuffer);gl.deleteTexture(this.texture.texture);return this};return Fbo}();module.exports={Fbo:Fbo}}).call(this)},{"./error":20,"./colour":4,"./math":3,"./texture":11}],11:[function(require,module,exports){(function(){var Request,Texture,TextureBase,TextureCube,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};Request=require("./request").Request;TextureBase=function(){function TextureBase(params){var gl;if(CoffeeGL.Context.gl==null){console.log("Error - no context or url provided for texture")}gl=CoffeeGL.Context.gl;if(params==null){params={}}this.loaded=false;this.unit=params.unit==null?0:params.unit;this.min=params.min==null?gl.LINEAR:params.min;this.max=params.max==null?gl.LINEAR:params.max;this.wraps=params.wraps==null?gl.CLAMP_TO_EDGE:params.wraps;this.wrapt=params.wrapt==null?gl.CLAMP_TO_EDGE:params.wrapt;this.width=params.width==null?512:params.width;this.height=params.height==null?512:params.height;this.channels=params.channels==null?gl.RGBA:params.channels;this.datatype=params.datatype==null?gl.UNSIGNED_BYTE:params.datatype;this.texture=gl.createTexture()}TextureBase.prototype._isPowerOfTwo=function(x){return(x&x-1)===0};TextureBase.prototype._nextHighestPowerOfTwo=function(x){var i;--x;i=1;while(i<32){x=x|x>>i;i<<=1}return x+1};TextureBase.prototype.build=function(passed_context){var context,gl;context=CoffeeGL.Context;if(passed_context!=null){context=passed_context}if(!context){return}gl=context.gl;gl.bindTexture(gl.TEXTURE_2D,this.texture);gl.texImage2D(gl.TEXTURE_2D,0,this.channels,this.width,this.height,0,this.channels,this.datatype,null);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,this.max);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,this.min);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,this.wraps);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,this.wrapt);gl.bindTexture(gl.TEXTURE_2D,null);this.loaded=true;return this};TextureBase.prototype.bind=function(){var gl;gl=CoffeeGL.Context.gl;if(gl!=null&&this.loaded){gl.activeTexture(gl.TEXTURE0+this.unit);gl.bindTexture(gl.TEXTURE_2D,this.texture)}return this};TextureBase.prototype.unbind=function(){var gl;gl=CoffeeGL.Context.gl;if(this.loaded&&gl!=null){gl.activeTexture(gl.TEXTURE0+this.unit);gl.bindTexture(gl.TEXTURE_2D,null)}return this};TextureBase.prototype.update=function(element){var gl;if(!this.loaded){this.build()}gl=CoffeeGL.Context.gl;gl.bindTexture(gl.TEXTURE_2D,this.texture);gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,true);return gl.texImage2D(gl.TEXTURE_2D,0,this.channels,this.channels,this.datatype,element)};TextureBase.prototype._addToNode=function(node){node.textures.push(this);return this};TextureBase.prototype._removeFromNode=function(node){node.textures.splice(node.textures.indexOf(this));return this};TextureBase.prototype.washUp=function(){var gl;gl=CoffeeGL.Context.gl;gl.deleteTexture(this.texure);return this};return TextureBase}();Texture=function(_super){__extends(Texture,_super);function Texture(url,params,callback){var gl,r,_this=this;this.url=url;this.callback=callback;Texture.__super__.constructor.call(this,params);if(this.url==null||CoffeeGL.Context.gl==null){console.log("Error - no context or url provided for texture")}gl=CoffeeGL.Context.gl;r=new Request(this.url);r.get(function(){var cc;_this.texImage=new Image;_this.texImage.src=_this.url;cc=CoffeeGL.Context;return _this.texImage.onload=function(){CoffeeGL.Context.switchContext(cc);_this.width=_this.texImage.width;_this.height=_this.texImage.height;_this.build(_this.texImage);_this.loaded=true;return typeof _this.callback==="function"?_this.callback():void 0}})}Texture.prototype.build=function(texImage,passed_context){var context,gl;context=CoffeeGL.Context;if(passed_context!=null){context=passed_context}if(!context){return}gl=context.gl;gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,true);gl.bindTexture(gl.TEXTURE_2D,this.texture);gl.texImage2D(gl.TEXTURE_2D,0,this.channels,this.channels,this.datatype,texImage);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,this.min);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,this.max);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,this.wraps);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,this.wrapt);return gl.bindTexture(gl.TEXTURE_2D,null)};Texture;return Texture}(TextureBase);TextureCube=function(_super){__extends(TextureCube,_super);function TextureCube(paths,params){var cc,i,loadedTextures,_i,_this=this;this.paths=paths;TextureCube.__super__.constructor.call(this,params);if(this.paths==null||CoffeeGL.Context==null){console.log("Error - no context or urls provided for texture")}this.texImages=[];loadedTextures=0;for(i=_i=0;_i<=5;i=++_i){this.texImages[i]=new Image;this.texImages[i].cubeID=i;cc=CoffeeGL.Context;this.texImages[i].onload=function(){var gl,j,_j;CoffeeGL.Context.switchContext(cc);gl=CoffeeGL.Context.gl;loadedTextures++;if(loadedTextures===6){gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,true);gl.bindTexture(gl.TEXTURE_CUBE_MAP,_this.texture);gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_MAG_FILTER,_this.max);gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_MIN_FILTER,_this.min);gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_WRAP_S,_this.wraps);gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_WRAP_T,_this.wrapt);for(j=_j=0;_j<=5;j=++_j){gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X+j,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,_this.texImages[j])}gl.bindTexture(gl.TEXTURE_CUBE_MAP,null);return _this.loaded=true}};this.texImages[i].src=this.paths[i]}}TextureCube.prototype.bind=function(unit){var gl;gl=CoffeeGL.Context.gl;if(gl!=null&&this.loaded){gl.activeTexture(gl.TEXTURE0+this.unit);return gl.bindTexture(gl.TEXTURE_CUBE_MAP,this.texture)}};TextureCube.prototype.unbind=function(){var gl;gl=CoffeeGL.Context.gl;if(this.loaded&&gl!=null){gl.activeTexture(gl.TEXTURE0+this.unit);return gl.bindTexture(gl.TEXTURE_CUBE_MAP,null)}};return TextureCube}(TextureBase);module.exports={Texture:Texture,TextureBase:TextureBase,TextureCube:TextureCube}}).call(this)},{"./request":9}],12:[function(require,module,exports){(function(){var Camera,Matrix4,MousePerspCamera,OrthoCamera,PerspCamera,Primitive,Quaternion,TouchPerspCamera,Vec2,Vec3,Vec4,degToRad,makeMouseListener,_ref,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};_ref=require("./math"),Vec2=_ref.Vec2,Vec3=_ref.Vec3,Vec4=_ref.Vec4,Matrix4=_ref.Matrix4,Quaternion=_ref.Quaternion,degToRad=_ref.degToRad;Primitive=require("./primitives").Primitive;makeMouseListener=require("./signal").makeMouseListener;Camera=function(){function Camera(pos,look,up){this.pos=pos;this.look=look;this.up=up;if(this.pos==null){this.pos=new Vec3(0,0,5)}if(this.look==null){this.look=new Vec3(0,0,0)}if(this.up==null){this.up=new Vec3(0,1,0)}this.m=new Matrix4;this.p=new Matrix4;this.i=new Matrix4;this.ip=new Matrix4;this.q=new Quaternion;this.width=CoffeeGL.Context.width;this.height=CoffeeGL.Context.width}Camera.prototype.update=function(){var gl;this.m.lookAt(this.pos,this.look,this.up);this.i=Matrix4.invert(this.m);gl=CoffeeGL.Context.gl;gl.viewport(0,0,this.width,this.height);return this};Camera.prototype.setViewport=function(width,height){this.width=width;this.height=height;return this};Camera.prototype.orbit=function(axis,angle){var dir,l;this.q.fromAxisAngle(axis,angle);dir=Vec3.sub(this.look,this.pos);dir.normalize();l=Vec3.sub(this.pos,this.look);this.q.transVec3(l);this.q.transVec3(this.up);l.add(this.look);this.pos.copyFrom(l);return this.update()};Camera.prototype.pantilt=function(axis,angle){var dir,q2;this.q.fromAxisAngle(axis,angle);dir=Vec3.sub(this.look,this.pos);dir.normalize();q2=new Quaternion;q2.fromAxisAngle(Vec3.cross(dir,this.up),angle);q2.mult(this.q);q2.transVec3(this.look);q2.transVec3(this.up);return this.update()};Camera.prototype._addToNode=function(node){node.camera=this;return this};Camera.prototype.track=function(v){var g;g=new Vec4(v.x,v.y,0,0);this.i.multVec(g);this.look.add(g);this.pos.add(g);return this};return Camera}();OrthoCamera=function(_super){__extends(OrthoCamera,_super);function OrthoCamera(pos,look,up,near,far){this.pos=pos;this.look=look;this.up=up;this.near=near;this.far=far;OrthoCamera.__super__.constructor.call(this,this.pos,this.look,this.up);if(this.near==null){this.near=-1}if(this.far==null){this.far=1}}OrthoCamera.prototype.update=function(w,h){var gl;if(w==null){w=CoffeeGL.Context.width;h=CoffeeGL.Context.height}OrthoCamera.__super__.update.call(this);this.p.makeOrtho(0,w,0,h,this.near,this.far);this.ip=Matrix4.invert(this.p);gl=CoffeeGL.Context.gl;gl.viewport(0,0,w,h);return this};return OrthoCamera}(Camera);PerspCamera=function(_super){__extends(PerspCamera,_super);function PerspCamera(pos,look,up,angle,near,far){this.pos=pos;this.look=look;this.up=up;this.angle=angle;this.near=near;this.far=far;PerspCamera.__super__.constructor.call(this,this.pos,this.look,this.up);if(this.angle==null){this.angle=50}if(this.near==null){this.near=.1}if(this.far==null){this.far=100}this.zoom_near=this.near;this.zoom_far=this.far}PerspCamera.prototype.update=function(){PerspCamera.__super__.update.call(this);
this.p.makePerspective(this.angle,this.width/this.height,this.near,this.far);this.ip=Matrix4.invert(this.p);return this};PerspCamera.prototype.castRay=function(sx,sy){var g,gl,pp;if(CoffeeGL.Context!=null){gl=CoffeeGL.Context.gl;g=new Vec4(sx*2/CoffeeGL.Context.width-1,1-sy*2/CoffeeGL.Context.height,1,1);pp=Matrix4.mult(Matrix4.invert(this.m),Matrix4.invert(this.p));pp.multVec(g);g.normalize();return new Vec3(g.x,g.y,g.z)}return new Vec3(0,0,0)};PerspCamera.prototype._zoom=function(dt){var dir,dl,dp,tl;dir=Vec3.sub(this.look,this.pos);dl=dir.length();tl=this.zoom_far-this.zoom_near;dp=dl/tl;this.zoom(dp+dt);return this};PerspCamera.prototype.zoom=function(z){var dir,tl;if(z>0&&z<1){dir=Vec3.sub(this.pos,this.look);dir.normalize();tl=this.zoom_far-this.zoom_near;dir.multScalar(z*tl);this.pos=Vec3.add(this.look,dir);this.update()}return this};return PerspCamera}(Camera);MousePerspCamera=function(_super){__extends(MousePerspCamera,_super);function MousePerspCamera(pos,look,up,angle,near,far,sense){this.pos=pos;this.look=look;this.up=up;this.angle=angle;this.near=near;this.far=far;this.sense=sense;MousePerspCamera.__super__.constructor.call(this,this.pos,this.look,this.up,this.angle,this.near,this.far);CoffeeGL.Context.mouseMove.add(this.onMouseMove,this);CoffeeGL.Context.mouseDown.add(this.onMouseDown,this);CoffeeGL.Context.mouseUp.add(this.onMouseUp,this);CoffeeGL.Context.mouseWheel.add(this.onMouseWheel,this);if(this.sense==null){this.sense=.3}this.px=0;this.py=0;this.dx=0;this.dy=0;this.m.lookAt(this.pos,this.look,this.up);this.i=Matrix4.invert(this.m);this}MousePerspCamera.prototype.onMouseMove=function(event){var dir,x,y;x=event.mouseX;y=event.mouseY;this.dx=x-this.px;this.px=x;this.dy=y-this.py;this.py=y;if(event.buttonLeft){this.orbit(new Vec3(0,1,0),degToRad(-this.dx*this.sense));dir=Vec3.sub(this.look,this.pos);this.orbit(Vec3.cross(dir,this.up),degToRad(this.dy*this.sense))}else if(event.buttonRight){this.track(new Vec2(this.dx*this.sense*-.02,this.dy*this.sense*.02))}return this};MousePerspCamera.prototype.onMouseDown=function(event){var x,y;x=event.mouseX;y=event.mouseY;this.px=x;this.py=y;this.dx=0;this.dy=0;return this};MousePerspCamera.prototype.onMouseUp=function(event){return this};MousePerspCamera.prototype.onMouseWheel=function(event){var dp,dt,tl;dt=event.wheelDelta*.01*this.sense;tl=this.far-this.near;dp=dt/tl;this._zoom(dp);return this};MousePerspCamera.prototype.update=function(w,h){var gl;if(w==null){w=CoffeeGL.Context.width;h=CoffeeGL.Context.height}this.p.makePerspective(this.angle,w/h,this.near,this.far);this.ip=Matrix4.invert(this.p);this.m.lookAt(this.pos,this.look,this.up);this.i=Matrix4.invert(this.m);gl=CoffeeGL.Context.gl;gl.viewport(0,0,w,h);return this};MousePerspCamera.prototype.onMouseOut=function(event){this.px=0;this.py=0;this.dx=0;return this.dy=0};MousePerspCamera.prototype.onMouseOver=function(event){var _ref1;if(this.px===0&&this.py===0){return _ref1=[event.mouseX,event.mouseY],this.px=_ref1[0],this.py=_ref1[1],_ref1}};return MousePerspCamera}(PerspCamera);TouchPerspCamera=function(_super){__extends(TouchPerspCamera,_super);function TouchPerspCamera(pos,look,up,angle,near,far,sense){this.pos=pos;this.look=look;this.up=up;this.angle=angle;this.near=near;this.far=far;this.sense=sense;TouchPerspCamera.__super__.constructor.call(this,this.pos,this.look,this.up,this.angle,this.near,this.far);CoffeeGL.Context.touchPinch.add(this.onPinch,this);CoffeeGL.Context.touchSpread.add(this.onSpread,this);CoffeeGL.Context.touchSwipe.add(this.onSwipe,this)}TouchPerspCamera.prototype.onPinch=function(event){var dp,dt,tl;dt=-event.ddist*.08*this.sense;tl=this.far-this.near;dp=dt/tl;this._zoom(dp);return this};TouchPerspCamera.prototype.onSpread=function(event){var dp,dt,tl;dt=-event.ddist*.08*this.sense;tl=this.far-this.near;dp=dt/tl;this._zoom(dp);return this};TouchPerspCamera.prototype.onSwipe=function(event){var dir,x,y;x=event.currentPos.x;y=event.currentPos.y;this.px=event.previousPos.x;this.py=event.previousPos.y;this.dx=x-this.px;this.px=x;this.dy=y-this.py;this.py=y;if(event.fingers===1){this.orbit(new Vec3(0,1,0),degToRad(-this.dx*this.sense));dir=Vec3.sub(this.look,this.pos);this.orbit(Vec3.cross(dir,this.up),degToRad(-this.dy*this.sense))}else if(event.fingers===2){this.track(new Vec2(this.dx*this.sense*-.02,this.dy*this.sense*.02))}return this};return TouchPerspCamera}(MousePerspCamera);module.exports={Camera:Camera,OrthoCamera:OrthoCamera,PerspCamera:PerspCamera,MousePerspCamera:MousePerspCamera,TouchPerspCamera:TouchPerspCamera}}).call(this)},{"./math":3,"./primitives":5,"./signal":16}],13:[function(require,module,exports){(function(){var Cuboid,CurveCubic,Cylinder,Geometry,Node,PI,Quad,RGB,RGBA,Sphere,Triangle,Vec2,Vec3,Vertex,degToRad,_ref,_ref1,_ref2,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};Node=require("./node").Node;_ref=require("./colour"),RGB=_ref.RGB,RGBA=_ref.RGBA;_ref1=require("./math"),Vec2=_ref1.Vec2,Vec3=_ref1.Vec3,PI=_ref1.PI,degToRad=_ref1.degToRad;_ref2=require("./primitives"),Vertex=_ref2.Vertex,Triangle=_ref2.Triangle,Quad=_ref2.Quad,Geometry=_ref2.Geometry;Cuboid=function(_super){__extends(Cuboid,_super);function Cuboid(dim,colour){var d,h,i,w,_i,_ref3;Cuboid.__super__.constructor.call(this);if(dim==null){dim=new Vec3(1,1,1)}w=dim.x/2;h=dim.y/2;d=dim.z/2;this.v.push(new Vertex(new Vec3(-w,-h,d),colour,Vec3.normalize(new Vec3(-w,-h,d)),new Vec2(0,0)));this.v.push(new Vertex(new Vec3(w,-h,d),colour,Vec3.normalize(new Vec3(w,-h,d)),new Vec2(1,0)));this.v.push(new Vertex(new Vec3(w,h,d),colour,Vec3.normalize(new Vec3(w,h,d)),new Vec2(1,1)));this.v.push(new Vertex(new Vec3(-w,h,d),colour,Vec3.normalize(new Vec3(-w,h,d)),new Vec2(0,1)));this.v.push(new Vertex(new Vec3(-w,-h,-d),colour,Vec3.normalize(new Vec3(-w,-h,-d)),new Vec2(1,1)));this.v.push(new Vertex(new Vec3(w,-h,-d),colour,Vec3.normalize(new Vec3(w,-h,-d)),new Vec2(1,0)));this.v.push(new Vertex(new Vec3(w,h,-d),colour,Vec3.normalize(new Vec3(w,h,-d)),new Vec2(0,0)));this.v.push(new Vertex(new Vec3(-w,h,-d),colour,Vec3.normalize(new Vec3(-w,h,-d)),new Vec2(0,1)));this.indices=[0,1,2,0,2,3,6,5,4,6,4,7,4,0,3,4,3,7,1,5,2,5,6,2,3,2,6,3,6,7,4,5,1,4,1,0];for(i=_i=0,_ref3=this.indices.length-1;_i<=_ref3;i=_i+=3){this.faces.push(new Triangle(this.v[this.indices[i]],this.v[this.indices[i+1]],this.v[this.indices[i+2]]))}}return Cuboid}(Geometry);Sphere=function(_super){__extends(Sphere,_super);function Sphere(radius,segments,center,colour){var c,e,gl,i,j,p,t,theta1,theta2,theta3,v,_i,_j,_k,_ref3,_ref4,_ref5;Sphere.__super__.constructor.call(this);gl=CoffeeGL.Context.gl;this.layout=gl.TRIANGLE_STRIP;if(center==null){center=new Vec3(0,0,0)}if(segments!=null){if(segments<0){segments=10}}else{segments=10}for(j=_i=0,_ref3=segments/2;0<=_ref3?_i<=_ref3:_i>=_ref3;j=0<=_ref3?++_i:--_i){theta1=j*2*PI/segments-PI/2;theta2=(j+1)*2*PI/segments-PI/2;for(i=_j=0,_ref4=segments+1;0<=_ref4?_j<=_ref4:_j>=_ref4;i=0<=_ref4?++_j:--_j){e=new Vec3;theta3=i*2*PI/segments;e.x=Math.cos(theta1)*Math.cos(theta3);e.y=Math.sin(theta1);e.z=Math.cos(theta1)*Math.sin(theta3);p=Vec3.multScalar(e,radius).add(center);c=new RGBA(1,1,1,1);t=new Vec2(.999-i/segments,.999-2*j/segments);v=new Vertex(p,c,e,t);this.v.push(v);e=new Vec3;e.x=Math.cos(theta2)*Math.cos(theta3);e.y=Math.sin(theta2);e.z=Math.cos(theta2)*Math.sin(theta3);p=Vec3.multScalar(e,radius).add(center);t=new Vec2(.999-i/segments,.999-2*(j+1)/segments);v=new Vertex(p,c,e,t);this.v.push(v)}}for(i=_k=2,_ref5=this.v.length-1;_k<=_ref5;i=_k+=1){if(i%2===0){this.faces.push(new Triangle(this.v[i],this.v[i-1],this.v[i-2]))}else{this.faces.push(new Triangle(this.v[i],this.v[i-2],this.v[i-1]))}}}return Sphere}(Geometry);Cylinder=function(_super){__extends(Cylinder,_super);function Cylinder(radius,resolution,segments,height,colour){var e,hstep,i,j,n,s,tangent,x,z,_i,_j,_k,_l,_m,_n,_o,_p,_ref3,_ref4,_ref5;Cylinder.__super__.constructor.call(this);this.indices=[];if(radius!=null){if(radius<0){radius=.5}}else{radius=.5}if(segments!=null){if(segments<0){segments=10}}else{segments=10}if(height!=null){if(height<0){height=1}}else{height=1}hstep=height/segments;height=height/2;this.v.push(new Vertex(new Vec3(0,height,0),colour,new Vec3(0,1,0),new Vec2(.5,0)));for(i=_i=1;1<=resolution?_i<=resolution:_i>=resolution;i=1<=resolution?++_i:--_i){x=radius*Math.sin(degToRad(360/resolution*i));z=radius*Math.cos(degToRad(360/resolution*i));tangent=new Vec3(x,0,z);tangent.normalize();tangent.cross(new Vec3(0,1,0));this.v.push(new Vertex(new Vec3(x,height,z),colour,Vec3.normalize(new Vec3(x,1,z)),new Vec2(i/resolution,0),tangent))}for(i=_j=1;1<=resolution?_j<=resolution:_j>=resolution;i=1<=resolution?++_j:--_j){this.indices.push(0);this.indices.push(i);if(i===resolution){this.indices.push(1)}else{this.indices.push(i+1)}}for(i=_k=1;1<=segments?_k<=segments:_k>=segments;i=1<=segments?++_k:--_k){for(j=_l=1;1<=resolution?_l<=resolution:_l>=resolution;j=1<=resolution?++_l:--_l){x=radius*Math.sin(degToRad(360/resolution*j));z=radius*Math.cos(degToRad(360/resolution*j));tangent=new Vec3(x,0,z);tangent.normalize();tangent.cross(new Vec3(0,-1,0));n=Vec3.normalize(new Vec3(x,0,z));if(i===segments){n=Vec3.normalize(new Vec3(x,-1,z))}this.v.push(new Vertex(new Vec3(x,height-hstep*i,z),colour,n,new Vec2(j/resolution,i/segments),tangent))}s=(i-1)*resolution+1;e=s+resolution;for(j=_m=0,_ref3=resolution-1;0<=_ref3?_m<=_ref3:_m>=_ref3;j=0<=_ref3?++_m:--_m){this.indices.push(s+j);this.indices.push(e+j);if(j===resolution-1){this.indices.push(e)}else{this.indices.push(e+j+1)}}for(j=_n=0,_ref4=resolution-1;0<=_ref4?_n<=_ref4:_n>=_ref4;j=0<=_ref4?++_n:--_n){this.indices.push(s+j);if(j===resolution-1){this.indices.push(e);this.indices.push(s)}else{this.indices.push(e+j+1);this.indices.push(s+j+1)}}}this.v.push(new Vertex(new Vec3(0,-height,0),colour,new Vec3(0,-1,0),new Vec2(.5,1)));s=segments*resolution+2;e=s+resolution-1;for(i=_o=s;s<=e?_o<=e:_o>=e;i=s<=e?++_o:--_o){this.indices.push(s-1);if(i===e){this.indices.push(s)}else{this.indices.push(i+1)}this.indices.push(i)}for(i=_p=0,_ref5=this.indices.length-1;_p<=_ref5;i=_p+=3){this.faces.push(new Triangle(this.v[this.indices[i]],this.v[this.indices[i+1]],this.v[this.indices[i+2]]))}this}return Cylinder}(Geometry);CurveCubic=function(){function CurveCubic(v0,v1,v2,v3){this.v0=v0;this.v1=v1;this.v2=v2;this.v3=v3}CurveCubic.prototype._B1=function(t){return t*t*t};CurveCubic.prototype._B2=function(t){return 3*t*t*(1-t)};CurveCubic.prototype._B3=function(t){return 3*t*(1-t)*(1-t)};CurveCubic.prototype._B4=function(t){return(1-t)*(1-t)*(1-t)};CurveCubic.prototype.pointOnCurve=function(val){return new Vector3(v0.x*this._B1(val)+v1.x*this._B2(val)+v2.x*this._B3(val)+v3.x*this._B4(val),v0.y*this._B1(val)+v1.y*this._B2(val)+v2.y*this._B3(val)+v3.y*this._B4(val),v0.z*this._B1(val)+v1.z*this._B2(val)+v2.z*this._B3(val)+v3.z*this._B4(val))};return CurveCubic}();module.exports={Cuboid:Cuboid,Sphere:Sphere,Cylinder:Cylinder,CurveCubic:CurveCubic}}).call(this)},{"./node":6,"./colour":4,"./math":3,"./primitives":5}],14:[function(require,module,exports){(function(){var CoffeeGLWarning,CoffeeGLWarningOnce,Cuboid,Matrix4,Quad,RGB,RGBA,Sphere,Triangle,TriangleMesh,Vec2,Vec3,Vertex,WebGLNodeDrawable,brew,bufferSubData,createArrayBuffer,createElementBuffer,deleteBuffer,drawGeometryGL,makeNodeDrawableGL,rebrew,rebrew_typed,setDataBuffer,util,washup,_attribTypeCheckSet,_matchWithShader,_ref,_ref1,_ref2,_ref3,_ref4,_splitRole,_typeCheckSet;_ref=require("./math"),Matrix4=_ref.Matrix4,Vec3=_ref.Vec3,Vec2=_ref.Vec2;_ref1=require("./colour"),RGB=_ref1.RGB,RGBA=_ref1.RGBA;_ref2=require("./primitives"),Vertex=_ref2.Vertex,Triangle=_ref2.Triangle,Quad=_ref2.Quad,TriangleMesh=_ref2.TriangleMesh;_ref3=require("./shapes"),Cuboid=_ref3.Cuboid,Sphere=_ref3.Sphere;_ref4=require("./error"),CoffeeGLWarning=_ref4.CoffeeGLWarning,CoffeeGLWarningOnce=_ref4.CoffeeGLWarningOnce;util=require("./util");setDataBuffer=function(buffer,data,type){var gl;gl=CoffeeGL.Context.gl;gl.bindBuffer(gl.ARRAY_BUFFER,buffer);gl.bufferData(gl.ARRAY_BUFFER,data,type);gl.bindBuffer(gl.ARRAY_BUFFER,null);return buffer};createArrayBuffer=function(data,type,size){var buffer,gl;gl=CoffeeGL.Context.gl;buffer=gl.createBuffer();setDataBuffer(buffer,data,type);buffer.itemSize=size;buffer.numItems=data.length/size;return buffer};bufferSubData=function(buffer,data,offset){var gl;gl=CoffeeGL.Context.gl;if(offset==null){offset=0}gl.bindBuffer(gl.ARRAY_BUFFER,buffer);gl.bufferSubData(gl.ARRAY_BUFFER,offset,data);gl.bindBuffer(gl.ARRAY_BUFFER,null);return buffer};createElementBuffer=function(data,type,size){var buffer,gl;gl=CoffeeGL.Context.gl;buffer=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,buffer);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,data,type);buffer.itemSize=size;buffer.numItems=data.length;gl.bindBuffer(gl.ARRAY_BUFFER,null);return buffer};deleteBuffer=function(buffer){var gl;gl=CoffeeGL.Context.gl;gl.deleteBuffer(buffer);return this};_attribTypeCheckSet=function(a,v){var gl;gl=CoffeeGL.Context.gl;if(a.pos===-1){return}gl.enableVertexAttribArray(a.pos);gl.bindBuffer(gl.ARRAY_BUFFER,v[a.role]);if(a.type==="int"){gl.vertexAttribPointer(a.pos,1,gl.INT,false,0,0)}else if(a.type==="float"){gl.vertexAttribPointer(a.pos,1,gl.FLOAT,false,0,0)}else if(a.type==="vec2"){gl.vertexAttribPointer(a.pos,2,gl.FLOAT,false,0,0)}else if(a.type==="vec3"){gl.vertexAttribPointer(a.pos,3,gl.FLOAT,false,0,0)}else if(a.type==="vec4"){gl.vertexAttribPointer(a.pos,4,gl.FLOAT,false,0,0)}return this};_typeCheckSet=function(u,v,tag){var gl,idx,m,role,t,x,_i,_j,_k,_len,_len1,_len2,_ref5,_ref6,_ref7;if(u.pos===-1){return}role=u.role;if(tag!=null){role=_splitRole(tag,u.role)}gl=CoffeeGL.Context.gl;if(u.size===1){if(u.type==="float"){gl.uniform1f(u.pos,v[role])}else if(u.type==="int"){gl.uniform1i(u.pos,v[role])}else if(u.type==="vec2"){gl.uniform2f(u.pos,v[role].x,v[role].y)}else if(u.type==="vec3"){if(v[role].x!=null){gl.uniform3f(u.pos,v[role].x,v[role].y,v[role].z)}else{gl.uniform3f(u.pos,v[role].r,v[role].g,v[role].b)}}else if(u.type==="vec4"){if(v[role].x!=null){gl.uniform4f(u.pos,v[role].x,v[role].y,v[role].z,v[role].w)}else{gl.uniform4f(u.pos,v[role].r,v[role].g,v[role].b,v[role].a)}}else if(u.type==="mat4"){gl.uniformMatrix4fv(u.pos,false,v[role].a)}else if(u.type==="mat3"){gl.uniformMatrix3fv(u.pos,false,v[role].a)}else if(u.type==="sampler2D"){gl.uniform1i(u.pos,v[role])}}else{if(v[role][0]instanceof Object){t=[];if(v[role][0].flatten!=null){_ref5=v[role];for(_i=0,_len=_ref5.length;_i<_len;_i++){x=_ref5[_i];t=t.concat(x.flatten())}if(u.type==="vec2"){gl.uniform2fv(u.pos,new Float32Array(t))}else if(u.type==="vec3"){gl.uniform3fv(u.pos,new Float32Array(t))}else if(u.type==="vec4"){gl.uniform4fv(u.pos,new Float32Array(t))}}else if(v[role][0].a){if(u.type==="mat3"){t=new Float32Array(9*v[role].length);idx=0;_ref6=v[role];for(_j=0,_len1=_ref6.length;_j<_len1;_j++){m=_ref6[_j];t.set(m.a,idx*9);idx++}gl.uniformMatrix3fv(u.pos,false,new Float32Array(t))}else if(u.type==="mat4"){t=new Float32Array(16*v[role].length);idx=0;_ref7=v[role];for(_k=0,_len2=_ref7.length;_k<_len2;_k++){m=_ref7[_k];t.set(m.a,idx*16);idx++}gl.uniformMatrix4fv(u.pos,false,new Float32Array(t))}}}else{if(u.type==="float"){gl.uniform1fv(u.pos,new Float32Array(v[role]))}else if(u.type==="int"){gl.uniform1iv(u.pos,new Int32Array(v[role]))}else if(u.type==="vec2"){gl.uniform2fv(u.pos,new Float32Array(v[role]))}else if(u.type==="vec3"){gl.uniform3fv(u.pos,new Float32Array(v[role]))}else if(u.type==="vec4"){gl.uniform4fv(u.pos,new Float32Array(v[role]))}else if(u.type==="mat4"){gl.uniformMatrix4fv(u.pos,false,new Float32Array(v[role]))}}}return this};_splitRole=function(tag,role){if(role.indexOf(tag)!==-1){return role.split("/")[1]}return role};_matchWithShader=function(node){var a,attenuations,colours,contract,light,pointlights,positions,shader,speculars,t,u,_i,_j,_k,_l,_len,_len1,_len2,_len3,_len4,_len5,_len6,_len7,_m,_n,_o,_p,_ref10,_ref11,_ref12,_ref5,_ref6,_ref7,_ref8,_ref9;if(CoffeeGL.Context.shader==null){console.log("CoffeeGL Error - Not Shader bound when calling _matchWithShader");return node}if(CoffeeGL.Context.shader.contract==null){console.log("CoffeeGL Error - Not Shader contract when calling _matchWithShader");return node}contract=CoffeeGL.Context.shader.contract;shader=CoffeeGL.Context.shader;_ref5=contract.uniforms;for(_i=0,_len=_ref5.length;_i<_len;_i++){u=_ref5[_i];if(node[u.role]!=null){_typeCheckSet(u,node)}}if(node._camera!=null){_ref6=contract.uniforms;for(_j=0,_len1=_ref6.length;_j<_len1;_j++){u=_ref6[_j];if(node._camera[_splitRole("camera",u.role)]!=null){_typeCheckSet(u,node._camera,"camera")}}}if(node._material!=null){_ref7=contract.uniforms;for(_k=0,_len2=_ref7.length;_k<_len2;_k++){u=_ref7[_k];if(node._material[_splitRole("material",u.role)]!=null){_typeCheckSet(u,node._material,"material")}}}if(node._pointLightsGlobal.length>0){positions=[];colours=[];speculars=[];attenuations=[];_ref8=node._pointLightsGlobal;for(_l=0,_len3=_ref8.length;_l<_len3;_l++){light=_ref8[_l];positions=positions.concat(light.pos.flatten());colours=colours.concat(light.colour.flatten());speculars=speculars.concat(light.specular.flatten());attenuations=attenuations.concat(light.attenuation)}positions=new Float32Array(positions);colours=new Float32Array(colours);speculars=new Float32Array(speculars);attenuations=new Float32Array(attenuations);pointlights={pos:positions,colour:colours,specular:speculars,attenuation:attenuations};_ref9=contract.uniforms;for(_m=0,_len4=_ref9.length;_m<_len4;_m++){u=_ref9[_m];if(pointlights[_splitRole("pointLightsGlobal",u.role)]!=null){_typeCheckSet(u,pointlights,"pointLightsGlobal")}}}if(node.textures!=null){_ref10=contract.textures;for(_n=0,_len5=_ref10.length;_n<_len5;_n++){u=_ref10[_n];_ref11=node.textures;for(_o=0,_len6=_ref11.length;_o<_len6;_o++){t=_ref11[_o];if(t[_splitRole("texture",u.role)]!=null){_typeCheckSet(u,t,"texture")}}}}if(node.geometry!=null){_ref12=contract.attributes;for(_p=0,_len7=_ref12.length;_p<_len7;_p++){a=_ref12[_p];if(node.geometry[a.role]!=null){_attribTypeCheckSet(a,node.geometry)}}}return node};drawGeometryGL=function(geometry,drawPrimitive){var gl;gl=CoffeeGL.Context.gl;if(drawPrimitive==null){if(geometry.layout==null){drawPrimitive=gl.TRIANGLES}else{drawPrimitive=geometry.layout}}if(geometry.vertexIndexBuffer!=null){gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,geometry.vertexIndexBuffer);return gl.drawElements(drawPrimitive,geometry.vertexIndexBuffer.numItems,gl.UNSIGNED_SHORT,0)}else{return gl.drawArrays(drawPrimitive,0,geometry.vertexPositionBuffer.numItems)}};brew=function(geometry,params){var access,colours,gl,normals,size,tangents,uvs,v,vertices,_i,_j,_k,_l,_len,_len1,_len2,_len3,_len4,_m,_ref5,_ref6,_ref7,_ref8,_ref9;if(geometry.v==null||geometry.v.length<=0){geometry.brewed=false;return this}gl=CoffeeGL.Context.gl;if(params==null){params={}}access=params.position_buffer_access!=null?params.position_buffer_access:gl.STATIC_DRAW;if(geometry.flat){if(geometry.vertexPositionBuffer==null){geometry.vertexPositionBuffer=createArrayBuffer(geometry.v,access,3)}else{if(geometry.v.length===geometry.vertexPositionBuffer.numItems){setDataBuffer(geometry.vertexPositionBuffer,geometry.v,access)}else{CoffeeGLWarningOnce("Attemping to update position buffer of different length")}}}else{vertices=[];_ref5=geometry.v;for(_i=0,_len=_ref5.length;_i<_len;_i++){v=_ref5[_i];vertices=vertices.concat(v.p.flatten())}if(geometry.vertexPositionBuffer==null){geometry.vertexPositionBuffer=createArrayBuffer(new Float32Array(vertices),access,3)}else{if(v.length===geometry.vertexPositionBuffer.numItems){setDataBuffer(geometry.vertexPositionBuffer,new Float32Array(vertices),access)}else{CoffeeGLWarningOnce("Attemping to update position buffer of different length")}}}access=params.colour_buffer_access!=null?params.colour_buffer_access:gl.STATIC_DRAW;if(geometry.flat){if(geometry.c!=null){if(geometry.vertexColourBuffer==null){size=3;if(geometry.c.length/4===geometry.v.length/3){size=4}geometry.vertexColourBuffer=createArrayBuffer(geometry.c,access,size)}else{if(geometry.c.length===geometry.vertexColourBuffer.numItems){setDataBuffer(geometry.vertexColourBuffer,geometry.c,access)}else{CoffeeGLWarningOnce("Attemping to update colour buffer of different length")}}}}else{if(geometry.v[0].c!=null){colours=[];_ref6=geometry.v;for(_j=0,_len1=_ref6.length;_j<_len1;_j++){v=_ref6[_j];colours=colours.concat(v.c.flatten())}if(!geometry.vertexColourBuffer){size=4;if(geometry.v[0].c instanceof RGB){size=3}geometry.vertexColourBuffer=createArrayBuffer(new Float32Array(colours),access,size)}else{if(v.length===geometry.vertexColourBuffer.numItems){setDataBuffer(geometry.vertexColourBuffer,new Float32Array(colours),access)}else{CoffeeGLWarningOnce("Attemping to update colour buffer of different length")}}}}access=params.indices_buffer_access!=null?params.indices_buffer_access:gl.STATIC_DRAW;if(geometry.flat){if(geometry.i!=null){if(geometry.vertexIndexBuffer==null){geometry.vertexIndexBuffer=createElementBuffer(geometry.i,access,1)}else{if(geometry.i.length===geometry.vertexIndexBuffer.numItems){setDataBuffer(geometry.vertexIndexBuffer,geometry.i,access)}else{CoffeeGLWarningOnce("Attemping to update indices buffer of different length")}}}}else{if(geometry.indices!=null){if(geometry.vertexIndexBuffer==null){geometry.vertexIndexBuffer=createElementBuffer(new Uint16Array(geometry.indices),access,1)}else{if(v.length===geometry.vertexIndexBuffer.numItems){setDataBuffer(geometry.vertexIndexBuffer,new Float32Array(geometry.indices),access)}else{CoffeeGLWarningOnce("Attemping to update indices buffer of different length")}}}}access=params.normal_buffer_access!=null?params.normal_buffer_access:gl.STATIC_DRAW;if(geometry.flat){if(geometry.n!=null){if(geometry.vertexNormalBuffer==null){geometry.vertexNormalBuffer=createArrayBuffer(geometry.n,access,3)}else{if(geometry.n.length===geometry.vertexNormalBuffer.numItems){setDataBuffer(geometry.vertexNormalBuffer,geometry.n,access)}else{CoffeeGLWarningOnce("Attemping to update normal buffer of different length")}}}}else{if(geometry.v[0].n!=null){normals=[];_ref7=geometry.v;for(_k=0,_len2=_ref7.length;_k<_len2;_k++){v=_ref7[_k];normals=normals.concat(v.n.flatten())}if(geometry.vertexNormalBuffer==null){geometry.vertexNormalBuffer=createArrayBuffer(new Float32Array(normals),access,3)}else{if(v.length===geometry.vertexNormalBuffer.numItems){setDataBuffer(geometry.vertexNormalBuffer,new Float32Array(normals),access)}else{CoffeeGLWarningOnce("Attemping to update normals buffer of different length")}}}}access=params.texcoord_buffer_access!=null?params.texcoord_buffer_access:gl.STATIC_DRAW;if(geometry.flat){if(geometry.t!=null){if(geometry.vertexTextureBuffer==null){geometry.vertexTextureBuffer=createArrayBuffer(geometry.t,access,2)}else{if(geometry.t.length===geometry.vertexTextureBuffer.numItems){setDataBuffer(geometry.vertexTextureBuffer,geometry.t,access)}else{CoffeeGLWarningOnce("Attemping to update texture buffer of different length")}}}}else{if(geometry.v[0].t!=null){uvs=[];_ref8=geometry.v;for(_l=0,_len3=_ref8.length;_l<_len3;_l++){v=_ref8[_l];uvs=uvs.concat(v.t.flatten())}if(geometry.vertexTextureBuffer==null){geometry.vertexTextureBuffer=createArrayBuffer(new Float32Array(uvs),access,2)}else{if(v.length===geometry.vertexTextureBuffer.numItems){setDataBuffer(geometry.vertexIndexBuffer,new Float32Array(uvs),access)}else{CoffeeGLWarningOnce("Attemping to update texture co-ord buffer of different length")}}}}access=params.tangent_buffer_access!=null?params.tangent_buffer_access:gl.STATIC_DRAW;if(geometry.flat){if(geometry.tangent!=null){if(geometry.vertexTangentBuffer==null){geometry.vertexTangentBuffer=createArrayBuffer(geometry.tangent,access,3)}else{if(geometry.tangent.length===geometry.vertexTangentBuffer.numItems){setDataBuffer(geometry.vertexTangentBuffer,geometry.tangent,access)}else{CoffeeGLWarningOnce("Attemping to update tangent buffer of different length")}}}}else{if(geometry.v[0].tangent!=null){tangents=[];_ref9=geometry.v;for(_m=0,_len4=_ref9.length;_m<_len4;_m++){v=_ref9[_m];tangents=tangents.concat(v.tangent.flatten())}if(geometry.vertexTangentBuffer==null){geometry.vertexTangentBuffer=createArrayBuffer(new Float32Array(tangents),access,3)}else{if(v.length===geometry.vertexTangentBuffer.numItems){setDataBuffer(geometry.vertexTangentBuffer,new Float32Array(tangents),access)}else{CoffeeGLWarningOnce("Attemping to update tangent buffer of different length")}}}}geometry.brewed=true;return this};rebrew=function(geometry,params){var colours,gl,normals,tangents,uvs,v,vertices,_i,_j,_k,_l,_len,_len1,_len2,_len3,_len4,_m,_ref5,_ref6,_ref7,_ref8,_ref9;if(geometry.v==null||geometry.v.length<=0){return this}if(params==null){return this}if(geometry.brewed===false){return this}gl=CoffeeGL.Context.gl;if(params.colour_buffer!=null){colours=[];_ref5=geometry.v;for(_i=0,_len=_ref5.length;_i<_len;_i++){v=_ref5[_i];colours=colours.concat(v.c.flatten())}if(geometry.vertexColourBuffer!=null){bufferSubData(geometry.vertexColourBuffer,new Float32Array(colours),params.colour_buffer)}}if(params.position_buffer!=null){if(geometry.flat){if(geometry.vertexPositionBuffer!=null){bufferSubData(geometry.vertexPositionBuffer,geometry.vertices,params.position_buffer)}}else{vertices=[];_ref6=geometry.v;for(_j=0,_len1=_ref6.length;_j<_len1;_j++){v=_ref6[_j];vertices=vertices.concat(v.p.flatten())}if(geometry.vertexPositionBuffer!=null){bufferSubData(geometry.vertexPositionBuffer,new Float32Array(vertices),params.position_buffer)}}}if(params.normal_buffer!=null){normals=[];_ref7=geometry.v;for(_k=0,_len2=_ref7.length;_k<_len2;_k++){v=_ref7[_k];normals=normals.concat(v.n.flatten())}if(geometry.vertexNormalBuffer!=null){bufferSubData(geometry.vertexNormalBuffer,new Float32Array(normals),params.normal_buffer)}}if(params.texcoord_buffer!=null){if(geometry.vertexTextureBuffer!=null){uvs=[];_ref8=geometry.v;for(_l=0,_len3=_ref8.length;_l<_len3;_l++){v=_ref8[_l];uvs=uvs.concat(v.t.flatten())}bufferSubData(geometry.vertexTextureBuffer,new Float32Array(uvs),params.texcoord_buffer)}}if(params.tangent_buffer!=null){tangents=[];_ref9=geometry.v;for(_m=0,_len4=_ref9.length;_m<_len4;_m++){v=_ref9[_m];tangents=tangents.concat(v.tangent.flatten())}if(geometry.vertexTangentBuffer!=null){bufferSubData(geometry.vertexTangentBuffer,new Float32Array(tangents),params.tangent_buffer)}}return this};rebrew_typed=function(geometry,params){var gl;if(geometry.v==null||geometry.v.length<=0){return this}if(params==null){return this}if(geometry.brewed===false){return this}gl=CoffeeGL.Context.gl;if(params.colour_buffer!=null){if(geometry.vertexColourBuffer!=null){bufferSubData(geometry.vertexColourBuffer,params.colour_buffer.data,params.colour_buffer.offset)}}if(params.position_buffer!=null){if(geometry.vertexPositionBuffer!=null){bufferSubData(geometry.vertexPositionBuffer,params.position_buffer.data,params.position_buffer.offset)}}if(params.normal_buffer!=null){if(geometry.vertexNormalBuffer!=null){bufferSubData(geometry.vertexNormalBuffer,params.normal_buffer.data,params.normal_buffer.offset)}}if(params.texcoord_buffer!=null){if(geometry.vertexTextureBuffer!=null){bufferSubData(geometry.vertexTextureBuffer,params.texcoord_buffer.data,params.texcoord_buffer.offset)}}if(params.tangent_buffer!=null){if(geometry.vertexTangentBuffer!=null){bufferSubData(geometry.vertexTangentBuffer,params.tangent_buffer.data,params.tangent_buffer.offset)}}return this};washup=function(geometry){return this};WebGLNodeDrawable={};WebGLNodeDrawable.drawGL=function(){var gl;gl=CoffeeGL.Context.gl;if(this._shader!=null){CoffeeGL.Context.shader=this._shader}if(CoffeeGL.Context.shader==null){return this}CoffeeGL.Context.shader.bind();_matchWithShader(this);if(this.geometry){drawGeometryGL(this.geometry)}return this};WebGLNodeDrawable.brew=function(){return brew(this.geometry)};WebGLNodeDrawable.rebrew=function(){return rebrew(this.geometry)};makeNodeDrawableGL=function(node){util.extend(node,WebGLNodeDrawable);if(node.geometry!=null){if(node.geometry.brewed==null){node.geometry.brewed=false}}return this};module.exports={brew:brew,rebrew:rebrew,rebrew_typed:rebrew_typed,makeNodeDrawableGL:makeNodeDrawableGL}}).call(this)},{"./math":3,"./colour":4,"./primitives":5,"./shapes":13,"./error":20,"./util":15}],16:[function(require,module,exports){(function(){var Signal,Vec2,makeMouseEmitter,makeTouchEmitter,mouseEmitter,touchEmitter,util;util=require("./util");Vec2=require("./math").Vec2;Signal=function(){function Signal(){this.listeners=[]}Signal.prototype.add=function(func,context){this.listeners.push({f:func,c:context,o:false,g:CoffeeGL.Context});return this};Signal.prototype.addOnce=function(func,context){this.listeners.push({f:func,c:context,o:true,g:CoffeeGL.Context});return this};Signal.prototype.remove=function(func,context){this.del(func);return this};Signal.prototype.del=function(func,context){var i,obj,_i,_len,_ref;_ref=this.listeners;for(_i=0,_len=_ref.length;_i<_len;_i++){obj=_ref[_i];if(obj.c===context){if(obj.f===func){i=this.listeners.indexOf(obj);this.listeners.splice(i,1);break}}}return this};Signal.prototype.dispatch=function(){var l,removals,_i,_j,_len,_len1,_ref;removals=[];_ref=this.listeners;for(_i=0,_len=_ref.length;_i<_len;_i++){l=_ref[_i];CoffeeGL.Context.switchContext(l.g);l.f.apply(l.c,arguments);if(l.o){removals.push(l)}}for(_j=0,_len1=removals.length;_j<_len1;_j++){l=removals[_j];this.del(l)}return this};return Signal}();mouseEmitter={};mouseEmitter["_setEvent"]=function(event){this._getMousePos(event);this._setButtons(event);if(event.preventDefault!=null){event.preventDefault()}if(event.stopImmediatePropagation!=null){event.stopImmediatePropagation()}if(event.stopPropagation!=null){event.stopPropagation()}return event};mouseEmitter["_getMousePos"]=function(e){if(e.clientX||e.clientY){e.mouseX=e.clientX;e.mouseY=e.clientY}else if(e.offsetX||e.offsetY){e.mouseX=e.offsetX;e.mouseY=e.offsetY}return[e.mouseX,e.mouseY]};mouseEmitter["_setButtons"]=function(event){if(event.type==="mousedown"){this._mouseButton=true}else if(event.type==="mouseup"||event.type==="mouseout"){this._mouseButton=false}if(CoffeeGL.Context.profile.browser==="Firefox"){if(event.type==="mousemove"&&event.buttons!==0){this._mouseButton=true}}if(this._mouseButton){if(CoffeeGL.Context.profile.browser==="Firefox"){if(event.button===0&&event.buttons===1||event.buttons===1){event.buttonLeft=true;event.buttonMiddle=false;event.buttonRight=false;return event}else if(event.button===1&&event.buttons===4||event.buttons===4){event.buttonLeft=false;event.buttonMiddle=true;event.buttonRight=false;return event}else if(event.button===2&&event.buttons===2||event.buttons===2){event.buttonLeft=false;event.buttonMiddle=false;event.buttonRight=true;return event}}else{if(event.button===0){event.buttonLeft=true;event.buttonMiddle=false;event.buttonRight=false;return event}else if(event.button===1){event.buttonLeft=false;event.buttonMiddle=true;event.buttonRight=false;return event}else if(event.button===2){event.buttonLeft=false;event.buttonMiddle=false;event.buttonRight=true;return event}}}else{event.buttonLeft=false;event.buttonMiddle=false;event.buttonRight=false;return event}};makeMouseEmitter=function(obj){var f,g,q,_this=this;if(obj.canvas!=null){util.extend(obj,mouseEmitter);obj.mouseMove=new Signal;obj.mouseDown=new Signal;obj.mouseUp=new Signal;obj.mouseClick=new Signal;obj.mouseOut=new Signal;obj.mouseOver=new Signal;obj.mouseWheel=new Signal;obj["_mouseButton"]=false;obj.canvas.onmousemove=function(event){var e;CoffeeGL.Context.switchContext(obj);e=obj._setEvent(event);obj.mouseMove.dispatch(e);return false};obj.canvas.onmousedown=function(event){CoffeeGL.Context.switchContext(obj);obj._setEvent(event);obj.mouseDown.dispatch(event);
return false};obj.canvas.onmouseup=function(event){CoffeeGL.Context.switchContext(obj);obj._setEvent(event);obj.mouseUp.dispatch(event);return false};obj.canvas.onmouseclick=function(event){CoffeeGL.Context.switchContext(obj);obj._setEvent(event);obj.mouseClick.dispatch(event);return false};obj.canvas.oncontextmenu=function(event){CoffeeGL.Context.switchContext(obj);obj._setEvent(event);return false};obj.canvas.onmouseout=function(event){CoffeeGL.Context.switchContext(obj);obj._setEvent(event);obj.mouseOut.dispatch(event);return false};obj.canvas.onmouseover=function(event){CoffeeGL.Context.switchContext(obj);obj._setEvent(event);obj.mouseOver.dispatch(event);return false};if(obj.canvas.addEventListener!=null){f=function(event){CoffeeGL.Context.switchContext(obj);obj._setEvent(event);obj.mouseWheel.dispatch(event);return false};g=function(event){CoffeeGL.Context.switchContext(obj);event.wheelDelta=Math.max(-500,Math.min(500,(event.wheelDelta||-event.detail)*500));obj._setEvent(event);obj.mouseWheel.dispatch(event);return false};q=function(event){CoffeeGL.Context.switchContext(obj);obj._setEvent(event);obj.mouseClick.dispatch(event);return false};obj.canvas.addEventListener("mousewheel",f,false);obj.canvas.addEventListener("DOMMouseScroll",g,false);return obj.canvas.addEventListener("mouseclick",q,false)}else{if(obj.canvas.onmousewheel!=null){return obj.canvas.onmousewheel=function(event){CoffeeGL.Context.switchContext(obj);obj._setEvent(event);obj.mouseWheel.dispatch(event);return false}}}}};touchEmitter={};makeTouchEmitter=function(obj){var end,ongoingTouchIndexById,_this=this;if(obj.canvas!=null){util.extend(obj,touchEmitter);obj.touchPinch=new Signal;obj.touchTap=new Signal;obj.touchSpread=new Signal;obj.touchSwipe=new Signal;obj.ongoingTouches=[];ongoingTouchIndexById=function(idToFind){var i,id,touch,_i,_ref;CoffeeGL.Context.switchContext(obj);if(obj.ongoingTouches.length>0){for(i=_i=0,_ref=obj.ongoingTouches.length-1;0<=_ref?_i<=_ref:_i>=_ref;i=0<=_ref?++_i:--_i){touch=obj.ongoingTouches[i];id=touch.identifier;if(id===idToFind){return i}}}return-1};obj.canvas.ontouchstart=function(evt){var idx,touch,touches,_i,_len;CoffeeGL.Context.switchContext(obj);evt.preventDefault();touches=evt.changedTouches;for(_i=0,_len=touches.length;_i<_len;_i++){touch=touches[_i];idx=ongoingTouchIndexById(touch.identifier);if(idx===-1){touch.ppos=new Vec2(touch.clientX,touch.clientY);touch.cpos=new Vec2(touch.clientX,touch.clientY);touch.spos=new Vec2(touch.clientX,touch.clientY);touch.moved=false;obj.ongoingTouches.push(touch)}}if(CoffeeGL.Context.debug){return console.log("Touch Start ",obj.ongoingTouches)}};obj.canvas.ontouchmove=function(evt){var cosa,d0,d1,dd0,dd1,idx,newtouch,touch,touches,_i,_len;CoffeeGL.Context.switchContext(obj);evt.preventDefault();touches=evt.changedTouches;for(_i=0,_len=touches.length;_i<_len;_i++){newtouch=touches[_i];idx=ongoingTouchIndexById(newtouch.identifier);touch=obj.ongoingTouches[idx];touch.moved=true;touch.ppos.x=touch.cpos.x;touch.ppos.y=touch.cpos.y;touch.cpos.x=newtouch.clientX;touch.cpos.y=newtouch.clientY}if(obj.ongoingTouches.length===2){d0=obj.ongoingTouches[0].cpos.dist(obj.ongoingTouches[1].cpos);d1=obj.ongoingTouches[0].ppos.dist(obj.ongoingTouches[1].ppos);evt.ddist=d0-d1;dd0=Vec2.sub(obj.ongoingTouches[0].cpos,obj.ongoingTouches[0].ppos);dd1=Vec2.sub(obj.ongoingTouches[1].cpos,obj.ongoingTouches[1].ppos);cosa=dd0.dot(dd1)/(dd0.length()*dd1.length());if(cosa>.5){evt.currentPos=obj.ongoingTouches[0].cpos;evt.previousPos=obj.ongoingTouches[0].ppos;evt.fingers=2;return obj.touchSwipe.dispatch(evt)}else{if(d0>d1){return obj.touchSpread.dispatch(evt)}else{return obj.touchPinch.dispatch(evt)}}}else if(obj.ongoingTouches.length===1){evt.currentPos=obj.ongoingTouches[0].cpos;evt.previousPos=obj.ongoingTouches[0].ppos;evt.fingers=1;return obj.touchSwipe.dispatch(evt)}};end=function(evt){var idx,newtouch,touches,_i,_len;CoffeeGL.Context.switchContext(obj);evt.preventDefault();touches=evt.changedTouches;for(_i=0,_len=touches.length;_i<_len;_i++){newtouch=touches[_i];idx=ongoingTouchIndexById(newtouch.identifier);if(newtouch.moved===false){obj.touchTap.dispatch(evt)}while(idx!==-1){obj.ongoingTouches.splice(idx,1);idx=ongoingTouchIndexById(newtouch.identifier)}}if(CoffeeGL.Context.debug){return console.log("Touch End ",obj.ongoingTouches)}};obj.canvas.ontouchend=end;return obj.canvas.ontouchcancel=end}};module.exports={Signal:Signal,makeMouseEmitter:makeMouseEmitter,makeTouchEmitter:makeTouchEmitter}}).call(this)},{"./util":15,"./math":3}],17:[function(require,module,exports){(function(){var Matrix4,PointLight,RGB,RGBA,Vec2,Vec3,Vec4,_ref,_ref1;_ref=require("./math"),Matrix4=_ref.Matrix4,Vec2=_ref.Vec2,Vec3=_ref.Vec3,Vec4=_ref.Vec4;_ref1=require("./colour"),RGB=_ref1.RGB,RGBA=_ref1.RGBA;PointLight=function(){function PointLight(pos,colour,specular,attenuation){this.pos=pos;this.colour=colour;this.specular=specular;this.attenuation=attenuation;if(this.pos==null){this.pos=new Vec3(1,1,1)}if(this.colour==null){this.colour=RGB.WHITE()}if(this.specular==null){this.specular=RGB.WHITE()}if(this.attenuation==null){this.attenuation=[100,1,.045,.0075]}this.shadow_casting=false}PointLight.prototype._addToNode=function(node){node.pointLights.push(this);node.numPointLights=node.pointLights.length;return this};PointLight.prototype._removeFromNode=function(node){node.pointLights.splice(node.pointLights.indexOf(this));node.numPointLights=node.pointLights.length;return this};return PointLight}();module.exports={PointLight:PointLight}}).call(this)},{"./math":3,"./colour":4}],18:[function(require,module,exports){(function(){var Noise,Vec2,Vec3,Vec4,_ref;_ref=require("./math"),Vec2=_ref.Vec2,Vec3=_ref.Vec3,Vec4=_ref.Vec4;Noise=function(){Noise.prototype.setSeed=function(seed){var i,v,_i,_results;if(seed>0&&seed<1){seed*=65536}seed=Math.floor(seed);if(seed<256){seed|=seed<<8}_results=[];for(i=_i=0;_i<=255;i=++_i){v=0;if(i&1){v=this.p[i]^seed&255}else{v=this.p[i]^seed>>8&255}this.perm[i]=this.perm[i+256]=v;_results.push(this.gradP[i]=this.gradP[i+256]=this.grad3[v%12])}return _results};function Noise(){this.grad3=[new Vec3(1,1,0),new Vec3(-1,1,0),new Vec3(1,-1,0),new Vec3(-1,-1,0),new Vec3(1,0,1),new Vec3(-1,0,1),new Vec3(1,0,-1),new Vec3(-1,0,-1),new Vec3(0,1,1),new Vec3(0,-1,1),new Vec3(0,1,-1),new Vec3(0,-1,-1)];this.p=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180];this.perm=new Array(512);this.gradP=new Array(512);this.setSeed(0);this.F2=.5*(Math.sqrt(3)-1);this.G2=(3-Math.sqrt(3))/6;this.F3=1/3;this.G3=1/6}Noise.prototype.simplex2=function(xin,yin){var gi0,gi1,gi2,i,i1,j,j1,n0,n1,n2,s,t,t0,t1,t2,x0,x1,x2,y0,y1,y2;n0=n1=n2=0;s=(xin+yin)*this.F2;i=Math.floor(xin+s);j=Math.floor(yin+s);t=(i+j)*this.G2;x0=xin-i+t;y0=yin-j+t;i1=j1=0;if(x0>y0){i1=1;j1=0}else{i1=0;j1=1}x1=x0-i1+this.G2;y1=y0-j1+this.G2;x2=x0-1+2*this.G2;y2=y0-1+2*this.G2;i&=255;j&=255;gi0=this.gradP[i+this.perm[j]];gi1=this.gradP[i+i1+this.perm[j+j1]];gi2=this.gradP[i+1+this.perm[j+1]];t0=.5-x0*x0-y0*y0;if(t0<0){n0=0}else{t0*=t0;n0=t0*t0*Vec3.dot(gi0,new Vec3(x0,y0,0))}t1=.5-x1*x1-y1*y1;if(t1<0){n1=0}else{t1*=t1;n1=t1*t1*Vec3.dot(gi1,new Vec3(x1,y1,0))}t2=.5-x2*x2-y2*y2;if(t2<0){n2=0}else{t2*=t2;n2=t2*t2*Vec3.dot(gi2,new Vec3(x2,y2,0))}return 70*(n0+n1+n2)};Noise.prototype.simplex3=function(xin,yin,zin){var gi0,gi1,gi2,gi3,i,i1,i2,j,j1,j2,k,k1,k2,n0,n1,n2,n3,s,t,t0,t1,t2,t3,x0,x1,x2,x3,y0,y1,y2,y3,z0,z1,z2,z3;n0=n1=n2=n3=0;s=(xin+yin+zin)*this.F3;i=Math.floor(xin+s);j=Math.floor(yin+s);k=Math.floor(zin+s);t=(i+j+k)*this.G3;x0=xin-i+t;y0=yin-j+t;z0=zin-k+t;i1=j1=k1=0;i2=j2=k2=0;if(x0>=y0){if(y0>=z0){i1=1;j1=0;k1=0;i2=1;j2=1;k2=0}else if(x0>=z0){i1=1;j1=0;k1=0;i2=1;j2=0;k2=1}else{i1=0;j1=0;k1=1;i2=1;j2=0;k2=1}}else{if(y0<z0){i1=0;j1=0;k1=1;i2=0;j2=1;k2=1}else if(x0<z0){i1=0;j1=1;k1=0;i2=0;j2=1;k2=1}else{i1=0;j1=1;k1=0;i2=1;j2=1;k2=0}}x1=x0-i1+this.G3;y1=y0-j1+this.G3;z1=z0-k1+this.G3;x2=x0-i2+2*this.G3;y2=y0-j2+2*this.G3;z2=z0-k2+2*this.G3;x3=x0-1+3*this.G3;y3=y0-1+3*this.G3;z3=z0-1+3*this.G3;i&=255;j&=255;k&=255;gi0=this.gradP[i+this.perm[j+this.perm[k]]];gi1=this.gradP[i+i1+this.perm[j+j1+this.perm[k+k1]]];gi2=this.gradP[i+i2+this.perm[j+j2+this.perm[k+k2]]];gi3=this.gradP[i+1+this.perm[j+1+this.perm[k+1]]];t0=.5-x0*x0-y0*y0-z0*z0;if(t0<0){n0=0}else{t0*=t0;n0=t0*t0*Vec3.dot(gi0,new Vec3(x0,y0,z0))}t1=.5-x1*x1-y1*y1-z1*z1;if(t1<0){n1=0}else{t1*=t1;n1=t1*t1*Vec3.dot(gi1,new Vec3(x1,y1,z1))}t2=.5-x2*x2-y2*y2-z2*z2;if(t2<0){n2=0}else{t2*=t2;n2=t2*t2*Vec3.dot(gi2,new Vec3(x2,y2,z2))}t3=.5-x3*x3-y3*y3-z3*z3;if(t3<0){n3=0}else{t3*=t3;n3=t3*t3*Vec3.dot(gi3,new Vec3(x3,y3,z3))}return 32*(n0+n1+n2+n3)};Noise.prototype.fade=function(t){return t*t*t*(t*(t*6-15)+10)};Noise.prototype.lerp=function(a,b,t){return(1-t)*a+t*b};Noise.prototype.perlin2=function(x,y){var X,Y,n00,n01,n10,n11,u;X=Math.floor(x);Y=Math.floor(y);x=x-X;y=y-Y;X=X&255;Y=Y&255;n00=Vec3.dot(this.gradP[X+this.perm[Y]],new Vec3(x,y,0));n01=Vec3.dot(this.gradP[X+this.perm[Y+1]],new Vec3(x,y-1,0));n10=Vec3.dot(this.gradP[X+1+this.perm[Y]],new Vec3(x-1,y,0));n11=Vec3.dot(this.gradP[X+1+this.perm[Y+1]],new Vec3(x-1,y-1,0));u=this.fade(x);return this.lerp(this.lerp(n00,n10,u),this.lerp(n01,n11,u),this.fade(y))};Noise.prototype.perlin3=function(x,y,z){var X,Y,Z,n000,n001,n010,n011,n100,n101,n110,n111,u,v,w;X=Math.floor(x);Y=Math.floor(y);Z=Math.floor(z);x=x-X;y=y-Y;z=z-Z;X=X&255;Y=Y&255;Z=Z&255;n000=Vec3.dot(this.gradP[X+this.perm[Y+this.perm[Z]]],new Vec3(x,y,z));n001=Vec3.dot(this.gradP[X+this.perm[Y+this.perm[Z+1]]],new Vec3(x,y,z-1));n010=Vec3.dot(this.gradP[X+this.perm[Y+1+this.perm[Z]]],new Vec3(x,y-1,z));n011=Vec3.dot(this.gradP[X+this.perm[Y+1+this.perm[Z+1]]],new Vec3(x,y-1,z-1));n100=Vec3.dot(this.gradP[X+1+this.perm[Y+this.perm[Z]]],new Vec3(x-1,y,z));n101=Vec3.dot(this.gradP[X+1+this.perm[Y+this.perm[Z+1]]],new Vec3(x-1,y,z-1));n110=Vec3.dot(this.gradP[X+1+this.perm[Y+1+this.perm[Z]]],new Vec3(x-1,y-1,z));n111=Vec3.dot(this.gradP[X+1+this.perm[Y+1+this.perm[Z]]],new Vec3(x-1,y-1,z-1));u=this.fade(x);v=this.fade(y);w=this.fade(z);return this.lerp(this.lerp(this.lerp(n000,n100,u),this.lerp(n001,n101,u),w),this.lerp(this.lerp(n010,n110,u),this.lerp(n011,n111,u),w),v)};return Noise}();module.exports={Noise:Noise}}).call(this)},{"./math":3}],19:[function(require,module,exports){(function(){var Material,RGB,RGBA,_ref;_ref=require("./colour"),RGB=_ref.RGB,RGBA=_ref.RGBA;Material=function(){function Material(ambient,diffuse,specular,shine,emissive){this.ambient=ambient;this.diffuse=diffuse;this.specular=specular;this.shine=shine;this.emissive=emissive;if(this.ambient==null){this.ambient=new RGB(0,0,0)}if(this.diffuse==null){this.diffuse=new RGB(1,1,1)}if(this.specular==null){this.specular=new RGB(1,1,1)}if(this.shine==null){this.shine=20}if(this.emissive==null){this.emissive=new RGB(0,0,0)}}Material.prototype._addToNode=function(node){return node.material=this};return Material}();module.exports={Material:Material}}).call(this)},{"./colour":4}],21:[function(require,module,exports){(function(){var CoffeeGLError,CoffeeGLWarning,Edge2,Grad,Matrix4,PI,Vec2,Vec3,Vec4,boundingBox,closestPointLine,edge2Bisector,lerp,precomputeTangent,rayCircleIntersection,rayPlaneIntersect,_precomputeTangent,_ref,_ref1;_ref=require("./math"),Vec2=_ref.Vec2,Vec3=_ref.Vec3,Vec4=_ref.Vec4,Matrix4=_ref.Matrix4,PI=_ref.PI,Edge2=_ref.Edge2;_ref1=require("./error"),CoffeeGLWarning=_ref1.CoffeeGLWarning,CoffeeGLError=_ref1.CoffeeGLError;rayPlaneIntersect=function(plane_point,plane_normal,line_point,line_dir){var den,num;num=Vec3.dot(plane_normal,Vec3.sub(plane_point,line_point));den=Vec3.dot(plane_normal,line_dir);return num/den};precomputeTangent=function(a,b,c,na,nb,nc,ta,tb,tc){return[_precomputeTangent(a,b,c,na,ta,tb,tc),_precomputeTangent(b,c,a,nb,tb,tc,ta),_precomputeTangent(c,a,b,nc,tc,ta,tb)]};_precomputeTangent=function(a,b,c,n,ta,tb,tc){var alpha,binormal,binormal2,d,e,f,g,tangent,tx,ty,tz,ux,uy,uz;d=Vec3.sub(b,a);e=Vec3.sub(c,a);f=Vec2.sub(tb,ta);g=Vec2.sub(tc,ta);alpha=1/(f.x*g.y-f.y*g.x);tx=alpha*(g.y*d.x+-f.y*e.x);ty=alpha*(g.y*d.y+-f.y*e.y);tz=alpha*(g.y*d.z+-f.y*e.z);ux=alpha*(-g.x*d.x+f.x*e.x);uy=alpha*(-g.x*d.y+f.x*e.y);uz=alpha*(-g.x*d.z+f.x*e.z);tangent=new Vec3(tx,ty,tz);binormal=new Vec3(ux,uy,uz);tangent=tangent.sub(Vec3.multScalar(n,Vec3.dot(n,tangent)));binormal2=binormal.sub(Vec3.multScalar(n,Vec3.dot(n,binormal)));binormal2=binormal2.sub(Vec3.multScalar(tangent,Vec3.dot(tangent,binormal)));tangent.normalize();binormal2.normalize();return tangent};rayCircleIntersection=function(ray_start,ray_dir,circle_centre,circle_radius){var a,b,c,d2,discriminant,f,r,t,t1,t2,v;f=CoffeeGL.Vec2.sub(ray_start,circle_centre);r=circle_radius;a=ray_dir.dot(ray_dir);b=2*f.dot(ray_dir);c=f.dot(f)-r*r;v=new CoffeeGL.Vec2;discriminant=b*b-4*a*c;if(discriminant!==0){discriminant=Math.sqrt(discriminant);t1=(-b-discriminant)/(2*a);t2=(-b+discriminant)/(2*a);t=t2;if(t2<0){t=t1}v.copyFrom(ray_start);d2=CoffeeGL.Vec2.multScalar(ray_dir,t);v.add(d2)}return v};boundingBox=function(points){var max,min,point,_i,_j,_len,_len1;if(points.length){if(points[0]._DIM===3){min=new CoffeeGL.Vec3(Infinity,Infinity,Infinity);max=new CoffeeGL.Vec3(-Infinity,-Infinity,-Infinity);for(_i=0,_len=points.length;_i<_len;_i++){point=points[_i];if(point.x<min.x){min.x=point.x}if(point.y<min.y){min.y=point.y}if(point.x>max.x){max.x=point.x}if(point.y>max.y){max.y=point.y}}}else if(points[1]._DIM===2){min=new CoffeeGL.Vec2(Infinity,Infinity);max=new CoffeeGL.Vec2(-Infinity,-Infinity);for(_j=0,_len1=points.length;_j<_len1;_j++){point=points[_j];if(point.x<min.x){min.x=point.x}if(point.y<min.y){min.y=point.y}if(point.z<min.z){min.z=point.z}if(point.x>max.x){max.x=point.x}if(point.y>max.y){max.y=point.y}if(point.z>max.z){max.z=point.z}}}}return[min,max]};edge2Bisector=function(edge0,edge1){var e0,e1;if(edge0.start===edge1.start){e0=Vec2.normalize(Vec2.sub(edge0.end,edge0.start));e1=Vec2.normalize(Vec2.sub(edge1.end,edge1.start));return new new Edge2(edge0.start,Vec2.add(edge0.start,Vec2.normalize(e0.add(e1))))}else if(edge0.end===edge1.start){e0=Vec2.normalize(Vec2.sub(edge0.start,edge0.end));e1=Vec2.normalize(Vec2.sub(edge1.end,edge1.start));return new Edge2(edge0.end,Vec2.add(edge0.end,Vec2.normalize(e0.add(e1))))}else if(edge0.start===edge1.end){e0=Vec2.normalize(Vec2.sub(edge0.end,edge0.start));e1=Vec2.normalize(Vec2.sub(edge1.start,edge1.end));return new Edge2(edge0.start,Vec2.add(edge0.start,Vec2.normalize(e0.add(e1))))}else if(edge0.end===edge1.end){e0=Vec2.normalize(Vec2.sub(edge0.start,edge0.end));e1=Vec2.normalize(Vec2.sub(edge1.start,edge1.end));return new Edge2(edge0.end,Vec2.add(edge0.end,Vec2.normalize(e0.add(e1))))}else{return CoffeeGLError("edge2Bisector - edges must have a common Vec2")}};lerp=function(bottom,top,value){return(value-bottom)/(top-bottom)};Grad=function(){function Grad(x,y,z){this.x=x;this.y=y;this.z=z}Grad.prototype.dot2=function(x,y){return this.x*x+this.y*y};Grad.prototype.dot3=function(x,y,z){return this.x*x+this.y*y+this.z*z};return Grad}();closestPointLine=function(a,b,p){var c,cross0,cross1,dir,m,perp,v0,v1,xp,yp;dir=Vec2.sub(b,a);perp=new Vec3(dir.y,-dir.x,0);v0=Vec3.sub(new Vec3(b.x,b.y),new Vec3(a.x,a.y));v1=Vec3.sub(new Vec3(a.x,a.y),new Vec3(b.x,b.y));cross0=Vec3.cross(perp,v0);cross1=Vec3.cross(perp,v1);if(cross0.z<0){return b}else if(cross1.z>0){return a}dir=Vec2.sub(b,a);if(dir.x===0){return new Vec3(0,p.y)}if(dir.y===0){return new Vec3(p.x,0)}m=dir.y/dir.x;c=a.y-m*a.x;xp=(m*p.y+p.x-m*c)/(m*m+1);yp=m*xp+c;return new Vec2(xp,yp)};module.exports={boundingBox:boundingBox,edge2Bisector:edge2Bisector,rayPlaneIntersect:rayPlaneIntersect,rayCircleIntersection:rayCircleIntersection,precomputeTangent:precomputeTangent,closestPointLine:closestPointLine,lerp:lerp}}).call(this)},{"./math":3,"./error":20}],22:[function(require,module,exports){(function(){var CoffeeGLWarning,Interpolation,Matrix4,RGB,RGBA,Vec2,Vec3,Vec4,_ref,_ref1;_ref=require("./math"),Vec2=_ref.Vec2,Vec3=_ref.Vec3,Vec4=_ref.Vec4,Matrix4=_ref.Matrix4;_ref1=require("./colour"),RGB=_ref1.RGB,RGBA=_ref1.RGBA;CoffeeGLWarning=require("./error").CoffeeGLWarning;Interpolation=function(){function Interpolation(obj0,obj1){this.obj0=obj0;this.obj1=obj1;if(typeof this.obj0==="object"){if(this.obj0.__proto__!==this.obj1.__proto__){CoffeeGLWarning("Interpolating two different objects")}}if(this.obj0 instanceof Vec2){this._set=this._setVec2}else if(this.obj0 instanceof Vec3){this._set=this._setVec3}else if(this.obj0 instanceof Vec4){this._set=this._setVec4}else if(this.obj0 instanceof RGB){this._set=this._setRGB}else if(this.obj0 instanceof RGBA){this._set=this._setRGBA}else if(typeof obj0==="number"){this._set=this._setScalar}this._value=0}Interpolation.prototype.set=function(val){this._value=val;return this._set()};Interpolation.prototype._setVec2=function(){return new Vec2(this.obj0.x+(this.obj.x-this.obj0.x)*this._value,this.obj0.y+(this.obj1.y-this.obj0.y)*this._value)};Interpolation.prototype._setVec3=function(){return new Vec3(this.obj0.x+(this.obj1.x-this.obj0.x)*this._value,this.obj0.y+(this.obj1.y-this.obj0.y)*this._value,this.obj0.z+(this.obj1.z-this.obj0.z)*this._value)};Interpolation.prototype._setVec4=function(){return new Vec4(this.obj0.x+(this.obj1.x-this.obj0.x)*this._value,this.obj0.y+(this.obj1.y-this.obj0.y)*this._value,this.obj0.z+(this.obj1.z-this.obj0.z)*this._value,this.obj0.w+(this.obj1.w-this.obj0.w)*this._value)};Interpolation.prototype._setRGB=function(){return new RGB(this.obj0.r+(this.obj1.r-this.obj0.r)*this._value,this.obj0.g+(this.obj1.g-this.obj0.g)*this._value,this.obj0.b+(this.obj1.b-this.obj0.b)*this._value)};Interpolation.prototype._setRGBA=function(){return new RGBA(this.obj0.r+(this.obj1.r-this.obj0.r)*this._value,this.obj0.g+(this.obj1.g-this.obj0.g)*this._value,this.obj0.b+(this.obj1.b-this.obj0.b)*this._value,this.obj0.a+(this.obj1.a-this.obj0.a)*this._value)};Interpolation.prototype._setScalar=function(){return this.obj0+(this.obj1-this.obj0)*this._value};return Interpolation}();module.exports={Interpolation:Interpolation}}).call(this)},{"./math":3,"./colour":4,"./error":20}],23:[function(require,module,exports){(function(){var Beachsection,Cell,CircleEvent,Diagram,Edge,Edge2,Halfedge,RedBlackTree,Vec2,Vec3,Voronoi,_ref;_ref=require("./math"),Vec2=_ref.Vec2,Vec3=_ref.Vec3,Edge2=_ref.Edge2;RedBlackTree=require("./red_black_tree").RedBlackTree;Edge=function(){function Edge(lSite,rSite){this.lSite=lSite;this.rSite=rSite;this.va=this.vb=null}return Edge}();Cell=function(){function Cell(site){this.site=site;this.halfedges=[];this.closeMe=false}Cell.prototype.init=function(site){this.site=site;this.halfedges=[];this.closeMe=false;return this};Cell.prototype.prepareHalfedges=function(){var edge,halfedges,iHalfedge;halfedges=this.halfedges;iHalfedge=halfedges.length;edge;while(iHalfedge--){edge=halfedges[iHalfedge].edge;if(!edge.vb||!edge.va){halfedges.splice(iHalfedge,1)}}halfedges.sort(function(a,b){return b.angle-a.angle});return halfedges.length};Cell.prototype.getNeighborIds=function(){var edge,iHalfedge,neighbors;neighbors=[];iHalfedge=this.halfedges.length;edge;while(iHalfedge--){edge=this.halfedges[iHalfedge].edge;if(edge.lSite!==null&&edge.lSite.voronoiId!==this.site.voronoiId){neighbors.push(edge.lSite.voronoiId)}else if(edge.rSite!==null&&edge.rSite.voronoiId!==this.site.voronoiId){neighbors.push(edge.rSite.voronoiId)}}return neighbors};Cell.prototype.getBbox=function(){var halfedges,iHalfedge,rval,v,vx,vy,xmax,xmin,ymax,ymin;halfedges=this.halfedges;iHalfedge=halfedges.length;xmin=Infinity;ymin=Infinity;xmax=-Infinity;ymax=-Infinity;v;vx;vy;while(iHalfedge--){v=halfedges[iHalfedge].getStartpoint();vx=v.x;vy=v.y;if(vx<xmin){xmin=vx}if(vy<ymin){ymin=vy}if(vx>xmax){xmax=vx}if(vy>ymax){ymax=vy}rval={x:xmin,y:ymin,width:xmax-xmin,height:ymax-ymin};return rval}};Cell.prototype.pointIntersection=function(x,y){var halfedge,halfedges,iHalfedge,p0,p1,r;halfedges=this.halfedges;iHalfedge=halfedges.length;halfedge;p0;p1;r;while(iHalfedge--){halfedge=halfedges[iHalfedge];p0=halfedge.getStartpoint();p1=halfedge.getEndpoint();r=(y-p0.y)*(p1.x-p0.x)-(x-p0.x)*(p1.y-p0.y);if(!r){return 0}if(r>0){return-1}}return 1};return Cell}();Diagram=function(){function Diagram(site){this.site=site;this}return Diagram}();Halfedge=function(){function Halfedge(edge,lSite,rSite){var va,vb;this.edge=edge;this.site=lSite;if(rSite){this.angle=Math.atan2(rSite.y-lSite.y,rSite.x-lSite.x)}else{va=edge.va;vb=edge.vb;if(edge.lSite===lSite){this.angle=Math.atan2(vb.x-va.x,va.y-vb.y)}else{Math.atan2(va.x-vb.x,vb.y-va.y)}}}Halfedge.prototype.getStartpoint=function(){if(this.edge.lSite===this.site){return this.edge.va}return this.edge.vb};Halfedge.prototype.getEndpoint=function(){if(this.edge.lSite===this.site){return this.edge.vb}return this.edge.va};return Halfedge}();Beachsection=function(){function Beachsection(){this}return Beachsection}();CircleEvent=function(){function CircleEvent(){this.arc=null;this.rbLeft=null;this.rbNext=null;this.rbParent=null;this.rbPrevious=null;this.rbRed=false;this.rbRight=null;this.site=null;this.x=this.y=this.ycenter=0}return CircleEvent}();Voronoi=function(){function Voronoi(){this.vertices=null;this.edges=null;this.cells=null;this.toRecycle=null;this.beachsectionJunkyard=[];this.circleEventJunkyard=[];this.vertexJunkyard=[];this.edgeJunkyard=[];this.cellJunkyard=[]}Voronoi.abs=Math.abs;Voronoi.epsilon=1e-9;Voronoi.invepsilon=1/Voronoi.epsilon;Voronoi.prototype.equalWithEpsilon=function(a,b){return Math.abs(a-b)<1e-9};Voronoi.prototype.greaterThanWithEpsilon=function(a,b){return a-b>1e-9};Voronoi.prototype.greaterThanOrEqualWithEpsilon=function(a,b){return b-a<1e-9};Voronoi.prototype.lessThanWithEpsilon=function(a,b){return b-a>1e-9};Voronoi.prototype.lessThanOrEqualWithEpsilon=function(a,b){return a-b<1e-9};Voronoi.prototype.createHalfedge=function(edge,lSite,rSite){return new Halfedge(edge,lSite,rSite)};Voronoi.prototype.reset=function(){var beachsection;if(!this.beachline){this.beachline=new RedBlackTree}if(this.beachline.root){beachsection=this.beachline.getFirst(this.beachline.root);while(beachsection){this.beachsectionJunkyard.push(beachsection);beachsection=beachsection.rbNext}}this.beachline.root=null;if(!this.circleEvents){this.circleEvents=new RedBlackTree}this.circleEvents.root=this.firstCircleEvent=null;this.vertices=[];this.edges=[];this.cells=[];return this.segments=[]};Voronoi.prototype.createVertex=function(x,y){var v;v=this.vertexJunkyard.pop();if(!v){v=new Vec2(x,y)}else{v.x=x;v.y=y}this.vertices.push(v);return v};Voronoi.prototype.createEdge=function(lSite,rSite,va,vb){var edge;edge=this.edgeJunkyard.pop();if(!edge){edge=new Edge(lSite,rSite)}else{edge.lSite=lSite;edge.rSite=rSite;edge.va=edge.vb=null}this.edges.push(edge);if(va){this.setEdgeStartpoint(edge,lSite,rSite,va)}if(vb){this.setEdgeEndpoint(edge,lSite,rSite,vb)}this.cells[lSite.voronoiId].halfedges.push(this.createHalfedge(edge,lSite,rSite));this.cells[rSite.voronoiId].halfedges.push(this.createHalfedge(edge,rSite,lSite));return edge};Voronoi.prototype.createBorderEdge=function(lSite,va,vb){var edge;edge=this.edgeJunkyard.pop();if(!edge){edge=new Edge(lSite,null)}else{edge.lSite=lSite;edge.rSite=null}edge.va=va;edge.vb=vb;this.edges.push(edge);return edge};Voronoi.prototype.setEdgeStartpoint=function(edge,lSite,rSite,vertex){if(!edge.va&&!edge.vb){edge.va=vertex;edge.lSite=lSite;return edge.rSite=rSite}else if(edge.lSite===rSite){return edge.vb=vertex}else{return edge.va=vertex}};Voronoi.prototype.setEdgeEndpoint=function(edge,lSite,rSite,vertex){return this.setEdgeStartpoint(edge,rSite,lSite,vertex)};Voronoi.prototype.createCell=function(site){var cell;cell=this.cellJunkyard.pop();if(cell){return cell.init(site)}return new Cell(site)};Voronoi.prototype.createBeachsection=function(site){var beachsection;beachsection=this.beachsectionJunkyard.pop();if(!beachsection){beachsection=new Beachsection}beachsection.site=site;return beachsection};Voronoi.prototype.leftBreakPoint=function(arc,directrix){var aby2,b,hl,lArc,lfocx,lfocy,pby2,plby2,rfocx,rfocy,site;site=arc.site;rfocx=arc.site.x;rfocy=arc.site.y;pby2=rfocy-directrix;if(!pby2){return rfocx}lArc=arc.rbPrevious;if(!lArc){return-Infinity}site=lArc.site;lfocx=site.x;lfocy=site.y;plby2=lfocy-directrix;if(!plby2){return lfocx}hl=lfocx-rfocx;aby2=1/pby2-1/plby2;b=hl/plby2;if(aby2){return(-b+Math.sqrt(b*b-2*aby2*(hl*hl/(-2*plby2)-lfocy+plby2/2+rfocy-pby2/2)))/aby2+rfocx}return(rfocx+lfocx)/2};Voronoi.prototype.rightBreakPoint=function(arc,directrix){var rArc,site;rArc=arc.rbNext;if(rArc){return this.leftBreakPoint(rArc,directrix)}site=arc.site;if(site.y===directrix){return site.x}return Infinity};Voronoi.prototype.detachBeachsection=function(beachsection){this.detachCircleEvent(beachsection);this.beachline.removeNode(beachsection);return this.beachsectionJunkyard.push(beachsection)};Voronoi.prototype.removeBeachsection=function(beachsection){var abs_fn,circle,disappearingTransitions,iArc,lArc,nArcs,next,previous,rArc,vertex,x,y,_i,_ref1;circle=beachsection.circleEvent;x=circle.x;y=circle.ycenter;vertex=this.createVertex(x,y);previous=beachsection.rbPrevious;next=beachsection.rbNext;disappearingTransitions=[beachsection];abs_fn=Math.abs;this.detachBeachsection(beachsection);lArc=previous;while(lArc.circleEvent&&abs_fn(x-lArc.circleEvent.x)<1e-9&&abs_fn(y-lArc.circleEvent.ycenter)<1e-9){previous=lArc.rbPrevious;disappearingTransitions.unshift(lArc);this.detachBeachsection(lArc);lArc=previous}disappearingTransitions.unshift(lArc);this.detachCircleEvent(lArc);rArc=next;while(rArc.circleEvent&&abs_fn(x-rArc.circleEvent.x)<1e-9&&abs_fn(y-rArc.circleEvent.ycenter)<1e-9){next=rArc.rbNext;disappearingTransitions.push(rArc);this.detachBeachsection(rArc);rArc=next}disappearingTransitions.push(rArc);this.detachCircleEvent(rArc);nArcs=disappearingTransitions.length;iArc;for(iArc=_i=1,_ref1=nArcs-1;1<=_ref1?_i<=_ref1:_i>=_ref1;iArc=1<=_ref1?++_i:--_i){rArc=disappearingTransitions[iArc];lArc=disappearingTransitions[iArc-1];this.setEdgeStartpoint(rArc.edge,lArc.site,rArc.site,vertex)}lArc=disappearingTransitions[0];rArc=disappearingTransitions[nArcs-1];rArc.edge=this.createEdge(lArc.site,rArc.site,void 0,vertex);this.attachCircleEvent(lArc);return this.attachCircleEvent(rArc)};Voronoi.prototype.addBeachsection=function(site){var ax,ay,cx,cy,d,directrix,dx,dxl,dxr,dy,hb,hc,lArc,lSite,newArc,node,rArc,rSite,vertex,x;x=site.x;directrix=site.y;lArc;rArc;dxl;dxr;node=this.beachline.root;while(node){dxl=this.leftBreakPoint(node,directrix)-x;if(dxl>1e-9){node=node.rbLeft}else{dxr=x-this.rightBreakPoint(node,directrix);if(dxr>1e-9){if(!node.rbRight){lArc=node;break}node=node.rbRight}else{if(dxl>-1e-9){lArc=node.rbPrevious;rArc=node}else if(dxr>-1e-9){lArc=node;rArc=node.rbNext}else{lArc=rArc=node}break}}}newArc=this.createBeachsection(site);this.beachline.insertSuccessor(lArc,newArc);if(!lArc&&!rArc){return}if(lArc===rArc){this.detachCircleEvent(lArc);rArc=this.createBeachsection(lArc.site);this.beachline.insertSuccessor(newArc,rArc);newArc.edge=rArc.edge=this.createEdge(lArc.site,newArc.site);this.attachCircleEvent(lArc);this.attachCircleEvent(rArc);return}if(lArc&&!rArc){newArc.edge=this.createEdge(lArc.site,newArc.site);return}if(lArc!==rArc){this.detachCircleEvent(lArc);this.detachCircleEvent(rArc);lSite=lArc.site;ax=lSite.x;ay=lSite.y;dx=site.x-ax;dy=site.y-ay;rSite=rArc.site;cx=rSite.x-ax;cy=rSite.y-ay;d=2*(dx*cy-dy*cx);hb=dx*dx+dy*dy;hc=cx*cx+cy*cy;vertex=this.createVertex((cy*hb-dy*hc)/d+ax,(dx*hc-cx*hb)/d+ay);this.setEdgeStartpoint(rArc.edge,lSite,rSite,vertex);newArc.edge=this.createEdge(lSite,site,void 0,vertex);rArc.edge=this.createEdge(site,rSite,void 0,vertex);this.attachCircleEvent(lArc);this.attachCircleEvent(rArc)}};Voronoi.prototype.attachCircleEvent=function(arc){var ax,ay,cSite,circleEvent,cx,cy,d,dx,dy,ha,hc,lArc,lSite,node,predecessor,rArc,rSite,x,y,ycenter;lArc=arc.rbPrevious;rArc=arc.rbNext;if(!lArc||!rArc){return}lSite=lArc.site;cSite=arc.site;rSite=rArc.site;if(lSite===rSite){return}dx=cSite.x;dy=cSite.y;ax=lSite.x-dx;ay=lSite.y-dy;cx=rSite.x-dx;cy=rSite.y-dy;d=2*(ax*cy-ay*cx);if(d>=-2e-12){return}ha=ax*ax+ay*ay;hc=cx*cx+cy*cy;x=(cy*ha-ay*hc)/d;y=(ax*hc-cx*ha)/d;ycenter=y+dy;circleEvent=this.circleEventJunkyard.pop();if(!circleEvent){circleEvent=new CircleEvent}circleEvent.arc=arc;circleEvent.site=cSite;circleEvent.x=x+dx;circleEvent.y=ycenter+Math.sqrt(x*x+y*y);circleEvent.ycenter=ycenter;arc.circleEvent=circleEvent;predecessor=null;node=this.circleEvents.root;while(node){if(circleEvent.y<node.y||circleEvent.y===node.y&&circleEvent.x<=node.x){if(node.rbLeft){node=node.rbLeft}else{predecessor=node.rbPrevious;break}}else{if(node.rbRight){node=node.rbRight}else{predecessor=node;break}}}this.circleEvents.insertSuccessor(predecessor,circleEvent);if(!predecessor){return this.firstCircleEvent=circleEvent}};Voronoi.prototype.detachCircleEvent=function(arc){var circleEvent;circleEvent=arc.circleEvent;if(circleEvent){if(!circleEvent.rbPrevious){this.firstCircleEvent=circleEvent.rbNext}this.circleEvents.removeNode(circleEvent);this.circleEventJunkyard.push(circleEvent);return arc.circleEvent=null}};Voronoi.prototype.connectEdge=function(edge,bbox){var fb,fm,fx,fy,lSite,lx,ly,rSite,rx,ry,va,vb,xl,xr,yb,yt;vb=edge.vb;if(!!vb){return true}va=edge.va;xl=bbox.xl;xr=bbox.xr;yt=bbox.yt;yb=bbox.yb;lSite=edge.lSite;rSite=edge.rSite;lx=lSite.x;ly=lSite.y;rx=rSite.x;ry=rSite.y;fx=(lx+rx)/2;fy=(ly+ry)/2;fm;fb;this.cells[lSite.voronoiId].closeMe=true;this.cells[rSite.voronoiId].closeMe=true;if(ry!==ly){fm=(lx-rx)/(ry-ly);fb=fy-fm*fx}if(fm===void 0){if(fx<xl||fx>=xr){return false}if(lx>rx){if(!va||va.y<yt){va=this.createVertex(fx,yt)}else if(va.y>=yb){return false}vb=this.createVertex(fx,yb)}else{if(!va||va.y>yb){va=this.createVertex(fx,yb)}else if(va.y<yt){return false}vb=this.createVertex(fx,yt)}}else if(fm<-1||fm>1){if(lx>rx){if(!va||va.y<yt){va=this.createVertex((yt-fb)/fm,yt)}else if(va.y>=yb){return false}vb=this.createVertex((yb-fb)/fm,yb)}else{if(!va||va.y>yb){va=this.createVertex((yb-fb)/fm,yb)}else if(va.y<yt){return false}vb=this.createVertex((yt-fb)/fm,yt)}}else{if(ly<ry){if(!va||va.x<xl){va=this.createVertex(xl,fm*xl+fb)}else if(va.x>=xr){return false}vb=this.createVertex(xr,fm*xr+fb)}else{if(!va||va.x>xr){va=this.createVertex(xr,fm*xr+fb)}else if(va.x<xl){return false}vb=this.createVertex(xl,fm*xl+fb)}}edge.va=va;edge.vb=vb;return true};Voronoi.prototype.clipEdge=function(edge,bbox){var ax,ay,dx,dy,q,r,t0,t1;ax=edge.va.x;ay=edge.va.y;dx=edge.vb.x;dy=edge.vb.y;t0=0;t1=1;dx=dx-ax;dy=dy-ay;q=ax-bbox.xl;if(dx===0&&q<0){return false}r=-q/dx;if(dx<0){if(r<t0){return false}if(r<t1){t1=r}}else if(dx>0){if(r>t1){return false}if(r>t0){t0=r}}q=bbox.xr-ax;if(dx===0&&q<0){return false}r=q/dx;if(dx<0){if(r>t1){return false}if(r>t0){t0=r}}else if(dx>0){if(r<t0){return false}if(r<t1){t1=r}}q=ay-bbox.yt;if(dy===0&&q<0){return false}r=-q/dy;if(dy<0){if(r<t0){return false}if(r<t1){t1=r}}else if(dy>0){if(r>t1){return false}if(r>t0){t0=r}}q=bbox.yb-ay;if(dy===0&&q<0){return false}r=q/dy;if(dy<0){if(r>t1){return false}if(r>t0){t0=r}}else if(dy>0){if(r<t0){return false
}if(r<t1){t1=r}}if(t0>0){edge.va=this.createVertex(ax+t0*dx,ay+t0*dy)}if(t1<1){edge.vb=this.createVertex(ax+t1*dx,ay+t1*dy)}if(t0>0||t1<1){this.cells[edge.lSite.voronoiId].closeMe=true;this.cells[edge.rSite.voronoiId].closeMe=true}return true};Voronoi.prototype.clipEdges=function(bbox){var abs_fn,edge,edges,iEdge,_results;edges=this.edges;iEdge=edges.length;edge;abs_fn=Math.abs;_results=[];while(iEdge--){edge=edges[iEdge];if(!this.connectEdge(edge,bbox)||!this.clipEdge(edge,bbox)||abs_fn(edge.va.x-edge.vb.x)<1e-9&&abs_fn(edge.va.y-edge.vb.y)<1e-9){edge.va=edge.vb=null;_results.push(edges.splice(iEdge,1))}else{_results.push(void 0)}}return _results};Voronoi.prototype.closeCells=function(bbox){var abs_fn,cell,cells,edge,halfedges,iCell,iLeft,lastBorderSegment,nHalfedges,tx,ty,va,vb,vz,xl,xr,yb,yt,_results;xl=bbox.xl;xr=bbox.xr;yt=bbox.yt;yb=bbox.yb;cells=this.cells;iCell=cells.length;cell;iLeft;halfedges;nHalfedges;edge;va;vb;vz;lastBorderSegment;abs_fn=Math.abs;_results=[];while(iCell--){cell=cells[iCell];if(!cell.prepareHalfedges()){continue}if(!cell.closeMe){continue}halfedges=cell.halfedges;nHalfedges=halfedges.length;iLeft=0;while(iLeft<nHalfedges){va=halfedges[iLeft].getEndpoint();vz=halfedges[(iLeft+1)%nHalfedges].getStartpoint();if(abs_fn(va.x-vz.x)>=1e-9||abs_fn(va.y-vz.y)>=1e-9){switch(true){case this.equalWithEpsilon(va.x,xl)&&this.lessThanWithEpsilon(va.y,yb):lastBorderSegment=this.equalWithEpsilon(vz.x,xl);ty=yb;if(lastBorderSegment){ty=vz.y}vb=this.createVertex(xl,ty);edge=this.createBorderEdge(cell.site,va,vb);iLeft++;halfedges.splice(iLeft,0,this.createHalfedge(edge,cell.site,null));nHalfedges++;if(lastBorderSegment){break}va=vb;break;case this.equalWithEpsilon(va.y,yb)&&this.lessThanWithEpsilon(va.x,xr):lastBorderSegment=this.equalWithEpsilon(vz.y,yb);tx=xr;if(lastBorderSegment){tx=vz.x}vb=this.createVertex(tx,yb);edge=this.createBorderEdge(cell.site,va,vb);iLeft++;halfedges.splice(iLeft,0,this.createHalfedge(edge,cell.site,null));nHalfedges++;if(lastBorderSegment){break}va=vb;break;case this.equalWithEpsilon(va.x,xr)&&this.greaterThanWithEpsilon(va.y,yt):lastBorderSegment=this.equalWithEpsilon(vz.x,xr);ty=yt;if(lastBorderSegment){ty=vz.y}vb=this.createVertex(xr,ty);edge=this.createBorderEdge(cell.site,va,vb);iLeft++;halfedges.splice(iLeft,0,this.createHalfedge(edge,cell.site,null));nHalfedges++;if(lastBorderSegment){break}va=vb;break;case this.equalWithEpsilon(va.y,yt)&&this.greaterThanWithEpsilon(va.x,xl):lastBorderSegment=this.equalWithEpsilon(vz.y,yt);tx=xl;if(lastBorderSegment){tx=vz.x}vb=this.createVertex(tx,yt);edge=this.createBorderEdge(cell.site,va,vb);iLeft++;halfedges.splice(iLeft,0,this.createHalfedge(edge,cell.site,null));nHalfedges++;if(lastBorderSegment){break}va=vb;lastBorderSegment=this.equalWithEpsilon(vz.x,xl);ty=yb;if(lastBorderSegment){ty=vz.y}vb=this.createVertex(xl,ty);edge=this.createBorderEdge(cell.site,va,vb);iLeft++;halfedges.splice(iLeft,0,this.createHalfedge(edge,cell.site,null));nHalfedges++;if(lastBorderSegment){break}va=vb;lastBorderSegment=this.equalWithEpsilon(vz.y,yb);tx=xr;if(lastBorderSegment){tx=vz.x}vb=this.createVertex(tx,yb);edge=this.createBorderEdge(cell.site,va,vb);iLeft++;halfedges.splice(iLeft,0,this.createHalfedge(edge,cell.site,null));nHalfedges++;if(lastBorderSegment){break}va=vb;lastBorderSegment=this.equalWithEpsilon(vz.x,xr);ty=yt;if(lastBorderSegment){ty=vz.y}vb=this.createVertex(xr,ty);edge=this.createBorderEdge(cell.site,va,vb);iLeft++;halfedges.splice(iLeft,0,this.createHalfedge(edge,cell.site,null));nHalfedges++;if(lastBorderSegment){break}break;default:throw"Voronoi.closeCells() > this makes no sense!"}}iLeft++}_results.push(cell.closeMe=false)}return _results};Voronoi.prototype.dumpBeachline=function(y){var bs,_results;console.log("Voronoi.dumpBeachline(%f) > Beachsections, from left to right:",y);if(!this.beachline){return console.log("  None")}else{bs=this.beachline.getFirst(this.beachline.root);_results=[];while(bs){console.log("  site %d: xl: %f, xr: %f",bs.site.voronoiId,this.leftBreakPoint(bs,y),this.rightBreakPoint(bs,y));_results.push(bs=bs.rbNext)}return _results}};Voronoi.prototype.isSegment=function(site){var edge,_i,_len,_ref1;_ref1=this.segments;for(_i=0,_len=_ref1.length;_i<_len;_i++){edge=_ref1[_i];if(site===edge[0]||site===edge[1]){return true}}return false};Voronoi.prototype.quantizeSites=function(sites){var e,n,site,_results;e=this.epsilon;n=sites.length;site;_results=[];while(n--){site=sites[n];site.x=Math.floor(site.x/e)*e;_results.push(site.y=Math.floor(site.y/e)*e)}return _results};Voronoi.prototype.recycle=function(diagram){if(diagram){if(diagram instanceof Diagram){return this.toRecycle=diagram}else{throw"Voronoi.recycleDiagram() > Need a Diagram object."}}};Voronoi.prototype.compute=function(sites,bbox,segments){var cells,circle,diagram,site,siteEvents,siteid,startTime,stopTime,xsitex,xsitey;startTime=new Date;this.reset();this.segments=segments;if(this.toRecycle){this.vertexJunkyard=this.vertexJunkyard.concat(this.toRecycle.vertices);this.edgeJunkyard=this.edgeJunkyard.concat(this.toRecycle.edges);this.cellJunkyard=this.cellJunkyard.concat(this.toRecycle.cells);this.toRecycle=null}siteEvents=sites.slice(0);siteEvents.sort(function(a,b){var r;r=b.y-a.y;if(r){return r}return b.x-a.x});site=siteEvents.pop();siteid=0;xsitex;xsitey;cells=this.cells;circle;while(true){circle=this.firstCircleEvent;if(site&&(!circle||site.y<circle.y||site.y===circle.y&&site.x<circle.x)){if(site.x!==xsitex||site.y!==xsitey){cells[siteid]=this.createCell(site);site.voronoiId=siteid++;this.addBeachsection(site);xsitey=site.y;xsitex=site.x}site=siteEvents.pop()}else if(circle){this.removeBeachsection(circle.arc)}else{break}}this.clipEdges(bbox);this.closeCells(bbox);stopTime=new Date;diagram=new Diagram;diagram.cells=this.cells;diagram.edges=this.edges;diagram.vertices=this.vertices;diagram.execTime=stopTime.getTime()-startTime.getTime();this.reset();return diagram};return Voronoi}();module.exports={Voronoi:Voronoi}}).call(this)},{"./math":3,"./red_black_tree":29}],24:[function(require,module,exports){(function(){var Edge2,MedialComponent,MedialComponentEdge,MedialComponentParabola,MedialGraph,Parabola,Vec2,edge2Bisector,medialAxis2D,_ref,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};_ref=require("./math"),Vec2=_ref.Vec2,Edge2=_ref.Edge2,Parabola=_ref.Parabola;edge2Bisector=require("./math_functions").edge2Bisector;MedialComponent=function(){function MedialComponent(start,end){this.start=start;this.end=end;this}return MedialComponent}();MedialComponentEdge=function(_super){__extends(MedialComponentEdge,_super);function MedialComponentEdge(edge){this.edge=edge;this}MedialComponentEdge.prototype.sample=function(dt){var dx;dx=(this.end.x-this.start.x)*dt+this.start.x;return this.edge.sample(dx)};return MedialComponentEdge}(MedialComponent);MedialComponentParabola=function(_super){__extends(MedialComponentParabola,_super);function MedialComponentParabola(parabola){this.parabola=parabola;this}MedialComponentParabola.prototype.sample=function(dt){var dx,dy,y0,y1,_ref1;dx=(this.end.x-this.start.x)*dt+this.start.x;dy=(this.end.y-this.start.y)*dt+this.start.y;_ref1=this.parabola.sample(dx),y0=_ref1[0],y1=_ref1[1];if(y1!==y0){if(Math.abs(y0-dy)<Math.abs(y1-dy)){return y0}else{return y1}}return y0};return MedialComponentParabola}(MedialComponent);MedialGraph=function(){function MedialGraph(){this.components=[];this.right_handed=true}MedialGraph.prototype.voronoiEdgeEdge=function(edge0,edge1){var a,b,bisector,c,cp,influence_point,knot_point,long_edge,parabola,parta,short_edge,_ref1,_ref2;bisector=edge2Bisector(edge0,edge1);short_edge=edge1;long_edge=edge0;if(edge0.length()<edge1.length()){short_edge=edge0;long_edge=edge1}_ref1=this.edgeLineInfluence(bisector,short_edge,this.right_handed),knot_point=_ref1[0],influence_point=_ref1[1];parta=new Edge2(bisector.start,knot_point);this.components.push(new MedialComponentEdge(parta));_ref2=long_edge.equation(),a=_ref2[0],b=_ref2[1],c=_ref2[2];parabola=new Parabola(influence_point,a,b,c);cp=this.edgeParabolaInfluence(parabola,long_edge,this.right_handed);return parabola};MedialGraph.prototype.edgeParabolaInfluence=function(parabola,edge,right){var e0,e1,ea,eb,ec,epoints,pea,peb,pec,point,psa,psb,psc,rp,s0,s1,spoints,tt,_i,_j,_len,_len1,_ref1,_ref2,_ref3;_ref1=edge.equation(),ea=_ref1[0],eb=_ref1[1],ec=_ref1[2];psa=eb;psb=-ea;psc=ea*edge.start.x+eb*edge.start.y+ec-eb*edge.start.x+ea*edge.start.y;pea=eb;peb=-ea;pec=ea*edge.end.x+eb*edge.end.y+ec-eb*edge.end.x+ea*edge.end.y;_ref2=parabola.lineCrossing(psa,psb,psc),s0=_ref2[0],s1=_ref2[1];_ref3=parabola.lineCrossing(pea,peb,pec),e0=_ref3[0],e1=_ref3[1];console.log(s0,s1);console.log(e0,e1);spoints=[Vec2.normalize(s0),Vec2.normalize(s1)];epoints=[Vec2.normalize(e0),Vec2.normalize(e1)];tt=Vec2.normalize(edge.start);rp=[];for(_i=0,_len=spoints.length;_i<_len;_i++){point=spoints[_i];if(right){if(tt.dot(point)>0){rp.push([point,edge.start])}}else if(tt.dot(point)<=0){rp.push([point,edge.start])}}for(_j=0,_len1=epoints.length;_j<_len1;_j++){point=epoints[_j];if(right){if(tt.dot(point)>0){rp.push([point,edge.end])}}else if(tt.dot(point)<=0){rp.push([point,edge.end])}}return rp};MedialGraph.prototype.edgeLineInfluence=function(line,edge,right){var a,b,c,ea,eb,ec,end_cross,pea,peb,pec,psa,psb,psc,start_cross,ts,tt,xe,xs,ye,ys,_ref1,_ref2;_ref1=edge.equation(),ea=_ref1[0],eb=_ref1[1],ec=_ref1[2];_ref2=line.equation(),a=_ref2[0],b=_ref2[1],c=_ref2[2];psa=eb;psb=-ea;psc=ea*edge.start.x+eb*edge.start.y+ec-eb*edge.start.x+ea*edge.start.y;pea=eb;peb=-ea;pec=ea*edge.end.x+eb*edge.end.y+ec-eb*edge.end.x+ea*edge.end.y;ys=(psa*c-psc*a)/(a*psb-psa*b);xs=(-b*ys-c)/a;start_cross=new Vec2(xs,ys);ye=(pea*c-pec*a)/(a*peb-pea*b);xe=(-b*ye-c)/a;end_cross=new Vec2(xe,ye);ts=Vec2.normalize(start_cross);tt=Vec2.normalize(edge.start);ts.normalize();tt.normalize();if(right){if(tt.dot(ts)>0){return[end_cross,edge.end]}else{return[start_cross,edge.start]}}if(tt.dot(ts)<=0){return[start_cross,edge.start]}return[end_cross,edge.end]};return MedialGraph}();medialAxis2D=function(polygon,top,left,bottom,right){var chain,chains,cross,current_chain,e0,e1,edges,element,idx,n,ne,p,pe,v0,v1,voronoi,wedge,wedge_length,wedges,zaxis,_i,_j,_k,_l,_len,_ref1,_ref2,_ref3;if(polygon.length<3){return[]}edges=[];for(idx=_i=0,_ref1=polygon.length-1;0<=_ref1?_i<=_ref1:_i>=_ref1;idx=0<=_ref1?++_i:--_i){if(idx+1<polygon.length){edges.push([polygon[idx],polygon[idx+1]])}else{edges.push([polygon[idx],polygon[0]])}}chains=[];current_chain=new Array;for(idx=_j=0,_ref2=edges.length-1;0<=_ref2?_j<=_ref2:_j>=_ref2;idx=0<=_ref2?++_j:--_j){e0=edges[idx];e1=edges[idx+1];if(idx+1===edges.length){e1=edges[0]}v0=Vec3.sub(new Vec3(e0[1].x,e0[1].y),new Vec3(e0[0].x,e0[0].y));v1=Vec3.sub(new Vec3(e1[1].x,e1[1].y),new Vec3(e1[0].x,e1[0].y));cross=Vec3.cross(v0,v1);if(cross.z>0){if(current_chain.length===0){current_chain.push(e0)}current_chain.push([e1[0]]);current_chain.push(e1)}else{if(current_chain.length===0){current_chain.push(e0)}chains.push(current_chain);current_chain=new Array}}voronoi=[];wedges=[];zaxis=new Vec3(0,0,1);wedge_length=100;for(_k=0,_len=chains.length;_k<_len;_k++){chain=chains[_k];for(idx=_l=0,_ref3=chain.length-1;0<=_ref3?_l<=_ref3:_l>=_ref3;idx=0<=_ref3?++_l:--_l){element=chain[idx];wedge=[];if(element.length===2){v0=Vec3.sub(new Vec3(element[0].x,element[0].y),new Vec3(element[1].x,element[1].y));cross=Vec3.cross(v0,zaxis);cross.normalize();wedge.push([new Vec2(element[0].x,element[0].y),new Vec2(element[0].x-cross.x,element[0].y-cross.y)]);wedge.push([new Vec2(element[1].x,element[1].y),new Vec2(element[1].x-cross.x,element[1].y-cross.y)])}else{p=idx-1;if(idx===0){p=chain.length-1}n=idx+1;if(idx===chain.length-1){n=0}pe=chain[p];ne=chain[n];v0=Vec3.sub(new Vec3(pe[0].x,pe[0].y),new Vec3(pe[1].x,pe[1].y));cross=Vec3.cross(v0,zaxis);cross.normalize();wedge.push([new Vec2(element[0].x,element[0].y),new Vec2(element[0].x-cross.x,element[0].y-cross.y)]);v1=Vec3.sub(new Vec3(ne[0].x,ne[0].y),new Vec3(ne[1].x,ne[1].y));cross=Vec3.cross(v1,zaxis);cross.normalize();wedge.push([new Vec2(element[0].x,element[0].y),new Vec2(element[0].x-cross.x,element[0].y-cross.y)])}wedges.push(wedge)}}console.log(wedges);return wedges};module.exports={MedialGraph:MedialGraph}}).call(this)},{"./math":3,"./math_functions":21}],25:[function(require,module,exports){(function(){var glEnumToString,glEnums,glFunctionArgToString,glValidEnumContexts,initDebugContext,makeDebugContext,mightBeEnum;glValidEnumContexts={enable:{0:true},disable:{0:true},getParameter:{0:true},drawArrays:{0:true},drawElements:{0:true,2:true},createShader:{0:true},getShaderParameter:{1:true},getProgramParameter:{1:true},getVertexAttrib:{1:true},vertexAttribPointer:{2:true},bindTexture:{0:true},activeTexture:{0:true},getTexParameter:{0:true,1:true},texParameterf:{0:true,1:true},texParameteri:{0:true,1:true,2:true},texImage2D:{0:true,2:true,6:true,7:true},texSubImage2D:{0:true,6:true,7:true},copyTexImage2D:{0:true,2:true},copyTexSubImage2D:{0:true},generateMipmap:{0:true},bindBuffer:{0:true},bufferData:{0:true,2:true},bufferSubData:{0:true},getBufferParameter:{0:true,1:true},pixelStorei:{0:true,1:true},readPixels:{4:true,5:true},bindRenderbuffer:{0:true},bindFramebuffer:{0:true},checkFramebufferStatus:{0:true},framebufferRenderbuffer:{0:true,1:true,2:true},framebufferTexture2D:{0:true,1:true,2:true},getFramebufferAttachmentParameter:{0:true,1:true,2:true},getRenderbufferParameter:{0:true,1:true},renderbufferStorage:{0:true,1:true},clear:{0:true},depthFunc:{0:true},blendFunc:{0:true,1:true},blendFuncSeparate:{0:true,1:true,2:true,3:true},blendEquation:{0:true},blendEquationSeparate:{0:true,1:true},stencilFunc:{0:true},stencilFuncSeparate:{0:true,1:true},stencilMaskSeparate:{0:true},stencilOp:{0:true,1:true,2:true},stencilOpSeparate:{0:true,1:true,2:true,3:true},cullFace:{0:true},frontFace:{0:true}};glEnums=null;initDebugContext=function(ctx){var propertyName,_i,_len,_results;if(glEnums===null){glEnums={};_results=[];for(_i=0,_len=ctx.length;_i<_len;_i++){propertyName=ctx[_i];if(typeof ctx[propertyName]==="number"){_results.push(glEnums[ctx[propertyName]]=propertyName)}else{_results.push(void 0)}}return _results}};mightBeEnum=function(value){return glEnums[value]!==void 0};glEnumToString=function(value){var name,_ref;checkInit();name=glEnums[value];return(_ref=name!==void 0)!=null?_ref:{name:"*UNKNOWN WebGL ENUM (0x"+value.toString(16)+")"}};glFunctionArgToString=function(functionName,argumentIndex,value){var funcInfo;funcInfo=glValidEnumContexts[functionName];if(funcInfo!==void 0){if(funcInfo[argumentIndex]){return glEnumToString(value)}}return value.toString()};makeDebugContext=function(ctx){return initDebugContext(ctx)}}).call(this)},{}],28:[function(require,module,exports){(function(){var ShaderLibrary;ShaderLibrary=function(){function ShaderLibrary(){}ShaderLibrary.Basic={vertex:{head:"attribute vec3 aVertexPosition;\nuniform mat4 uModelMatrix;\nvarying vec4 vPosition;"},fragment:{head:"uniform mat4 uModelMatrix\n;varying vec4 vPosition;"}};ShaderLibrary.VertexColour={vertex:{head:"attribute vec4 aVertexColour;\nvarying vec4 vColour;",main:"vColour = aVertexColour;"},fragment:{head:"varying vec4 vColour;"}};ShaderLibrary.VertexTexCoord={vertex:{head:"attribute vec2 aVertexTexCoord;\nvarying vec2 vTexCoord;",main:"vTexCoord = aVertexTexCoord;"},fragment:{head:"varying vec2 vTexCoord;"}};ShaderLibrary.BasicCamera={vertex:{head:"uniform mat4 uCameraMatrix;\nuniform mat4 uProjectionMatrix;"}};ShaderLibrary.BasicCamera.fragment={};ShaderLibrary.BasicCamera.fragment.head=ShaderLibrary.BasicCamera.vertex.head;ShaderLibrary.CameraExtra={vertex:{head:"uniform float uCameraNear;\n"+"uniform float uCameraFar;\n "+"uniform mat4 uCameraInverseMatrix;\n "+"uniform mat4 uInverseProjectionMatrix;\n"+"varying vec4 vEyePosition;\n",main:"vEyePosition = uCameraInverseMatrix * vec4(aVertexPosition,1.0);\n"}};ShaderLibrary.CameraExtra.fragment={};ShaderLibrary.CameraExtra.fragment.head=ShaderLibrary.CameraExtra.vertex.head;ShaderLibrary.VertexNormal={vertex:{head:"attribute vec3 aVertexNormal;\nvarying vec3 vNormal;\nuniform mat3 uNormalMatrix;\nvarying vec4 vTransformedNormal;",main:"vNormal = aVertexNormal;\nvTransformedNormal = vec4(uNormalMatrix * aVertexNormal,1.0);"},fragment:{head:"uniform mat3 uNormalMatrix;\nvarying vec3 vNormal;varying vec4 vTransformedNormal;"}};ShaderLibrary.BasicMaterial={fragment:{head:"uniform vec3 uMaterialAmbientColor;\nuniform vec3 uMaterialDiffuseColor;\nuniform vec3 uMaterialSpecularColor;\nuniform float uMaterialShininess;\nuniform vec3 uMaterialEmissiveColor;"}};ShaderLibrary.VertexTangent={vertex:{head:"attribute vec3 aVertexTangent;\nvarying vec3 vTangent;",main:"vTangent = aVertexTangent;"},fragment:{head:"varying vec3 vTangent;"}};ShaderLibrary.Noise={vertex:{head:"vec3 mod289(vec3 x) {\n"+"  return x - floor(x * (1.0 / 289.0)) * 289.0;\n"+"}\n\n"+"vec4 mod289(vec4 x) {\n"+"  return x - floor(x * (1.0 / 289.0)) * 289.0;\n"+"}\n\n"+"vec4 permute(vec4 x) {\n"+"     return mod289(((x*34.0)+1.0)*x);\n"+"}\n\n"+"vec4 taylorInvSqrt(vec4 r) {\n"+"  return 1.79284291400159 - 0.85373472095314 * r;\n"+"}\n\n"+"float snoise(vec3 v) {\n"+"const vec2  C = vec2(1.0/6.0, 1.0/3.0) ;\n"+"const vec4  D = vec4(0.0, 0.5, 1.0, 2.0);\n"+"// First corner\n"+"vec3 i  = floor(v + dot(v, C.yyy) );\n"+"vec3 x0 =   v - i + dot(i, C.xxx) ;\n"+"// Other corners\n"+"vec3 g = step(x0.yzx, x0.xyz);\n"+"vec3 l = 1.0 - g;\n"+"vec3 i1 = min( g.xyz, l.zxy );\n"+"vec3 i2 = max( g.xyz, l.zxy );\n"+"//   x0 = x0 - 0.0 + 0.0 * C.xxx;\n "+"//   x1 = x0 - i1  + 1.0 * C.xxx;\n "+"//   x2 = x0 - i2  + 2.0 * C.xxx;\n "+"//   x3 = x0 - 1.0 + 3.0 * C.xxx;\n "+"vec3 x1 = x0 - i1 + C.xxx;\n"+"vec3 x2 = x0 - i2 + C.yyy; // 2.0*C.x = 1/3 = C.y\n"+"vec3 x3 = x0 - D.yyy;      // -1.0+3.0*C.x = -0.5 = -D.y\n\n"+"// Permutations\n"+"i = mod289(i);\n"+"vec4 p = permute( permute( permute( \n"+"           i.z + vec4(0.0, i1.z, i2.z, 1.0 ))\n"+"         + i.y + vec4(0.0, i1.y, i2.y, 1.0 ))\n"+"         + i.x + vec4(0.0, i1.x, i2.x, 1.0 ));\n\n"+"// Gradients: 7x7 points over a square, mapped onto an octahedron.\n"+"// The ring size 17*17 = 289 is close to a multiple of 49 (49*6 = 294)\n"+"float n_ = 0.142857142857; // 1.0/7.0\n"+"vec3  ns = n_ * D.wyz - D.xzx;\n\n"+"vec4 j = p - 49.0 * floor(p * ns.z * ns.z);  //  mod(p,7*7)\n\n"+"vec4 x_ = floor(j * ns.z);\n"+"vec4 y_ = floor(j - 7.0 * x_ );    // mod(j,N)\n\n"+"vec4 x = x_ *ns.x + ns.yyyy;\n"+"vec4 y = y_ *ns.x + ns.yyyy;\n "+"vec4 h = 1.0 - abs(x) - abs(y);\n\n"+"vec4 b0 = vec4( x.xy, y.xy );\n"+"vec4 b1 = vec4( x.zw, y.zw );\n\n"+"//vec4 s0 = vec4(lessThan(b0,0.0))*2.0 - 1.0;\n"+"//vec4 s1 = vec4(lessThan(b1,0.0))*2.0 - 1.0;\n"+"vec4 s0 = floor(b0)*2.0 + 1.0;\n"+"vec4 s1 = floor(b1)*2.0 + 1.0;\n"+"vec4 sh = -step(h, vec4(0.0));\n\n"+"vec4 a0 = b0.xzyw + s0.xzyw*sh.xxyy ;\n"+"vec4 a1 = b1.xzyw + s1.xzyw*sh.zzww ;\n\n"+"vec3 p0 = vec3(a0.xy,h.x);\n"+"vec3 p1 = vec3(a0.zw,h.y);\n"+"vec3 p2 = vec3(a1.xy,h.z);\n"+"vec3 p3 = vec3(a1.zw,h.w);\n\n"+"//Normalise gradients\n"+"vec4 norm = taylorInvSqrt(vec4(dot(p0,p0), dot(p1,p1), dot(p2, p2), dot(p3,p3)));\n"+"p0 *= norm.x;\n"+"p1 *= norm.y;\n"+"p2 *= norm.z;\n"+"p3 *= norm.w;\n\n"+"// Mix final noise value\n"+"vec4 m = max(0.6 - vec4(dot(x0,x0), dot(x1,x1), dot(x2,x2), dot(x3,x3)), 0.0);\n"+"m = m * m;\n"+"return 42.0 * dot( m*m, vec4( dot(p0,x0), dot(p1,x1),\n"+"dot(p2,x2), dot(p3,x3) ) );\n"+"}\n"}};ShaderLibrary.Noise.fragment={};ShaderLibrary.Noise.fragment.head=ShaderLibrary.Noise.vertex.head;ShaderLibrary.Intensity={fragment:{head:"float intensity(in vec4 color) {\n"+"  return sqrt((color.x*color.x)+(color.y*color.y)+(color.z*color.z));\n"+"}"}};ShaderLibrary.PositionFromDepth={fragment:{head:"// Returns the 3D position in eye space.\n"+"vec3 positionFromDepth(float depth, vec2 texcoord) {\n"+"  vec4 position = vec4(texcoord, depth, 1.0);\n"+"  position.xyz = position.xyz*2.0 -1.0;\n"+"  position = uInverseProjectionMatrix*position;\n"+"  position.xyz /= position.w;\n"+"  return position.xyz;\n}\n"}};ShaderLibrary.DepthPack={fragment:{head:"vec4 pack (float depth) {\n"+"  const vec4 bitSh = vec4(256 * 256 * 256,\n"+"  256 * 256,\n"+"  256,\n"+"  1.0);\n"+"  const vec4 bitMsk = vec4(0,\n"+"   1.0 / 256.0,\n"+"   1.0 / 256.0,\n"+"   1.0 / 256.0);\n"+"   vec4 comp = fract(depth * bitSh);\n"+"   comp -= comp.xxyz * bitMsk;\n"+"   return comp;\n"+"  }"}};ShaderLibrary.DepthPackedRead={fragment:{head:"uniform sampler2D uSamplerDepth;\n"+"float unpack (in vec4 colour) {\n"+" const vec4 bitShifts = vec4(1.0 / (256.0 * 256.0 * 256.0),\n"+"    1.0 / (256.0 * 256.0),\n"+"    1.0 / 256.0,\n"+"    1.0);\n"+"return dot(colour, bitShifts);\n}\n\n"+"// Passed in by the coffeegl depth shader. Reproduces from non linear gl_FragCoord.z to linear 0-1\n"+"float readDepth(in vec2 coord)  {\n"+"  vec4 colour = texture2D(uSamplerDepth, coord);\n"+"  float unpacked = unpack(colour);\n"+"  return (2.0 * uCameraNear) / (uCameraFar + uCameraNear - unpacked * (uCameraFar-uCameraNear));\n"+"}\n"}};ShaderLibrary.Luminance={fragment:{head:"float getLuminance(in vec3 colour) {\n"+"  vec3 lumcoeff = vec3(0.299,0.587,0.114);\n"+"  return dot(colour, lumcoeff);\n}\n"}};ShaderLibrary.ComputeTangentFrame={fragment:{head:"mat3 computeTangentFrame(vec3 N, vec3 p, vec2 uv) {\n"+" // get edge vectors of the pixel triangle\n"+" vec3 dp1 = dFdx( p );\n"+" vec3 dp2 = dFdy( p );\n"+" vec2 duv1 = dFdx( uv );\n"+" vec2 duv2 = dFdy( uv );\n"+" // solve the linear system\n"+" vec3 dp2perp = cross( dp2, N );\n"+" vec3 dp1perp = cross( N, dp1 );\n"+" vec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n"+" vec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n"+" // construct a scale-invariant frame \n"+" float invmax = inversesqrt( max( dot(T,T), dot(B,B) ) );\n"+" return mat3( T * invmax, B * invmax, N );\n"+"}\n"}};ShaderLibrary.ComputeTangentFrame.vertex={};ShaderLibrary.ComputeTangentFrame.vertex.head=ShaderLibrary.ComputeTangentFrame.fragment.head;ShaderLibrary.Sobel={fragment:{head:"vec3 sobel(float step, vec2 center, float limit) {\n"+"  // get samples around pixel\n"+"  float tleft = intensity(texture2D(uSampler,center + vec2(-step,step)));\n"+"  float left = intensity(texture2D(uSampler,center + vec2(-step,0)));\n"+"  float bleft = intensity(texture2D(uSampler,center + vec2(-step,-step)));\n"+"  float top = intensity(texture2D(uSampler,center + vec2(0,step)));\n"+"  float bottom = intensity(texture2D(uSampler,center + vec2(0,-step)));\n"+"  float tright = intensity(texture2D(uSampler,center + vec2(step,step)));\n"+"  float right = intensity(texture2D(uSampler,center + vec2(step,0)));\n"+"  float bright = intensity(texture2D(uSampler,center + vec2(step,-step)));\n"+"  // Sobel masks (to estimate gradient)\n"+"  //        1 0 -1     -1 -2 -1\n"+"  //    X = 2 0 -2  Y = 0  0  0\n"+"  //        1 0 -1      1  2  1\n"+"  float x = tleft + 2.0*left + bleft - tright - 2.0*right - bright;\n"+"  float y = -tleft - 2.0*top - tright + bleft + 2.0 * bottom + bright;\n"+"  float color = sqrt((x*x) + (y*y));\n"+"  if (color < limit){return vec3(0.0,0.0,0.0);}\n"+"  return vec3(1.0,1.0,1.0);\n}\n"}};return ShaderLibrary}();module.exports={ShaderLibrary:ShaderLibrary}}).call(this)},{}],29:[function(require,module,exports){(function(){var RedBlackTree;RedBlackTree=function(){function RedBlackTree(){this.root=null}RedBlackTree.prototype.insertSuccessor=function(node,successor){var grandpa,parent,uncle;if(node){successor.rbPrevious=node;successor.rbNext=node.rbNext;if(node.rbNext){node.rbNext.rbPrevious=successor}node.rbNext=successor;if(node.rbRight){node=node.rbRight;while(node.rbLeft){node=node.rbLeft}node.rbLeft=successor}else{node.rbRight=successor}parent=node}else if(this.root){node=this.getFirst(this.root);successor.rbPrevious=null;successor.rbNext=node;node.rbPrevious=successor;node.rbLeft=successor;parent=node}else{successor.rbPrevious=successor.rbNext=null;this.root=successor;parent=null}successor.rbLeft=successor.rbRight=null;successor.rbParent=parent;successor.rbRed=true;grandpa;uncle;node=successor;while(parent&&parent.rbRed){grandpa=parent.rbParent;if(parent===grandpa.rbLeft){uncle=grandpa.rbRight;if(uncle&&uncle.rbRed){parent.rbRed=uncle.rbRed=false;grandpa.rbRed=true;node=grandpa}else{if(node===parent.rbRight){this.rotateLeft(parent);node=parent;parent=node.rbParent}parent.rbRed=false;grandpa.rbRed=true;this.rotateRight(grandpa)}}else{uncle=grandpa.rbLeft;if(uncle&&uncle.rbRed){parent.rbRed=uncle.rbRed=false;grandpa.rbRed=true;node=grandpa}else{if(node===parent.rbLeft){this.rotateRight(parent);node=parent;parent=node.rbParent}parent.rbRed=false;grandpa.rbRed=true;this.rotateLeft(grandpa);parent=node.rbParent}}}return this.root.rbRed=false};RedBlackTree.prototype.removeNode=function(node){var isRed,left,next,parent,right,sibling;if(node.rbNext){node.rbNext.rbPrevious=node.rbPrevious}if(node.rbPrevious){node.rbPrevious.rbNext=node.rbNext}node.rbNext=node.rbPrevious=null;parent=node.rbParent;left=node.rbLeft;right=node.rbRight;next;if(!left){next=right}else if(!right){next=left}else{next=this.getFirst(right)}if(parent){if(parent.rbLeft===node){parent.rbLeft=next}else{parent.rbRight=next}}else{this.root=next}isRed;if(left&&right){isRed=next.rbRed;next.rbRed=node.rbRed;next.rbLeft=left;left.rbParent=next;if(next!==right){parent=next.rbParent;next.rbParent=node.rbParent;node=next.rbRight;parent.rbLeft=node;next.rbRight=right;right.rbParent=next}else{next.rbParent=parent;parent=next;node=next.rbRight}}else{isRed=node.rbRed;node=next}if(node){node.rbParent=parent}if(isRed){return}if(node&&node.rbRed){node.rbRed=false;return}sibling;while(true){if(node===this.root){break}if(node===parent.rbLeft){sibling=parent.rbRight;if(sibling.rbRed){sibling.rbRed=false;parent.rbRed=true;this.rotateLeft(parent);sibling=parent.rbRight}if(sibling.rbLeft&&sibling.rbLeft.rbRed||sibling.rbRight&&sibling.rbRight.rbRed){if(!sibling.rbRight||!sibling.rbRight.rbRed){sibling.rbLeft.rbRed=false;sibling.rbRed=true;this.rotateRight(sibling);sibling=parent.rbRight}sibling.rbRed=parent.rbRed;parent.rbRed=sibling.rbRight.rbRed=false;this.rotateLeft(parent);node=this.root;break}}else{sibling=parent.rbLeft;if(sibling.rbRed){sibling.rbRed=false;parent.rbRed=true;this.rotateRight(parent);sibling=parent.rbLeft}if(sibling.rbLeft&&sibling.rbLeft.rbRed||sibling.rbRight&&sibling.rbRight.rbRed){if(!sibling.rbLeft||!sibling.rbLeft.rbRed){sibling.rbRight.rbRed=false;sibling.rbRed=true;this.rotateLeft(sibling);sibling=parent.rbLeft}sibling.rbRed=parent.rbRed;parent.rbRed=sibling.rbLeft.rbRed=false;this.rotateRight(parent);node=this.root;break}}sibling.rbRed=true;node=parent;parent=parent.rbParent;if(node.rbRed){break}}if(node){return node.rbRed=false}};RedBlackTree.prototype.rotateLeft=function(node){var p,parent,q;p=node;q=node.rbRight;parent=p.rbParent;if(parent){if(parent.rbLeft===p){parent.rbLeft=q}else{parent.rbRight=q}}else{this.root=q}q.rbParent=parent;p.rbParent=q;p.rbRight=q.rbLeft;if(p.rbRight){p.rbRight.rbParent=p}return q.rbLeft=p};RedBlackTree.prototype.rotateRight=function(node){var p,parent,q;p=node;q=node.rbLeft;parent=p.rbParent;if(parent){if(parent.rbLeft===p){parent.rbLeft=q}else{parent.rbRight=q}}else{this.root=q}q.rbParent=parent;p.rbParent=q;p.rbLeft=q.rbRight;if(p.rbLeft){p.rbLeft.rbParent=p}return q.rbRight=p};RedBlackTree.prototype.getFirst=function(node){while(node.rbLeft){node=node.rbLeft}return node};RedBlackTree.prototype.getLast=function(node){while(node.rbRight){node=node.rbRight}return node};return RedBlackTree}();module.exports={RedBlackTree:RedBlackTree}}).call(this)},{}],26:[function(require,module,exports){(function(){var Matrix4,PointLight,RGB,RGBA,Vec2,Vec3,Vec4,_ref,_ref1;_ref=require("./math"),Matrix4=_ref.Matrix4,Vec2=_ref.Vec2,Vec3=_ref.Vec3,Vec4=_ref.Vec4;_ref1=require("./colour"),RGB=_ref1.RGB,RGBA=_ref1.RGBA;PointLight=function(){function PointLight(pos,colour,specular,attenuation){this.pos=pos;this.colour=colour;this.specular=specular;this.attenuation=attenuation;if(this.pos==null){this.pos=new Vec3(1,1,1)}if(this.colour==null){this.colour=RGB.WHITE()}if(this.specular==null){this.specular=RGB.WHITE()}if(this.attenuation==null){this.attenuation=[100,1,.045,.0075]}this.shadow_casting=false}PointLight.prototype._addToNode=function(node){node.pointLights.push(this);node.numPointLights=node.pointLights.length;return this};PointLight.prototype._removeFromNode=function(node){node.pointLights.splice(node.pointLights.indexOf(this));node.numPointLights=node.pointLights.length;return this};return PointLight}();module.exports={PointLight:PointLight}}).call(this)},{"./math":3,"./colour":4}],27:[function(require,module,exports){(function(){var LoadItem,LoadQueue,Signal;Signal=require("./signal").Signal;LoadItem=function(){function LoadItem(func){this.func=func}LoadItem.prototype.loaded=function(){CoffeeGL.Context.switchContext(this._context);return this.loader.itemCompleted(this)};return LoadItem}();LoadQueue=function(){function LoadQueue(obj,onLoaded,onFinish){this.obj=obj;this.onLoaded=onLoaded;this.onFinish=onFinish;this.items=[];this.completed_items=[];this.complete=new CoffeeGL.Signal;this._context=CoffeeGL.Context;if(this.onFinish!=null){this.complete.add(onFinish,this)}this}LoadQueue.prototype.itemCompleted=function(item){this.completed_items.push(item);if(this.onLoaded!=null){this.onLoaded()}if(this.completed_items.length===this.items.length){this.complete.dispatch()}return this};LoadQueue.prototype.add=function(item){item.obj=this.obj;item.loader=this;item._context=this._context;this.items.push(item);return this};LoadQueue.prototype.start=function(){var item,_i,_len,_ref;_ref=this.items;for(_i=0,_len=_ref.length;_i<_len;_i++){item=_ref[_i];item.func()}return this};return LoadQueue}();module.exports={LoadItem:LoadItem,LoadQueue:LoadQueue}}).call(this)},{"./signal":16}]},{},[1]);